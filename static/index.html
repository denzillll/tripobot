<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Trip Planner</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  /* â”€â”€ Reset & Base â”€â”€ */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  
  :root {
    --bg:       #080b11;
    --surface:  #10151e;
    --card:     #161d2b;
    --card2:    #1c2538;
    --border:   #222d42;
    --border2:  #2a3650;
    --gold:     #c8912a;
    --gold2:    #e8b84b;
    --gold-dim: #c8912a33;
    --text:     #eef2f8;
    --text2:    #8898b8;
    --text3:    #4d5f80;
    --danger:   #e05555;
    --success:  #4ade80;
    --tab-h:    64px;
    --safe-b:   env(safe-area-inset-bottom, 0px);
  }

  html, body {
    height: 100%;
    overflow: hidden;
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    -webkit-font-smoothing: antialiased;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
  }

  /* â”€â”€ Layout â”€â”€ */
  #app {
    display: flex;
    flex-direction: column;
    height: 100vh;
    height: 100dvh;
  }

  /* Mountain header background */
  #header {
    position: relative;
    padding: 20px 20px 16px;
    background: linear-gradient(180deg, #0d1520 0%, var(--bg) 100%);
    flex-shrink: 0;
    overflow: hidden;
  }
  #header::before {
    content: '';
    position: absolute;
    inset: 0;
    background: 
      radial-gradient(ellipse 80% 60% at 50% -10%, #c8912a18 0%, transparent 70%);
    pointer-events: none;
  }
  /* SVG mountain silhouette */
  .mountain-bg {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 40px;
    opacity: 0.12;
  }

  .trip-name {
    font-family: 'Syne', sans-serif;
    font-size: 22px;
    font-weight: 800;
    letter-spacing: -0.5px;
    color: var(--text);
    position: relative;
  }
  .trip-dates {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: var(--gold2);
    margin-top: 3px;
    letter-spacing: 0.5px;
    position: relative;
  }
  .trip-countdown {
    display: inline-block;
    margin-top: 7px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.5px;
    padding: 3px 10px;
    border-radius: 20px;
    position: relative;
  }
  .trip-countdown.pre-trip  { background: var(--gold-dim); border: 1px solid #c8912a44; color: var(--gold2); }
  .trip-countdown.on-trip   { background: #4ade8018; border: 1px solid #4ade8044; color: var(--success); }
  .trip-countdown.post-trip { display: none; }

  /* â”€â”€ Tabs â”€â”€ */
  #tabs {
    display: flex;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  .tab {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 3px;
    padding: 10px 4px;
    cursor: pointer;
    transition: color 0.15s;
    color: var(--text3);
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 0.3px;
    text-transform: uppercase;
    border-bottom: 2px solid transparent;
  }
  .tab.active {
    color: var(--gold2);
    border-bottom-color: var(--gold);
  }
  .tab-icon { font-size: 18px; line-height: 1; }

  /* â”€â”€ Content area â”€â”€ */
  #content {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
    padding: 16px 16px calc(var(--safe-b) + 16px);
  }
  #content::-webkit-scrollbar { display: none; }

  /* â”€â”€ Cards â”€â”€ */
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    margin-bottom: 10px;
    overflow: hidden;
  }
  .card-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 16px;
    cursor: pointer;
  }
  .card-header:active { opacity: 0.7; }
  .card-emoji {
    font-size: 22px;
    width: 36px;
    text-align: center;
    flex-shrink: 0;
  }
  .card-title-group { flex: 1; min-width: 0; }
  .card-title {
    font-family: 'Syne', sans-serif;
    font-size: 15px;
    font-weight: 700;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .card-sub {
    font-size: 12px;
    color: var(--text2);
    margin-top: 1px;
  }
  .card-chevron {
    color: var(--text3);
    font-size: 18px;
    transition: transform 0.2s;
    flex-shrink: 0;
  }
  .card.open .card-chevron { transform: rotate(90deg); }
  .card-body {
    display: none;
    border-top: 1px solid var(--border);
  }
  .card.open .card-body { display: block; }

  /* â”€â”€ Stops â”€â”€ */
  .stop {
    display: flex;
    gap: 12px;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    position: relative;
  }
  .stop:last-child { border-bottom: none; }
  .stop::before {
    content: '';
    position: absolute;
    left: 36px;
    top: 0; bottom: 0;
    width: 1px;
    background: var(--border);
  }
  .stop:first-child::before { top: 50%; }
  .stop:last-child::before { bottom: 50%; }
  .stop-time {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: var(--gold);
    min-width: 44px;
    padding-top: 1px;
    text-align: right;
    flex-shrink: 0;
  }
  .stop-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--border2);
    border: 2px solid var(--gold);
    margin-top: 4px;
    flex-shrink: 0;
  }
  .stop-content { flex: 1; min-width: 0; }
  .stop-name {
    font-size: 14px;
    font-weight: 500;
    color: var(--text);
    line-height: 1.3;
  }
  .stop-note {
    font-size: 12px;
    color: var(--text2);
    margin-top: 2px;
    line-height: 1.4;
  }

  /* â”€â”€ Accom cards â”€â”€ */
  .accom-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 14px 16px;
    margin-bottom: 10px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .accom-name {
    font-family: 'Syne', sans-serif;
    font-size: 15px;
    font-weight: 700;
  }
  .accom-meta {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .badge {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    background: var(--gold-dim);
    color: var(--gold2);
    padding: 2px 8px;
    border-radius: 20px;
    border: 1px solid var(--gold)33;
    letter-spacing: 0.3px;
  }
  .accom-notes {
    font-size: 12px;
    color: var(--text2);
  }
  .accom-link {
    display: flex;
    align-items: center;
    gap: 6px;
    background: var(--card2);
    border: 1px solid var(--border2);
    border-radius: 8px;
    padding: 8px 12px;
    text-decoration: none;
    color: var(--gold2);
    font-size: 13px;
    font-weight: 500;
    margin-top: 2px;
  }
  .accom-link:active { opacity: 0.7; }

  /* â”€â”€ Bookings subtab bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .booking-subtab-bar {
    display: flex;
    background: var(--card2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 3px;
    margin-bottom: 14px;
    gap: 3px;
  }
  .booking-subtab {
    flex: 1;
    padding: 8px 0;
    border-radius: 9px;
    border: none;
    background: transparent;
    color: var(--text2);
    font-size: 13px;
    font-weight: 600;
    font-family: 'DM Sans', sans-serif;
    cursor: pointer;
    transition: background 0.15s, color 0.15s;
  }
  .booking-subtab.active {
    background: var(--card);
    color: var(--text);
    box-shadow: 0 1px 4px rgba(0,0,0,0.18);
  }

  /* â”€â”€ Flight card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .flight-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 14px 16px;
    margin-bottom: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .flight-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
  }
  .flight-number {
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
    font-weight: 700;
  }
  .flight-route {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 0;
    border-top: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
  }
  .flight-endpoint { flex: 1; min-width: 0; overflow: hidden; }
  .flight-endpoint:last-child { text-align: right; }
  .flight-iata {
    font-family: 'JetBrains Mono', monospace;
    font-size: 20px;
    font-weight: 800;
    line-height: 1;
  }
  .flight-city {
    font-size: 11px;
    color: var(--text3);
    margin-top: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
  }
  .flight-time {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: var(--gold2);
    margin-top: 5px;
  }
  .flight-arrow {
    font-size: 18px;
    color: var(--text3);
    flex-shrink: 0;
  }

  /* â”€â”€ Link rows â”€â”€ */
  .link-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 14px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    margin-bottom: 8px;
    text-decoration: none;
    color: var(--text);
    cursor: pointer;
  }
  .link-row:active { opacity: 0.7; }
  .link-row-icon { font-size: 18px; flex-shrink: 0; }
  .link-row-content { flex: 1; min-width: 0; }
  .link-row-name {
    font-size: 14px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .link-row-sub { font-size: 11px; color: var(--text2); margin-top: 1px; }
  .link-arrow { color: var(--text3); font-size: 16px; }

  /* â”€â”€ Section headings â”€â”€ */
  .section-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
    margin-top: 4px;
  }
  .section-title {
    font-family: 'Syne', sans-serif;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text3);
  }

  /* â”€â”€ Add button â”€â”€ */
  .btn-add {
    display: flex;
    align-items: center;
    gap: 6px;
    background: var(--gold-dim);
    border: 1px solid var(--gold)55;
    color: var(--gold2);
    border-radius: 8px;
    padding: 5px 12px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
  }
  .btn-add:active { opacity: 0.7; }

  /* â”€â”€ Empty state â”€â”€ */
  .empty {
    text-align: center;
    padding: 40px 20px;
    color: var(--text3);
  }
  .empty-icon { font-size: 36px; margin-bottom: 12px; }
  .empty-text { font-size: 14px; line-height: 1.5; }

  /* â”€â”€ Checklist â”€â”€ */
  .checklist-group { margin-bottom: 20px; }
  .checklist-group-title {
    font-family: 'Syne', sans-serif;
    font-size: 13px;
    font-weight: 700;
    color: var(--gold2);
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 6px;
  }
  .checklist-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: opacity 0.15s;
  }
  .checklist-item:last-child { border-bottom: none; }
  .checklist-item.done { opacity: 0.45; }
  .check-box {
    width: 20px; height: 20px;
    border-radius: 6px;
    border: 2px solid var(--border2);
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    transition: all 0.15s;
  }
  .checklist-item.done .check-box {
    background: var(--gold);
    border-color: var(--gold);
  }
  .check-tick { color: #000; font-size: 12px; font-weight: 800; display: none; }
  .checklist-item.done .check-tick { display: block; }
  .check-label { font-size: 14px; }

  /* â”€â”€ Emergency â”€â”€ */
  .emergency-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px 16px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .emergency-name { font-size: 14px; font-weight: 500; }
  .emergency-number {
    font-family: 'JetBrains Mono', monospace;
    font-size: 16px;
    font-weight: 500;
    color: var(--gold2);
    text-decoration: none;
  }
  .emergency-card.primary { border-color: var(--danger)66; background: #e0555511; }
  .emergency-card.primary .emergency-number { color: var(--danger); font-size: 20px; }

  /* â”€â”€ Modal / Sheet â”€â”€ */
  #sheet-overlay {
    position: fixed; inset: 0;
    background: #00000088;
    z-index: 100;
    display: none;
    align-items: flex-end;
  }
  #sheet-overlay.open { display: flex; }
  #sheet {
    background: var(--surface);
    border-radius: 20px 20px 0 0;
    padding: 0 0 calc(var(--safe-b) + 20px);
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
  }
  #sheet-overlay.open #sheet { transform: translateY(0); }
  .sheet-handle {
    width: 36px; height: 4px;
    background: var(--border2);
    border-radius: 2px;
    margin: 12px auto 0;
  }
  .sheet-title {
    font-family: 'Syne', sans-serif;
    font-size: 18px;
    font-weight: 800;
    padding: 16px 20px 4px;
  }
  .sheet-sub {
    font-size: 13px;
    color: var(--text2);
    padding: 0 20px 16px;
  }
  .sheet-body { padding: 0 20px; }

  /* â”€â”€ Form elements â”€â”€ */
  .field { margin-bottom: 16px; }
  .field label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--text2);
    letter-spacing: 0.5px;
    text-transform: uppercase;
    margin-bottom: 6px;
  }
  .field input, .field textarea, .field select {
    width: 100%;
    background: var(--card);
    border: 1px solid var(--border2);
    border-radius: 10px;
    padding: 12px 14px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    outline: none;
    -webkit-appearance: none;
    appearance: none;
  }
  .field input:focus, .field textarea:focus {
    border-color: var(--gold);
    box-shadow: 0 0 0 3px var(--gold-dim);
  }
  .field textarea { resize: none; height: 80px; }
  .field select { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%238898b8' stroke-width='1.5' fill='none'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 14px center; padding-right: 36px; }
  ::placeholder { color: var(--text3); }
  input[type=color]    { height: 44px; padding: 4px 8px; cursor: pointer; }
  input[type=checkbox] { width: 16px; height: 16px; accent-color: var(--gold); cursor: pointer; flex-shrink: 0; }
  input[type=date], input[type=time] { color-scheme: dark; }
  .custom-check { display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none; }
  .custom-check.checked .check-box { background: var(--gold); border-color: var(--gold); }
  .custom-check.checked .check-tick { display: block; }

  .btn-primary {
    width: 100%;
    background: var(--gold);
    color: #000;
    border: none;
    border-radius: 12px;
    padding: 14px;
    font-family: 'Syne', sans-serif;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    margin-top: 8px;
    margin-bottom: 8px;
  }
  .btn-primary:active { opacity: 0.8; }
  .btn-secondary {
    width: 100%;
    background: transparent;
    color: var(--text2);
    border: 1px solid var(--border2);
    border-radius: 12px;
    padding: 12px;
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    cursor: pointer;
    margin-bottom: 8px;
  }
  .btn-danger {
    background: #e0555522;
    color: var(--danger);
    border-color: var(--danger)44;
  }

  /* â”€â”€ Day selector â”€â”€ */
  .day-selector {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 16px;
  }
  .day-opt {
    background: var(--card);
    border: 1px solid var(--border2);
    border-radius: 10px;
    padding: 10px 12px;
    cursor: pointer;
    text-align: center;
    transition: all 0.15s;
  }
  .day-opt.selected {
    background: var(--gold-dim);
    border-color: var(--gold);
    color: var(--gold2);
  }
  .day-opt-emoji { font-size: 18px; }
  .day-opt-label { font-size: 12px; font-weight: 600; margin-top: 4px; }

  /* â”€â”€ Delete swipe reveal â”€â”€ */
  .deletable {
    position: relative;
    overflow: hidden;
  }
  .delete-btn {
    position: absolute;
    right: 0; top: 0; bottom: 0;
    background: var(--danger);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 16px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transform: translateX(100%);
    transition: transform 0.2s;
    border-radius: 0 12px 12px 0;
  }
  .deletable.reveal .delete-btn { transform: translateX(0); }

  /* â”€â”€ Weather section â”€â”€ */
  .weather-note {
    font-size: 12px;
    color: var(--text3);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  /* â”€â”€ Edit section â”€â”€ */
  .edit-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 16px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    margin-bottom: 8px;
    cursor: pointer;
  }
  .edit-row:active { opacity: 0.7; }
  .edit-row-label { font-size: 14px; font-weight: 500; }
  .edit-row-value { font-size: 13px; color: var(--text2); max-width: 55%; text-align: right; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

  /* â”€â”€ Spinner â”€â”€ */
  .spinner {
    width: 24px; height: 24px;
    border: 2px solid var(--border2);
    border-top-color: var(--gold);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
    margin: 40px auto;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* â”€â”€ Live weather cards â”€â”€ */
  .wx-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    overflow: hidden;
    margin-bottom: 10px;
  }
  .wx-header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    padding: 12px 14px 8px;
    border-bottom: 1px solid var(--border);
  }
  .wx-loc-name { font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700; }
  .wx-loc-tag  { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--gold2); }
  .wx-day-row  {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
  }
  .wx-day-row:last-child { border-bottom: none; }
  .wx-day-label { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text3); min-width: 44px; flex-shrink: 0; }
  .wx-icon  { font-size: 20px; flex-shrink: 0; }
  .wx-mid   { flex: 1; min-width: 0; }
  .wx-cond  { font-size: 13px; font-weight: 500; }
  .wx-meta  { font-size: 11px; color: var(--text2); margin-top: 2px; }
  .wx-temps { text-align: right; flex-shrink: 0; }
  .wx-hi    { font-family: 'JetBrains Mono', monospace; font-size: 15px; color: var(--text); }
  .wx-lo    { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text3); }

  /* â”€â”€ Animations â”€â”€ */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .tab-content { animation: fadeIn 0.2s ease; }

  /* â”€â”€ Add-stop row inside day card â”€â”€ */
  .add-stop-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 11px 16px;
    color: var(--text3);
    font-size: 13px;
    cursor: pointer;
    border-top: 1px solid var(--border);
    transition: color 0.15s;
  }
  .add-stop-row:active { color: var(--gold2); }

  /* â”€â”€ Refs / Info tab â”€â”€ */
  .type-btn {
    flex: 1;
    padding: 10px 8px;
    border-radius: 10px;
    border: 1px solid var(--border2);
    background: var(--card);
    color: var(--text2);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    text-align: center;
    transition: all 0.15s;
    font-family: 'DM Sans', sans-serif;
  }
  .type-btn.selected {
    background: var(--gold-dim);
    border-color: var(--gold);
    color: var(--gold2);
  }
  input[type=file] {
    width: 100%;
    background: var(--card);
    border: 1px solid var(--border2);
    border-radius: 10px;
    padding: 10px 14px;
    color: var(--text2);
    font-size: 14px;
    cursor: pointer;
  }
  .note-content {
    font-size: 13px;
    color: var(--text2);
    white-space: pre-wrap;
    line-height: 1.6;
    padding: 10px 12px;
    background: var(--card2);
    border-radius: 8px;
  }
  .ref-item {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    margin-bottom: 8px;
    overflow: hidden;
  }
  .ref-item-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 14px;
  }
  .ref-item-icon { font-size: 18px; flex-shrink: 0; }
  .ref-item-name { flex: 1; font-size: 14px; font-weight: 500; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

  /* â”€â”€ Emoji picker â”€â”€ */
  .emoji-display {
    width: 100%;
    background: var(--card);
    border: 1px solid var(--border2);
    border-radius: 10px;
    padding: 10px 4px;
    font-size: 28px;
    text-align: center;
    cursor: pointer;
    line-height: 1;
    display: block;
  }
  .emoji-display:active { opacity: 0.7; }
  .emoji-hint { font-size: 11px; color: var(--text3); text-align: center; margin-top: 4px; }
  .emoji-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 2px;
    background: var(--card2);
    border: 1px solid var(--border2);
    border-radius: 10px;
    padding: 8px;
    margin-top: 6px;
  }
  .emoji-opt {
    font-size: 22px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 5px;
    border-radius: 6px;
    line-height: 1;
  }
  .emoji-opt:active { background: var(--border2); }

  /* â”€â”€ Expense / Split tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .balance-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 14px 16px;
    margin-bottom: 10px;
  }
  .balance-card.you-owe  { border-color: #e0555540; background: #e0555508; }
  .balance-card.you-lent { border-color: #4ade8040; background: #4ade8008; }
  .balance-title {
    font-family: 'Syne', sans-serif;
    font-size: 11px;
    font-weight: 700;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 10px;
  }
  .debt-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
    gap: 10px;
  }
  .debt-row:last-child { border-bottom: none; padding-bottom: 0; }
  .debt-names { font-size: 14px; font-weight: 500; flex: 1; min-width: 0; }
  .debt-names .debt-arrow { color: var(--text3); font-size: 12px; }
  .debt-amount { font-family: 'JetBrains Mono', monospace; font-size: 14px; font-weight: 500; flex-shrink: 0; }
  .debt-amount.owe  { color: var(--danger); }
  .debt-amount.lent { color: var(--success); }
  .settle-btn {
    font-size: 11px;
    padding: 4px 10px;
    border-radius: 20px;
    border: 1px solid var(--gold);
    background: var(--gold-dim);
    color: var(--gold2);
    cursor: pointer;
    flex-shrink: 0;
    font-weight: 600;
  }
  .expense-row {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px 14px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    margin-bottom: 8px;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
  }
  .expense-row:active { opacity: 0.7; }
  .expense-row-icon { font-size: 20px; flex-shrink: 0; padding-top: 2px; }
  .expense-row-body { flex: 1; min-width: 0; }
  .expense-row-title { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .expense-row-meta  { font-size: 12px; color: var(--text2); margin-top: 2px; }
  .expense-row-right { text-align: right; flex-shrink: 0; }
  .expense-row-amount { font-family: 'JetBrains Mono', monospace; font-size: 14px; font-weight: 500; }
  .expense-row-payer  { font-size: 11px; color: var(--text3); margin-top: 2px; }
  .currency-badge {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    background: var(--card2);
    color: var(--text2);
    padding: 1px 5px;
    border-radius: 4px;
    border: 1px solid var(--border2);
    letter-spacing: 0.5px;
    display: inline-block;
    margin-left: 3px;
  }
  .settle-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    background: #4ade8008;
    border: 1px solid #4ade8030;
    border-radius: 12px;
    margin-bottom: 8px;
  }
  .settle-row-icon   { font-size: 18px; flex-shrink: 0; }
  .settle-row-body   { flex: 1; min-width: 0; }
  .settle-row-desc   { font-size: 13px; color: var(--text); }
  .settle-row-date   { font-size: 11px; color: var(--text3); margin-top: 2px; }
  .settle-row-amount { font-family: 'JetBrains Mono', monospace; font-size: 13px; color: var(--success); flex-shrink: 0; }
  .split-type-bar { display: flex; gap: 5px; margin-top: 4px; }
  .split-type-btn {
    flex: 1;
    padding: 8px 4px;
    border-radius: 8px;
    border: 1px solid var(--border2);
    background: var(--card);
    color: var(--text2);
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    text-align: center;
    transition: all 0.15s;
    font-family: 'DM Sans', sans-serif;
  }
  .split-type-btn.selected { background: var(--gold-dim); border-color: var(--gold); color: var(--gold2); }
  .expense-date-group {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--text3);
    letter-spacing: 0.5px;
    text-transform: uppercase;
    padding: 6px 0;
    margin-bottom: 6px;
  }
  .total-chip {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    background: var(--card2);
    border: 1px solid var(--border2);
    color: var(--text2);
    padding: 3px 10px;
    border-radius: 20px;
  }
  .member-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
  }
  .member-row:last-child { border-bottom: none; }
  .member-avatar {
    width: 34px; height: 34px;
    border-radius: 50%;
    background: var(--gold-dim);
    border: 1px solid var(--gold);
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; font-weight: 700; color: var(--gold2);
    flex-shrink: 0;
  }
  .split-participants { display: flex; flex-direction: column; gap: 0; }
  .split-participant-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
  }
  .split-participant-row:last-child { border-bottom: none; }
  .rate-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }

  /* â”€â”€ Split tab redesign â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .split-summary-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 16px;
  }
  .split-summary-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 14px 16px;
  }
  .split-summary-label {
    font-family: 'Syne', sans-serif;
    font-size: 10px;
    font-weight: 700;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 6px;
  }
  .split-summary-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 17px;
    font-weight: 700;
    color: var(--text);
    line-height: 1.1;
  }
  .split-summary-sub {
    font-size: 11px;
    color: var(--text3);
    margin-top: 4px;
  }
  .split-search-wrap {
    position: relative;
    margin: 8px 0 10px;
  }
  .split-search-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 13px;
    pointer-events: none;
    line-height: 1;
  }
  .split-search-input {
    width: 100%;
    box-sizing: border-box;
    padding: 9px 14px 9px 36px;
    border-radius: 10px;
    border: 1px solid var(--border2);
    background: var(--card);
    color: var(--text);
    font-size: 13px;
    font-family: 'DM Sans', sans-serif;
    outline: none;
  }
  .split-search-input:focus { border-color: var(--gold); }
  .toggle-label {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 12px;
    color: var(--text2);
    cursor: pointer;
    user-select: none;
  }
  .debt-avatar {
    display: inline-flex;
    width: 22px; height: 22px;
    border-radius: 50%;
    background: var(--card2);
    border: 1px solid var(--border2);
    color: var(--text2);
    font-size: 10px;
    font-weight: 700;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    vertical-align: middle;
  }
  .debt-avatar--to {
    background: var(--gold-dim);
    border-color: var(--gold);
    color: var(--gold2);
  }

  /* â”€â”€ Info board (refs tab) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .bulletin-section { margin-bottom: 20px; }
  .bulletin-section:last-child { margin-bottom: 4px; }
  .bulletin-section-label {
    font-family: 'Syne', sans-serif;
    font-size: 11px;
    font-weight: 700;
    color: var(--text2);
    letter-spacing: 0.5px;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 6px;
    padding-bottom: 8px;
    cursor: default;
  }
  .bulletin-section-label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }
  .bulletin-cat-handle {
    font-size: 14px;
    color: var(--text3);
    touch-action: none;
    cursor: grab;
    padding: 2px 4px;
    letter-spacing: 2px;
    flex-shrink: 0;
    user-select: none;
  }
  .bulletin-section.drag-src-section > .bulletin-section-label { opacity: 0.3; }
  .bulletin-section.drag-over-section > .bulletin-section-label { color: var(--gold2); }
  .bulletin-section.drag-over-section > .bulletin-section-label::after { background: var(--gold); }
  /* Item drag handle inside ref-item header */
  .ref-drag-handle {
    font-size: 14px;
    color: var(--text3);
    touch-action: none;
    cursor: grab;
    letter-spacing: 2px;
    padding: 0 6px 0 0;
    flex-shrink: 0;
    user-select: none;
  }
  .ref-item.drag-src  { opacity: 0.25; }
  .ref-item.drag-over { border-color: var(--gold); box-shadow: 0 0 0 2px var(--gold-dim); }
  .bulletin-add-card {
    border: 1.5px dashed var(--border2);
    border-radius: 10px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text3);
    font-size: 22px;
    cursor: pointer;
    transition: background 0.15s;
    margin-top: 6px;
  }
  .bulletin-add-card:active { background: var(--card2); }

  /* â”€â”€ Wishlist scratchpad (Itinerary bottom) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .wishlist-board {
    background: #080e1c;
    background-image: radial-gradient(circle, #18253d 1px, transparent 1px);
    background-size: 20px 20px;
    border-radius: 16px;
    padding: 14px 12px 14px;
    margin: 0 -4px;
  }
  .wishlist-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }
  .wishlist-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 10px 6px;
    position: relative;
    transition: opacity 0.15s, box-shadow 0.15s;
  }
  .wishlist-card:nth-child(3n+1) { transform: rotate(-0.6deg); }
  .wishlist-card:nth-child(3n+2) { transform: rotate(0.5deg); }
  .wishlist-card.drag-src        { opacity: 0.25; transform: rotate(0deg) !important; }
  .wishlist-card-icon  { font-size: 20px; margin-bottom: 4px; }
  .wishlist-card-name  { font-size: 12px; font-weight: 600; color: var(--text); line-height: 1.3; }
  .wishlist-card-note  { font-size: 10px; color: var(--text2); margin-top: 3px; line-height: 1.4; }
  .wishlist-drag-handle {
    display: block;
    text-align: center;
    color: var(--text3);
    font-size: 13px;
    margin-top: 6px;
    touch-action: none;
    cursor: grab;
    letter-spacing: 2px;
  }
  .wishlist-add-card {
    border: 1.5px dashed var(--border2);
    border-radius: 10px;
    min-height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text3);
    font-size: 26px;
    cursor: pointer;
  }
  .wishlist-add-card:active { background: var(--card2); }
  .wishlist-hint {
    font-size: 11px;
    color: var(--text3);
    text-align: center;
    padding: 8px 0 0;
  }
  /* Day card drop zone */
  .card.drop-zone-active {
    border-color: var(--gold) !important;
    box-shadow: 0 0 0 2px var(--gold-dim) !important;
  }

</style>
</head>
<body>
<div id="app">
  <!-- Header -->
  <div id="header">
    <svg class="mountain-bg" viewBox="0 0 400 40" preserveAspectRatio="none" fill="white">
      <path d="M0 40 L40 15 L80 28 L130 5 L175 22 L220 8 L265 20 L310 2 L355 18 L400 10 L400 40 Z"/>
    </svg>
    <div class="trip-name" id="trip-name">Loading...</div>
    <div class="trip-dates" id="trip-dates"></div>
    <div class="trip-countdown" id="trip-countdown"></div>
  </div>

  <!-- Tab bar -->
  <div id="tabs">
    <div class="tab active" data-tab="itinerary" onclick="switchTab('itinerary')">
      <span class="tab-icon">ğŸ—“</span>Plan
    </div>
    <div class="tab" data-tab="accoms" onclick="switchTab('accoms')">
      <span class="tab-icon">ğŸ¨</span>Bookings
    </div>
    <div class="tab" data-tab="weather" onclick="switchTab('weather')">
      <span class="tab-icon">ğŸŒ¤</span>Weather
    </div>
    <div class="tab" data-tab="refs" onclick="switchTab('refs')">
      <span class="tab-icon">ğŸ“‹</span>Info
    </div>
    <div class="tab" data-tab="split" onclick="switchTab('split')">
      <span class="tab-icon">ğŸ’¸</span>Split
    </div>
    <div class="tab" data-tab="more" onclick="switchTab('more')">
      <span class="tab-icon">â‹¯</span>More
    </div>
  </div>

  <!-- Content -->
  <div id="content">
    <div class="spinner" id="loading-spinner"></div>
  </div>
</div>

<!-- Bottom Sheet -->
<div id="sheet-overlay" onclick="closeSheet(event)">
  <div id="sheet">
    <div class="sheet-handle"></div>
    <div id="sheet-inner"></div>
  </div>
</div>

<script>
const tg = window.Telegram?.WebApp;
if (tg) { tg.expand(); tg.ready(); }

const userId = tg?.initDataUnsafe?.user?.id || null;

// Priority:
//   1. start_param  â€” deep link t.me/Bot/app?startapp=CHAT_ID  (most reliable, /start command)
//   2. chat.id      â€” menu button opened from a group
//   3. ?cid= param  â€” fallback for plain URL buttons
//   4. user.id      â€” DM fallback
//   5. 'default'    â€” local dev
const _startParam = tg?.initDataUnsafe?.start_param || null;
const _urlCid     = new URLSearchParams(window.location.search).get('cid');
const chatId = String(
  _startParam ||
  tg?.initDataUnsafe?.chat?.id ||
  _urlCid ||
  tg?.initDataUnsafe?.user?.id ||
  'default'
);

const EMOJIS_DAY = ['ğŸš—','âœˆï¸','ğŸš‚','ğŸš¢','ğŸ¨','ğŸ•ï¸','ğŸ¥¾','ğŸ”','â›·ï¸','ğŸ¿','ğŸŒŠ','ğŸ–ï¸','ğŸ½ï¸','ğŸ‰','ğŸ—ºï¸','ğŸ“','ğŸŒ…','ğŸŒ„','ğŸŒ¿','ğŸ™ï¸','ğŸ¯','ğŸ’¼','ğŸ­','ğŸ›ï¸','ğŸ›•','â›©ï¸','ğŸª','ğŸŒŸ','ğŸ›¤ï¸','ğŸï¸'];
const EMOJIS_CAT = ['ğŸ“‹','âœ…','ğŸ’','ğŸ¥¾','ğŸ‘•','ğŸ§´','ğŸ’Š','ğŸ“±','ğŸ”‘','ğŸ’³','ğŸ“','ğŸ“Œ','ğŸ”—','ğŸ“','âš ï¸','ğŸ†˜','ğŸ¿','ğŸ§—','ğŸšµ','ğŸŠ','ğŸ¯','ğŸ”§','ğŸš—','âœˆï¸','ğŸ›ï¸','ğŸ½ï¸','ğŸ’°','ğŸŒ','ğŸ‘¤','â„ï¸','ğŸ’§','ğŸ”¥','âš¡','ğŸŒ¤','ğŸš‘','ğŸ¥','ğŸ”','ğŸµ','ğŸ“·','ğŸ§³'];

function toggleEmojiPicker(fieldId, emojis) {
  const existing = document.getElementById('epick-' + fieldId);
  if (existing) { existing.remove(); return; }
  const grid = document.createElement('div');
  grid.id = 'epick-' + fieldId;
  grid.className = 'emoji-grid';
  emojis.forEach(e => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.textContent = e;
    btn.className = 'emoji-opt';
    btn.onclick = () => {
      document.getElementById(fieldId).textContent = e;
      document.getElementById(fieldId + '-val').value = e;
      grid.remove();
    };
    grid.appendChild(btn);
  });
  const anchor = document.getElementById(fieldId);
  anchor.parentNode.insertBefore(grid, anchor.nextSibling);
}

let appData = null;
let isAdmin = false;
let activeTab = 'itinerary';
function getPersonalItems()    { return JSON.parse(localStorage.getItem('personal_items_'+(userId||'anon')) || '[]'); }
function setPersonalItems(d)   { localStorage.setItem('personal_items_'+(userId||'anon'), JSON.stringify(d)); }
function getPersonalProgress() { return JSON.parse(localStorage.getItem('personal_prog_'+(userId||'anon')) || '{}'); }
function setPersonalProgress(d){ localStorage.setItem('personal_prog_'+(userId||'anon'), JSON.stringify(d)); }

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  try {
    const [dataRes, adminRes] = await Promise.all([
      fetch(`/api/data?chat_id=${encodeURIComponent(chatId)}`).then(r => r.json()),
      userId ? fetch(`/api/is_admin?user_id=${userId}&chat_id=${encodeURIComponent(chatId)}`).then(r => r.json()) : Promise.resolve({is_admin: false})
    ]);
    appData = dataRes;
    // Migrate old flat checklist â†’ groupChecklist array
    if (appData.checklist && !appData.groupChecklist) {
      const _m = [{id:'hiking',label:'Hiking Gear',icon:'ğŸ¥¾'},{id:'snowboard',label:'Snowboard Gear',icon:'â›·ï¸'},{id:'admin',label:'Trip Admin',icon:'ğŸš—'}];
      appData.groupChecklist = _m.map(c => ({...c, items: appData.checklist[c.id] || []}));
      delete appData.checklist;
      appData.groupProgress = {};
      saveData();
    }
    if (!appData.groupChecklist) appData.groupChecklist = [];
    if (!appData.groupProgress)  appData.groupProgress  = {};
    if (!appData.members)        appData.members        = [];
    if (!appData.expenses)       appData.expenses       = [];
    if (!appData.settlements)    appData.settlements    = [];
    if (!appData.tripCurrency)   appData.tripCurrency   = { base: 'SGD', rates: { MAD: 0.29, EUR: 1.45, USD: 1.35 } };
    if (!appData.flights)        appData.flights        = [];
    if (!appData.wishlist)       appData.wishlist       = [];
    // Migrate old links â†’ refs
    if (!appData.refs) appData.refs = [];
    if (!appData.refCats) appData.refCats = [];
    if (appData.links) {
      (appData.links || []).forEach(l => {
        appData.refs.push({ id: 'r' + Date.now() + Math.random().toString(36).slice(2,6), type: 'link', cat: 'uncategorized', name: l.name, url: l.url });
      });
      delete appData.links;
      saveData();
    }
    // Migrate old emergency â†’ note
    if (appData.emergency) {
      if (appData.emergency.length) {
        const emContent = appData.emergency.map(e => `${e.name}: ${e.number}`).join('\n');
        appData.refs.push({ id: 'em' + Date.now(), type: 'note', cat: 'uncategorized', name: 'Emergency Numbers', content: emContent });
      }
      delete appData.emergency;
      saveData();
    }
    isAdmin = adminRes.is_admin;
    document.getElementById('trip-name').textContent = appData.trip.name;
    document.getElementById('trip-dates').textContent = appData.trip.dates;
    renderCountdown();
    document.getElementById('loading-spinner').remove();
    renderTab('itinerary');
  } catch(e) {
    document.getElementById('content').innerHTML = `<div class="empty"><div class="empty-icon">âš ï¸</div><div class="empty-text">Could not load trip data.<br>Pull to refresh.</div></div>`;
  }
}

async function saveData() {
  await fetch(`/api/data?chat_id=${encodeURIComponent(chatId)}`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(appData)
  });
}

// â”€â”€ Tab navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCountdown() {
  const el = document.getElementById('trip-countdown');
  if (!el) return;
  const dates = (appData.days || []).filter(d => d.date).map(d => d.date).sort();
  if (!dates.length) { el.className = 'trip-countdown post-trip'; return; }
  const first = dates[0];
  const last  = dates[dates.length - 1];
  const today = new Date().toISOString().slice(0, 10);
  if (today < first) {
    const diff = Math.round((new Date(first) - new Date(today)) / 86400000);
    el.className = 'trip-countdown pre-trip';
    el.textContent = `âœˆ ${diff} day${diff !== 1 ? 's' : ''} to go`;
  } else if (today <= last) {
    const dayNum = dates.filter(d => d <= today).length;
    el.className = 'trip-countdown on-trip';
    el.textContent = `Day ${dayNum} of ${dates.length}`;
  } else {
    el.className = 'trip-countdown post-trip';
  }
}

function switchTab(tab) {
  activeTab = tab;
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  renderTab(tab);
}

function renderTab(tab) {
  const el = document.getElementById('content');
  el.innerHTML = '';
  const div = document.createElement('div');
  div.className = 'tab-content';
  switch(tab) {
    case 'itinerary': div.innerHTML = renderItinerary(); break;
    case 'accoms':    div.innerHTML = renderBookings(); break;
    case 'weather':   div.innerHTML = renderWeather(); break;
    case 'refs':      div.innerHTML = renderRefs(); break;
    case 'more':      div.innerHTML = renderMore(); break;
    case 'split':     div.innerHTML = renderExpenses(); break;
  }
  el.appendChild(div);
  if (tab === 'refs')      setTimeout(initBulletinDrag, 0);
  if (tab === 'itinerary') setTimeout(initWishlistDrag, 0);
}

// â”€â”€ Itinerary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderItinerary() {
  let html = `<div class="section-head">
    <span class="section-title">Itinerary</span>
    ${isAdmin ? `<button class="btn-add" onclick="addDay()">ï¼‹ Day</button>` : ''}
  </div>`;

  if (!appData.days.length) {
    html += `<div class="empty"><div class="empty-icon">ğŸ—“</div><div class="empty-text">No days yet.<br>${isAdmin ? 'Tap <strong>+ Day</strong> to get started.' : ''}</div></div>`;
  } else {
    const days = [...appData.days].sort((a, b) => (a.date || '').localeCompare(b.date || ''));
    days.forEach((day, di) => {
      di = appData.days.indexOf(day);
      const stopCount = day.stops.length;
      html += `
      <div class="card" id="day-${day.id}">
        <div class="card-header" onclick="toggleCard('day-${day.id}')">
          <div class="card-emoji">${day.emoji}</div>
          <div class="card-title-group">
            <div class="card-title">${day.label}</div>
            <div class="card-sub">${day.title}${stopCount ? ` Â· ${stopCount} stop${stopCount!==1?'s':''}` : ''}</div>
          </div>
          ${isAdmin ? `<div onclick="event.stopPropagation();editDay(${di})" style="color:var(--text3);font-size:15px;cursor:pointer;padding:4px 8px;flex-shrink:0">âœï¸</div>` : ''}
          <div class="card-chevron">â€º</div>
        </div>
        <div class="card-body">`;
      if (day.description) {
        html += `<div style="padding:10px 16px 6px;font-size:13px;color:var(--text2);line-height:1.5;border-bottom:1px solid var(--border)">${day.description}</div>`;
      }
      day.stops.forEach((stop, si) => {
        html += `
          <div class="stop" ${isAdmin ? `onclick="editStop(${di},${si})" style="cursor:pointer"` : ''}>
            <div class="stop-time">${stop.time || 'â€”'}</div>
            <div class="stop-dot"></div>
            <div class="stop-content">
              <div class="stop-name">${stop.name}</div>
              ${stop.note ? `<div class="stop-note">${stop.note}</div>` : ''}
            </div>
            ${stop.mapsUrl ? `<a href="${stop.mapsUrl}" target="_blank" onclick="event.stopPropagation()" style="color:var(--gold2);font-size:16px;text-decoration:none;padding:2px 6px;flex-shrink:0">ğŸ“</a>` : ''}
          </div>`;
      });
      if (isAdmin) {
        html += `<div class="add-stop-row" onclick="addStop(${di})"><span style="font-size:16px">ï¼‹</span> Add stop</div>`;
      }
      html += `</div></div>`;
    });
  }

  // â”€â”€ Places Wishlist scratchpad â”€â”€
  const wishlist = appData.wishlist || [];
  html += `
    <div class="section-head" style="margin-top:20px">
      <span class="section-title">âœ¨ Places Wishlist</span>
      <button class="btn-add" onclick="addWishlistItem()">ï¼‹ Add</button>
    </div>
    <div class="wishlist-board">
      <div class="wishlist-grid" id="wishlist-grid">`;
  if (!wishlist.length) {
    html += `<div style="grid-column:1/-1;text-align:center;padding:24px 12px;color:var(--text3);font-size:12px;line-height:1.7">Add places you want to visit.<br>Hold the <strong style="color:var(--text2)">â ¿</strong> handle on a card and drag it onto a day to add it to the itinerary.</div>`;
  } else {
    wishlist.forEach((item, wi) => {
      html += `<div class="wishlist-card" data-wi="${wi}">
        ${isAdmin ? `<div style="position:absolute;top:4px;right:4px;font-size:12px;color:var(--text3);cursor:pointer" onclick="editWishlistItem(${wi})">âœï¸</div>` : ''}
        <div class="wishlist-card-icon">${item.emoji || 'ğŸ“'}</div>
        <div class="wishlist-card-name">${item.name}</div>
        ${item.note ? `<div class="wishlist-card-note">${item.note}</div>` : ''}
        ${isAdmin ? `<div class="wishlist-drag-handle" data-wi="${wi}">â ¿</div>` : ''}
      </div>`;
    });
    html += `<div class="wishlist-add-card" onclick="addWishlistItem()">ï¼‹</div>`;
  }
  html += `</div>`;
  if (wishlist.length && appData.days.length) {
    html += `<div class="wishlist-hint">Hold â ¿ on a card Â· drag it onto a day above</div>`;
  }
  html += `</div>`;

  return html;
}

function toggleCard(id) {
  document.getElementById(id)?.classList.toggle('open');
}

// â”€â”€ Day CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _editDayIdx = -1;

function addDay() { _editDayIdx = -1; openSheet('day-form'); }
function editDay(di) { _editDayIdx = di; openSheet('day-form'); }

function deleteDay(di) {
  if (!confirm(`Remove day "${appData.days[di].label}" and all its stops?`)) return;
  appData.days.splice(di, 1);
  saveData().then(() => { _closeSheet(); renderTab('itinerary'); });
}

function submitDay() {
  const title = document.getElementById('f-daytitle')?.value.trim();
  const emoji = document.getElementById('f-dayemoji-val')?.value.trim() || 'ğŸ“';
  const date  = document.getElementById('f-daydate')?.value;
  const description = document.getElementById('f-daydesc')?.value.trim() || '';
  if (!title || !date) { alert('Title and date are required'); return; }
  const dt = new Date(date + 'T12:00:00');
  const label = dt.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
  if (_editDayIdx >= 0) {
    appData.days[_editDayIdx] = { ...appData.days[_editDayIdx], label, title, emoji, date, description };
  } else {
    appData.days.push({ id: `day-${Date.now()}`, label, title, emoji, date, description, stops: [] });
  }
  appData.days.sort((a, b) => (a.date || '').localeCompare(b.date || ''));
  saveData().then(() => { _closeSheet(); renderTab('itinerary'); });
}

// â”€â”€ Info board: drag-to-reorder (touch + mouse) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initBulletinDrag() {
  if (!isAdmin) return;
  const board = document.querySelector('.bulletin-board');
  if (!board) return;

  let ghost = null, srcEl = null, srcType = null;
  let startX = 0, startY = 0, startRect = null, moved = false;

  function coord(e) {
    if (e.touches)        return { x: e.touches[0].clientX,        y: e.touches[0].clientY };
    if (e.changedTouches) return { x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY };
    return { x: e.clientX, y: e.clientY };
  }
  function clearHL() {
    board.querySelectorAll('.ref-item.drag-over,.bulletin-section.drag-over-section')
      .forEach(el => el.classList.remove('drag-over','drag-over-section'));
  }
  function getTarget(x, y) {
    for (const el of document.elementsFromPoint(x, y)) {
      if (srcType === 'item') {
        const c = el.closest('.ref-item[data-ref-id]');
        if (c && c !== srcEl && c.dataset.catId === srcEl.dataset.catId) return c;
      } else {
        const s = el.closest('.bulletin-section[data-cat-id]');
        if (s && s !== srcEl) return s;
      }
    }
    return null;
  }
  function drop(tgt) {
    if (srcType === 'item') {
      const refs = appData.refs;
      const si = refs.findIndex(r => r.id === srcEl.dataset.refId);
      const ti = refs.findIndex(r => r.id === tgt.dataset.refId);
      if (si >= 0 && ti >= 0 && si !== ti) {
        refs.splice(ti, 0, refs.splice(si, 1)[0]);
        saveData().then(() => renderTab('refs'));
      }
    } else {
      const cats = appData.refCats;
      const si = cats.findIndex(c => c.id === srcEl.dataset.catId);
      const ti = cats.findIndex(c => c.id === tgt.dataset.catId);
      if (si >= 0 && ti >= 0 && si !== ti) {
        cats.splice(ti, 0, cats.splice(si, 1)[0]);
        saveData().then(() => renderTab('refs'));
      }
    }
  }

  function dragStart(e, handle) {
    srcType   = handle.classList.contains('ref-drag-handle') ? 'item' : 'cat';
    srcEl     = handle.closest(srcType === 'item' ? '.ref-item' : '.bulletin-section');
    if (!srcEl) { srcEl = null; return; }
    const {x, y} = coord(e);
    startX = x; startY = y;
    startRect = srcEl.getBoundingClientRect();
    moved = false;
  }
  function dragMove(e) {
    if (!srcEl) return;
    const {x, y} = coord(e);
    const dx = x - startX, dy = y - startY;
    if (!moved && (Math.abs(dx) > 5 || Math.abs(dy) > 5)) {
      moved = true;
      ghost = srcEl.cloneNode(true);
      Object.assign(ghost.style, {
        position:'fixed', pointerEvents:'none', zIndex:'9999',
        width: srcEl.offsetWidth+'px', left: startRect.left+'px', top: startRect.top+'px',
        opacity:'0.85', transition:'none',
        boxShadow:'0 8px 28px rgba(0,0,0,0.5)',
        border:'1px solid var(--gold)', borderRadius:'10px'
      });
      document.body.appendChild(ghost);
      srcEl.classList.add('drag-src');
    }
    if (moved) {
      if (e.cancelable) e.preventDefault();
      ghost.style.left = (startRect.left + dx)+'px';
      ghost.style.top  = (startRect.top  + dy)+'px';
      clearHL();
      const tgt = getTarget(x, y);
      if (tgt) tgt.classList.add(srcType === 'item' ? 'drag-over' : 'drag-over-section');
    }
  }
  function dragEnd(e) {
    if (!srcEl) return;
    if (moved) {
      ghost?.remove(); ghost = null;
      srcEl.classList.remove('drag-src');
      clearHL();
      const {x, y} = coord(e);
      const tgt = getTarget(x, y);
      if (tgt && tgt !== srcEl) drop(tgt);
    }
    srcEl = null; srcType = null; moved = false;
  }

  // â”€â”€ Touch â”€â”€
  board.addEventListener('touchstart', e => {
    if (e.touches.length !== 1) return;
    const t = e.touches[0];
    const h = document.elementFromPoint(t.clientX, t.clientY)
      ?.closest('.ref-drag-handle, .bulletin-cat-handle');
    if (h) dragStart(e, h);
  }, { passive: true });
  document.addEventListener('touchmove', e => {
    if (srcEl) dragMove(e);
  }, { passive: false });
  document.addEventListener('touchend',    e => dragEnd(e));
  document.addEventListener('touchcancel', e => dragEnd(e));

  // â”€â”€ Mouse (desktop) â”€â”€
  board.addEventListener('mousedown', e => {
    const h = e.target.closest('.ref-drag-handle, .bulletin-cat-handle');
    if (!h) return;
    e.preventDefault();
    dragStart(e, h);
    function onMove(ev) { dragMove(ev); }
    function onUp(ev)   {
      dragEnd(ev);
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup',   onUp);
    }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup',   onUp);
  });
}

// â”€â”€ Wishlist drag-to-day â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _wishlistPrefill = null;

function initWishlistDrag() {
  const scrollEl = document.getElementById('content'); // scrollable tab container
  let ghost = null, srcEl = null, srcWi = -1;
  let startX = 0, startY = 0, startRect = null;
  let curX = 0, curY = 0, rafId = null;

  const EDGE = 90;   // px from viewport top/bottom that triggers scroll
  const SPEED = 10;  // max px per frame

  function autoScroll() {
    if (!ghost || !scrollEl) return;
    const vh = window.innerHeight;
    if (curY < EDGE) {
      scrollEl.scrollTop -= SPEED * (1 - curY / EDGE);
    } else if (curY > vh - EDGE) {
      scrollEl.scrollTop += SPEED * (1 - (vh - curY) / EDGE);
    }
    rafId = requestAnimationFrame(autoScroll);
  }

  function stopScroll() {
    if (rafId) { cancelAnimationFrame(rafId); rafId = null; }
  }

  function dayCardAt(x, y) {
    for (const el of document.elementsFromPoint(x, y)) {
      const c = el.closest('.card[id^="day-"]');
      if (c) return c;
    }
    return null;
  }

  document.querySelectorAll('.wishlist-drag-handle[data-wi]').forEach(handle => {
    handle.addEventListener('touchstart', e => {
      if (e.touches.length !== 1) return;
      srcEl  = handle.closest('.wishlist-card');
      srcWi  = parseInt(handle.dataset.wi);
      curX   = startX = e.touches[0].clientX;
      curY   = startY = e.touches[0].clientY;
      startRect = srcEl?.getBoundingClientRect();
    }, { passive: true });

    handle.addEventListener('touchmove', e => {
      if (!srcEl) return;
      curX = e.touches[0].clientX;
      curY = e.touches[0].clientY;
      const dx = curX - startX, dy = curY - startY;
      if (!ghost && (Math.abs(dx) > 8 || Math.abs(dy) > 8)) {
        ghost = srcEl.cloneNode(true);
        Object.assign(ghost.style, {
          position:'fixed', pointerEvents:'none', zIndex:'9999',
          width: srcEl.offsetWidth+'px',
          left: startRect.left+'px', top: startRect.top+'px',
          opacity:'0.92', transform:'rotate(-3deg) scale(1.1)',
          boxShadow:'0 12px 32px rgba(0,0,0,0.55)', transition:'none'
        });
        document.body.appendChild(ghost);
        srcEl.classList.add('drag-src');
        document.querySelectorAll('.card[id^="day-"]').forEach(c => c.classList.add('drop-zone-active'));
        rafId = requestAnimationFrame(autoScroll);
      }
      if (ghost) {
        e.preventDefault();
        ghost.style.left = (startRect.left + dx)+'px';
        ghost.style.top  = (startRect.top  + dy)+'px';
      }
    }, { passive: false });

    handle.addEventListener('touchend', e => {
      stopScroll();
      if (!srcEl) return;
      ghost?.remove(); ghost = null;
      srcEl.classList.remove('drag-src');
      document.querySelectorAll('.card[id^="day-"]').forEach(c => c.classList.remove('drop-zone-active'));
      const t = e.changedTouches[0];
      const dayCard = dayCardAt(t.clientX, t.clientY);
      if (dayCard && srcWi >= 0) {
        const dayId = dayCard.id.replace('day-', '');
        const di = appData.days.findIndex(d => d.id === dayId);
        if (di >= 0) dropWishlistOnDay(srcWi, di);
      }
      srcEl = null; srcWi = -1;
    });

    handle.addEventListener('touchcancel', () => {
      stopScroll();
      ghost?.remove(); ghost = null;
      if (srcEl) srcEl.classList.remove('drag-src');
      document.querySelectorAll('.card[id^="day-"]').forEach(c => c.classList.remove('drop-zone-active'));
      srcEl = null; srcWi = -1;
    });
  });
}

function dropWishlistOnDay(wi, di) {
  const item = (appData.wishlist || [])[wi];
  if (!item) return;
  _wishlistPrefill = item;
  _editStopDayIdx = di;
  _editStopIdx = -1;
  openSheet('stop-form');
}

// â”€â”€ Wishlist CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _editWishIdx = -1;

function addWishlistItem()      { _editWishIdx = -1; openSheet('wishlist-form'); }
function editWishlistItem(i)    { _editWishIdx = i;  openSheet('wishlist-form'); }

function deleteWishlistItem(i) {
  if (!confirm('Remove from wishlist?')) return;
  (appData.wishlist || []).splice(i, 1);
  saveData().then(() => { _closeSheet(); renderTab('itinerary'); });
}

function submitWishlistItem() {
  const name  = document.getElementById('f-name')?.value.trim();
  if (!name) { alert('Name is required'); return; }
  const emoji   = document.getElementById('f-emoji')?.value.trim()   || 'ğŸ“';
  const note    = document.getElementById('f-notes')?.value.trim()   || '';
  let mapsUrl   = document.getElementById('f-stopmaps')?.value.trim()|| '';
  if (mapsUrl && !mapsUrl.match(/^https?:\/\//i)) mapsUrl = 'https://' + mapsUrl;
  const item = { id: 'wish_' + Date.now(), name, emoji, note, mapsUrl };
  if (!appData.wishlist) appData.wishlist = [];
  if (_editWishIdx >= 0) appData.wishlist[_editWishIdx] = item;
  else appData.wishlist.push(item);
  saveData().then(() => { _closeSheet(); renderTab('itinerary'); });
}

// â”€â”€ Stop CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _editStopDayIdx = -1;
let _editStopIdx    = -1;

function addStop(di)      { _editStopDayIdx = di; _editStopIdx = -1; openSheet('stop-form'); }
function editStop(di, si) { _editStopDayIdx = di; _editStopIdx = si; openSheet('stop-form'); }

function deleteStop(di, si) {
  if (!confirm(`Remove "${appData.days[di].stops[si].name}"?`)) return;
  appData.days[di].stops.splice(si, 1);
  saveData().then(() => { _closeSheet(); renderTab('itinerary'); });
}

// â”€â”€ Accommodations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ Bookings tab (Accoms + Flights) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _bookingSubtab = 'accoms';

function switchBookingSubtab(sub) {
  _bookingSubtab = sub;
  renderTab('accoms');
}

function renderBookings() {
  const bar = `
    <div class="booking-subtab-bar">
      <button class="booking-subtab ${_bookingSubtab==='accoms'?'active':''}" onclick="switchBookingSubtab('accoms')">ğŸ¨ Accoms</button>
      <button class="booking-subtab ${_bookingSubtab==='flights'?'active':''}" onclick="switchBookingSubtab('flights')">âœˆï¸ Flights</button>
    </div>`;
  return bar + (_bookingSubtab === 'accoms' ? renderAccoms() : renderFlightsTab());
}

function renderFlightsTab() {
  let html = `<div class="section-head"><span class="section-title">Flights</span>${isAdmin ? `<button class="btn-add" onclick="addFlight()">ï¼‹ Add</button>` : ''}</div>`;
  if (!appData.flights || !appData.flights.length) {
    html += `<div class="empty"><div class="empty-icon">âœˆï¸</div><div class="empty-text">No flights yet.<br>${isAdmin ? 'Tap <strong>+ Add</strong> to add a flight.' : 'Admin will add flights here.'}</div></div>`;
    return html;
  }
  const flights = [...appData.flights].sort((a, b) => (a.depDate || '').localeCompare(b.depDate || ''));
  flights.forEach(f => {
    const i = appData.flights.indexOf(f);
    const depLabel = [formatDate(f.depDate), f.depTime].filter(Boolean).join(' Â· ');
    const arrLabel = [formatDate(f.arrDate || f.depDate), f.arrTime].filter(Boolean).join(' Â· ');
    html += `
    <div class="flight-card">
      <div class="flight-header">
        <div>
          <div class="flight-number">âœˆï¸ ${f.flightNumber || 'â€”'}</div>
          <div style="font-size:12px;color:var(--text2);margin-top:2px">${f.airline || ''}</div>
        </div>
        ${isAdmin ? `<div onclick="editFlight(${i})" style="color:var(--text3);font-size:15px;cursor:pointer;padding:2px 4px">âœï¸</div>` : ''}
      </div>
      <div class="flight-route">
        <div class="flight-endpoint">
          <div class="flight-iata">${f.fromCode || 'â€”'}</div>
          <div class="flight-city">${f.from || ''}</div>
          <div class="flight-time">${depLabel}</div>
        </div>
        <div class="flight-arrow">â†’</div>
        <div class="flight-endpoint">
          <div class="flight-iata">${f.toCode || 'â€”'}</div>
          <div class="flight-city">${f.to || ''}</div>
          <div class="flight-time">${arrLabel}</div>
        </div>
      </div>
      ${f.ref ? `<div><span class="badge">ğŸ“‹ ${f.ref}</span></div>` : ''}
      ${f.url ? `<a class="accom-link" href="${f.url}" target="_blank">ğŸ”— Open booking â†—</a>` : ''}
      ${f.notes ? `<div class="accom-notes">${f.notes}</div>` : ''}
    </div>`;
  });
  return html;
}

let _editAccomIdx = -1;

function addAccom()    { _editAccomIdx = -1; openSheet('add-accom'); }
function editAccom(i)  { _editAccomIdx = i;  openSheet('add-accom'); }

function deleteAccom(i) {
  if (!confirm(`Remove "${appData.accoms[i].name}"?`)) return;
  appData.accoms.splice(i, 1);
  saveData().then(() => { _closeSheet(); renderTab('accoms'); });
}

let _editFlightIdx = -1;
function addFlight()    { _editFlightIdx = -1; openSheet('add-flight'); }
function editFlight(i)  { _editFlightIdx = i;  openSheet('add-flight'); }

function deleteFlight(i) {
  if (!confirm('Remove this flight?')) return;
  appData.flights.splice(i, 1);
  saveData().then(() => { _closeSheet(); _bookingSubtab = 'flights'; renderTab('accoms'); });
}

function submitFlight() {
  const airline      = document.getElementById('f-airline')?.value.trim()   || '';
  const flightNumber = document.getElementById('f-flight-num')?.value.trim()|| '';
  const from         = document.getElementById('f-from')?.value.trim()      || '';
  const fromCode     = document.getElementById('f-from-code')?.value.trim().toUpperCase() || '';
  const to           = document.getElementById('f-to')?.value.trim()        || '';
  const toCode       = document.getElementById('f-to-code')?.value.trim().toUpperCase()   || '';
  if (!from || !to) { alert('From and To are required'); return; }
  const depDate = document.getElementById('f-dep-date')?.value || '';
  const depTime = document.getElementById('f-dep-time')?.value || '';
  const arrDate = document.getElementById('f-arr-date')?.value || '';
  const arrTime = document.getElementById('f-arr-time')?.value || '';
  let url = document.getElementById('f-url')?.value.trim() || '';
  if (url && !url.match(/^https?:\/\//i)) url = 'https://' + url;
  const ref   = document.getElementById('f-ref')?.value.trim()   || '';
  const notes = document.getElementById('f-notes')?.value.trim() || '';
  const flight = { airline, flightNumber, from, fromCode, to, toCode, depDate, depTime, arrDate, arrTime, url, ref, notes };
  if (!appData.flights) appData.flights = [];
  if (_editFlightIdx >= 0) appData.flights[_editFlightIdx] = flight;
  else appData.flights.push(flight);
  saveData().then(() => { _closeSheet(); _bookingSubtab = 'flights'; renderTab('accoms'); });
}

function renderAccoms() {
  let html = `<div class="section-head"><span class="section-title">Accommodation</span>${isAdmin ? `<button class="btn-add" onclick="addAccom()">ï¼‹ Add</button>` : ''}</div>`;
  if (!appData.accoms.length) {
    html += `<div class="empty"><div class="empty-icon">ğŸ¨</div><div class="empty-text">No bookings yet.<br>${isAdmin ? 'Tap <strong>+ Add</strong> to add your first booking.' : 'Admin will add bookings here.'}</div></div>`;
    return html;
  }
  const accoms = [...appData.accoms].sort((a, b) => (a.checkin || '').localeCompare(b.checkin || ''));
  accoms.forEach((a) => {
    const i = appData.accoms.indexOf(a);
    html += `
    <div class="accom-card">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:8px">
        <div class="accom-name">${a.name}</div>
        ${isAdmin ? `<div onclick="editAccom(${i})" style="color:var(--text3);font-size:15px;cursor:pointer;padding:2px 4px;flex-shrink:0">âœï¸</div>` : ''}
      </div>
      <div class="accom-meta">
        ${a.day ? `<span class="badge">ğŸ“… ${a.day}</span>` : ''}
        ${a.notes ? `<span class="badge">ğŸ“ ${a.notes}</span>` : ''}
      </div>
      <a class="accom-link" href="${a.url}" target="_blank">ğŸ”— Open booking â†—</a>
      ${a.mapsUrl ? `<a class="accom-link" href="${a.mapsUrl}" target="_blank">ğŸ“ Open in Maps â†—</a>` : ''}
    </div>`;
  });
  return html;
}

// â”€â”€ Weather â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function wmoInfo(code) {
  if (code === 0)   return { e: 'â˜€ï¸', label: 'Clear sky' };
  if (code <= 1)    return { e: 'ğŸŒ¤', label: 'Mainly clear' };
  if (code <= 2)    return { e: 'â›…', label: 'Partly cloudy' };
  if (code <= 3)    return { e: 'â˜ï¸', label: 'Overcast' };
  if (code <= 48)   return { e: 'ğŸŒ«', label: 'Fog' };
  if (code <= 55)   return { e: 'ğŸŒ¦', label: 'Drizzle' };
  if (code <= 67)   return { e: 'ğŸŒ§', label: 'Rain' };
  if (code <= 77)   return { e: 'â„ï¸', label: 'Snow' };
  if (code <= 82)   return { e: 'ğŸŒ¦', label: 'Showers' };
  if (code <= 86)   return { e: 'ğŸŒ¨', label: 'Snow showers' };
  return                  { e: 'â›ˆ', label: 'Thunderstorm' };
}

function datesInRange(from, to) {
  const dates = [];
  let d = new Date(from + 'T12:00:00');
  const end = new Date((to || from) + 'T12:00:00');
  while (d <= end) { dates.push(d.toISOString().split('T')[0]); d.setDate(d.getDate() + 1); }
  return dates;
}

async function loadLiveWeather() {
  const el = document.getElementById('live-weather');
  if (!el) return;
  const locations = [...(appData.wxLocations || [])].sort((a, b) => (a.dateFrom || '').localeCompare(b.dateFrom || ''));
  if (!locations.length) {
    el.innerHTML = `<div style="text-align:center;padding:20px;color:var(--text3);font-size:13px">No locations added${isAdmin ? '. Tap <strong style="color:var(--text2)">+ Add</strong> above.' : '.'}</div>`;
    return;
  }
  try {
    const results = await Promise.all(locations.map(loc =>
      fetch(`https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,precipitation_sum,weather_code,wind_speed_10m_max,snowfall_sum&timezone=Europe%2FMadrid&wind_speed_unit=kmh&forecast_days=14`)
        .then(r => r.json())
    ));
    let html = '';
    locations.forEach((loc, li) => {
      const d = results[li].daily;
      const dates = datesInRange(loc.dateFrom, loc.dateTo);
      html += `<div class="wx-card">
        <div class="wx-header">
          <span class="wx-loc-name">${loc.name}</span>
          <div style="display:flex;align-items:center;gap:10px">
            ${loc.tag ? `<span class="wx-loc-tag">${loc.tag}</span>` : ''}
            ${isAdmin ? `<span onclick="editWxLoc(${li})" style="color:var(--text3);font-size:14px;cursor:pointer;padding:2px 4px">âœï¸</span>` : ''}
          </div>
        </div>`;
      dates.forEach(dateStr => {
        const idx = d.time.indexOf(dateStr);
        const day = new Date(dateStr + 'T12:00:00').toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric' });
        if (idx === -1) {
          html += `<div class="wx-day-row"><span class="wx-day-label">${day}</span><span style="color:var(--text3);font-size:12px">Outside forecast range</span></div>`;
          return;
        }
        const { e, label } = wmoInfo(d.weather_code[idx]);
        const hi    = Math.round(d.temperature_2m_max[idx]);
        const lo    = Math.round(d.temperature_2m_min[idx]);
        const precP = d.precipitation_probability_max[idx];
        const precM = d.precipitation_sum[idx];
        const wind  = Math.round(d.wind_speed_10m_max[idx]);
        const snow  = d.snowfall_sum[idx];
        let meta = `ğŸ’§ ${precP}%`;
        if (precM > 0) meta += ` Â· ${precM.toFixed(1)}mm`;
        if (loc.wind) meta += ` Â· ğŸ’¨ ${wind} km/h`;
        if (loc.snow) meta += snow > 0 ? ` Â· â„ï¸ ${snow}cm new` : ` Â· â„ï¸ no new snow`;
        html += `<div class="wx-day-row">
          <span class="wx-day-label">${day}</span>
          <span class="wx-icon">${e}</span>
          <div class="wx-mid"><div class="wx-cond">${label}</div><div class="wx-meta">${meta}</div></div>
          <div class="wx-temps"><div class="wx-hi">${hi}Â°</div><div class="wx-lo">${lo}Â°</div></div>
        </div>`;
      });
      if (loc.forecastUrl) {
        html += `<a href="${loc.forecastUrl}" target="_blank" style="display:flex;align-items:center;gap:8px;padding:9px 14px;border-top:1px solid var(--border);color:var(--text3);font-size:11px;text-decoration:none;font-family:'JetBrains Mono',monospace;letter-spacing:0.3px">
          <span style="flex:1">${loc.forecastName || 'Detailed forecast'}</span><span>â†—</span>
        </a>`;
      }
      html += '</div>';
    });
    el.innerHTML = html;
  } catch(err) {
    el.innerHTML = '<div style="color:var(--text3);font-size:13px;text-align:center;padding:16px">Could not load live weather</div>';
  }
}

function renderWeather() {
  const html = `
    <div class="section-head"><span class="section-title">Live Weather</span>${isAdmin ? `<button class="btn-add" onclick="addWxLoc()">ï¼‹ Add</button>` : ''}</div>
    <div class="weather-note">âš ï¸ Check forecasts the morning of each activity</div>
    <div id="live-weather"><div class="spinner" style="margin:20px auto"></div></div>`;
  setTimeout(loadLiveWeather, 0);
  return html;
}

function deleteWeather(i) {
  if (!confirm(`Remove "${appData.weather[i].name}"?`)) return;
  appData.weather.splice(i, 1);
  saveData().then(() => renderTab('weather'));
}

// â”€â”€ Live weather location CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _wxLocGeo = null;
let _wxLocEditIdx = -1;

function addWxLoc() {
  _wxLocEditIdx = -1;
  _wxLocGeo = null;
  openSheet('wx-loc-form');
}

function editWxLoc(i) {
  _wxLocEditIdx = i;
  _wxLocGeo = null;
  openSheet('wx-loc-form');
}

function deleteWxLoc(i) {
  if (!confirm(`Remove "${appData.wxLocations[i].name}"?`)) return;
  appData.wxLocations.splice(i, 1);
  saveData().then(() => { _closeSheet(); renderTab('weather'); });
}

async function searchWxPlace() {
  const q = document.getElementById('f-wxplace')?.value.trim();
  if (!q) return;
  const res = document.getElementById('wx-geo-result');
  res.textContent = 'Searchingâ€¦';
  res.style.color = 'var(--text3)';
  try {
    const data = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=1&language=en`).then(r => r.json());
    if (!data.results?.length) { res.textContent = 'Place not found'; res.style.color = 'var(--danger)'; _wxLocGeo = null; return; }
    const p = data.results[0];
    _wxLocGeo = { lat: p.latitude, lon: p.longitude };
    res.innerHTML = `âœ“ ${p.name}${p.admin1 ? ', ' + p.admin1 : ''}${p.country_code ? ', ' + p.country_code : ''} <span style="color:var(--text3)">(${p.latitude.toFixed(4)}, ${p.longitude.toFixed(4)})</span>`;
    res.style.color = 'var(--success)';
  } catch(e) {
    res.textContent = 'Search failed'; res.style.color = 'var(--danger)'; _wxLocGeo = null;
  }
}

function updateWxTag() { /* tag auto-generated on submit */ }

async function submitWxLoc() {
  const name = document.getElementById('f-wxname')?.value.trim();
  const from = document.getElementById('f-wxfrom')?.value;
  const to   = document.getElementById('f-wxto')?.value || from;
  const wind = document.getElementById('f-wxwind')?.classList.contains('checked') || false;
  const snow = document.getElementById('f-wxsnow')?.classList.contains('checked') || false;
  const _d1 = from ? new Date(from + 'T12:00:00') : null;
  const _d2 = (to && to !== from) ? new Date(to + 'T12:00:00') : null;
  const _s  = d => d.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric' });
  const tag  = _d1 ? ((_d2 && _d2 > _d1) ? _s(_d1) + 'â€“' + _s(_d2) : _s(_d1)) : '';
  if (!name || !from) { alert('Name and start date are required'); return; }
  let lat, lon;
  if (_wxLocGeo) {
    lat = _wxLocGeo.lat; lon = _wxLocGeo.lon;
  } else if (_wxLocEditIdx >= 0 && appData.wxLocations?.[_wxLocEditIdx]) {
    lat = appData.wxLocations[_wxLocEditIdx].lat;
    lon = appData.wxLocations[_wxLocEditIdx].lon;
  } else {
    alert('Please search for a location first'); return;
  }
  let forecastUrl  = document.getElementById('f-wxforecasturl')?.value.trim() || '';
  if (forecastUrl && !forecastUrl.match(/^https?:\/\//i)) forecastUrl = 'https://' + forecastUrl;
  const forecastName = document.getElementById('f-wxforecastname')?.value.trim() || '';
  const loc = { name, tag, lat, lon, dateFrom: from, dateTo: to, wind, snow, forecastUrl, forecastName };
  if (!appData.wxLocations) appData.wxLocations = [];
  if (_wxLocEditIdx >= 0) appData.wxLocations[_wxLocEditIdx] = loc;
  else appData.wxLocations.push(loc);
  saveData().then(() => { _closeSheet(); renderTab('weather'); });
}

// â”€â”€ Refs (Info tab) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderRefs() {
  const refs = appData.refs || [];
  const cats = appData.refCats || [];

  const header = `<div class="section-head">
    <span class="section-title">Info Board</span>
    ${isAdmin ? `<button class="btn-add" onclick="addRefCat()">ï¼‹ Category</button>` : ''}
  </div>`;

  if (!cats.length && !refs.length) {
    return header + `<div class="empty"><div class="empty-icon">ğŸ“‹</div><div class="empty-text">Nothing here yet.<br>${isAdmin ? 'Tap <strong>ï¼‹ Category</strong> to get started.' : 'Admin will add info here.'}</div></div>`;
  }

  function _refCard(r) {
    const ri     = refs.indexOf(r);
    const catId  = r.cat || 'uncategorized';
    const typeIcon = r.type === 'link' ? 'ğŸ”—' : r.type === 'file' ? 'ğŸ“' : 'ğŸ“';
    let actionBtn = '';
    if (r.type === 'link' && r.url) {
      actionBtn = `<a href="${r.url}" target="_blank" onclick="event.stopPropagation()" style="color:var(--gold2);font-size:18px;text-decoration:none;padding:2px 8px;flex-shrink:0">â†—</a>`;
    } else if (r.type === 'file' && r.fileUrl) {
      actionBtn = `<a href="${r.fileUrl}" target="_blank" onclick="event.stopPropagation()" style="color:var(--gold2);font-size:18px;text-decoration:none;padding:2px 8px;flex-shrink:0">â†“</a>`;
    }
    let bodyHtml = '';
    if (r.type === 'note' && r.content) {
      bodyHtml = `<div style="padding:0 14px 12px"><div class="note-content">${r.content.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/\n/g,'<br>')}</div></div>`;
    } else if (r.type === 'link' && r.url) {
      bodyHtml = `<div style="padding:0 14px 10px;font-size:11px;color:var(--text3);font-family:'JetBrains Mono',monospace;word-break:break-all">${r.url}</div>`;
    } else if (r.type === 'file' && r.fileName) {
      bodyHtml = `<div style="padding:0 14px 10px;font-size:11px;color:var(--text3);font-family:'JetBrains Mono',monospace">${r.fileName}</div>`;
    }
    return `<div class="ref-item" data-ref-id="${r.id}" data-cat-id="${catId}">
      <div class="ref-item-header">
        ${isAdmin ? `<span class="ref-drag-handle" data-ref-id="${r.id}">â ¿</span>` : ''}
        <div class="ref-item-icon">${typeIcon}</div>
        <div class="ref-item-name">${r.name}</div>
        ${isAdmin ? `<div onclick="editRef(${ri})" style="color:var(--text3);font-size:15px;cursor:pointer;padding:2px 6px;flex-shrink:0">âœï¸</div>` : ''}
        ${actionBtn}
      </div>
      ${bodyHtml}
    </div>`;
  }

  let html = '<div class="bulletin-board">';

  cats.forEach((cat, ci) => {
    const catRefs = refs.filter(r => (r.cat || r.catId) === cat.id);
    html += `<div class="bulletin-section" data-cat-id="${cat.id}">
      <div class="bulletin-section-label">
        ${isAdmin ? `<span class="bulletin-cat-handle" data-cat-id="${cat.id}">â ¿</span>` : ''}
        <span>${cat.icon} ${cat.label}</span>
        ${isAdmin ? `<span onclick="editRefCat(${ci})" style="font-size:13px;cursor:pointer;color:var(--text3);font-family:'DM Sans',sans-serif;letter-spacing:0;text-transform:none;font-weight:400">âœï¸</span>` : ''}
      </div>`;
    catRefs.forEach(r => { html += _refCard(r); });
    if (isAdmin) html += `<div class="bulletin-add-card" onclick="addRef('${cat.id}')">ï¼‹</div>`;
    html += `</div>`;
  });

  const uncat = refs.filter(r => !r.cat || r.cat === 'uncategorized');
  if (uncat.length || (!cats.length && isAdmin)) {
    html += `<div class="bulletin-section" data-cat-id="uncategorized">
      <div class="bulletin-section-label"><span>ğŸ“‚ Other</span></div>`;
    uncat.forEach(r => { html += _refCard(r); });
    if (isAdmin) html += `<div class="bulletin-add-card" onclick="addRef('uncategorized')">ï¼‹</div>`;
    html += `</div>`;
  }

  return header + html + '</div>';
}

let _editRefIdx    = -1;
let _editRefCatIdx = -1;
let _refType       = 'link';
let _defaultRefCat = 'uncategorized';

function addRef(catId) { _editRefIdx = -1; _refType = 'link'; _defaultRefCat = catId || 'uncategorized'; openSheet('ref-form'); }
function editRef(i)   { _editRefIdx = i;  _refType = (appData.refs||[])[i]?.type || 'link'; openSheet('ref-form'); }
function deleteRef(i) {
  if (!confirm(`Remove "${(appData.refs||[])[i]?.name}"?`)) return;
  appData.refs.splice(i, 1);
  saveData().then(() => { _closeSheet(); renderTab('refs'); });
}
function setRefType(type) {
  _refType = type;
  document.querySelectorAll('.type-btn').forEach(b => b.classList.toggle('selected', b.dataset.type === type));
  document.getElementById('ref-link-fields').style.display = type === 'link' ? '' : 'none';
  document.getElementById('ref-file-fields').style.display = type === 'file' ? '' : 'none';
  document.getElementById('ref-note-fields').style.display = type === 'note' ? '' : 'none';
}
async function submitRef() {
  const name  = document.getElementById('f-refname')?.value.trim();
  const catId = document.getElementById('f-refcat')?.value || 'uncategorized';
  if (!name) { alert('Name is required'); return; }
  const editing = _editRefIdx >= 0;
  const old = editing ? appData.refs[_editRefIdx] : null;
  let ref = { id: old?.id || ('r' + Date.now()), type: _refType, cat: catId, name };
  if (_refType === 'link') {
    let url = document.getElementById('f-refurl')?.value.trim() || '';
    if (!url) { alert('URL is required'); return; }
    if (!url.match(/^https?:\/\//i)) url = 'https://' + url;
    ref.url = url;
  } else if (_refType === 'file') {
    const file = document.getElementById('f-reffile')?.files?.[0];
    if (!editing && !file) { alert('Please select a file'); return; }
    if (file) {
      const fd = new FormData();
      fd.append('file', file);
      try {
        const res = await fetch(`/api/upload?chat_id=${encodeURIComponent(chatId)}`, { method: 'POST', body: fd }).then(r => r.json());
        ref.fileUrl  = res.url;
        ref.fileName = res.originalName || file.name;
      } catch(e) { alert('File upload failed'); return; }
    } else {
      ref.fileUrl  = old.fileUrl;
      ref.fileName = old.fileName;
    }
  } else if (_refType === 'note') {
    ref.content = document.getElementById('f-refcontent')?.value || '';
  }
  if (!appData.refs) appData.refs = [];
  if (editing) { appData.refs[_editRefIdx] = ref; }
  else { appData.refs.push(ref); }
  saveData().then(() => { _closeSheet(); renderTab('refs'); });
}

function addRefCat()    { _editRefCatIdx = -1; openSheet('ref-cat-form'); }
function editRefCat(ci) { _editRefCatIdx = ci; openSheet('ref-cat-form'); }
function deleteRefCat(ci) {
  const cats = appData.refCats || [];
  if (!confirm(`Delete "${cats[ci]?.label}"? Items in this category will become uncategorized.`)) return;
  const catId = cats[ci].id;
  cats.splice(ci, 1);
  (appData.refs || []).forEach(r => { if (r.cat === catId) r.cat = 'uncategorized'; });
  saveData().then(() => { _closeSheet(); renderTab('refs'); });
}
function submitRefCat() {
  const icon  = document.getElementById('f-cat-icon-val')?.value.trim() || 'ğŸ“Œ';
  const label = document.getElementById('f-cat-label')?.value.trim();
  if (!label) { alert('Category name required'); return; }
  if (!appData.refCats) appData.refCats = [];
  if (_editRefCatIdx >= 0) {
    appData.refCats[_editRefCatIdx] = { ...appData.refCats[_editRefCatIdx], icon, label };
  } else {
    appData.refCats.push({ id: 'rc' + Date.now(), icon, label });
  }
  saveData().then(() => { _closeSheet(); renderTab('refs'); });
}

// â”€â”€ More â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMore() {
  // â”€â”€ Group checklist â”€â”€
  const groupCats = appData.groupChecklist || [];
  const groupProg = appData.groupProgress  || {};
  let groupHtml = '';
  groupCats.forEach((cat, ci) => {
    const doneCount = cat.items.filter((_, ii) => groupProg[`${cat.id}-${ii}`]).length;
    groupHtml += `<div class="checklist-group">
      <div class="checklist-group-title">
        <span>${cat.icon} ${cat.label}</span>
        <div style="display:flex;gap:10px;align-items:center">
          <span style="font-size:12px;color:var(--text3);font-family:'JetBrains Mono',monospace;font-weight:400">${doneCount}/${cat.items.length}</span>
          ${isAdmin ? `<span onclick="addGroupItem(${ci})" style="color:var(--gold2);cursor:pointer;font-size:17px;line-height:1">ï¼‹</span>` : ''}
          ${isAdmin ? `<span onclick="editGroupCat(${ci})" style="color:var(--text3);cursor:pointer;font-size:13px">âœï¸</span>` : ''}
        </div>
      </div>`;
    if (!cat.items.length) {
      groupHtml += `<div style="padding:8px 0;color:var(--text3);font-size:13px">${isAdmin ? 'Tap ï¼‹ to add items' : 'No items yet'}</div>`;
    }
    cat.items.forEach((item, ii) => {
      const key = `${cat.id}-${ii}`;
      const done = !!groupProg[key];
      groupHtml += `
        <div class="checklist-item ${done ? 'done' : ''}" onclick="toggleGroupCheck('${cat.id}',${ii})">
          <div class="check-box"><span class="check-tick">âœ“</span></div>
          <span class="check-label" style="flex:1">${item}</span>
          ${isAdmin ? `<span onclick="event.stopPropagation();deleteGroupItem(${ci},${ii})" style="color:var(--danger);font-size:20px;padding:0 4px;line-height:1;flex-shrink:0">Ã—</span>` : ''}
        </div>`;
    });
    groupHtml += `</div>`;
  });
  if (!groupCats.length) {
    groupHtml = `<div style="padding:12px 0 4px;color:var(--text3);font-size:13px;text-align:center">${isAdmin ? 'No categories yet â€” tap ï¼‹ Category' : 'No group checklist yet'}</div>`;
  }

  // â”€â”€ Personal checklist â”€â”€
  const personalCats = getPersonalItems();
  const personalProg = getPersonalProgress();
  let personalHtml = '';
  personalCats.forEach((cat, ci) => {
    const doneCount = cat.items.filter((_, ii) => personalProg[`${cat.id}-${ii}`]).length;
    personalHtml += `<div class="checklist-group">
      <div class="checklist-group-title">
        <span>${cat.icon} ${cat.label}</span>
        <div style="display:flex;gap:10px;align-items:center">
          <span style="font-size:12px;color:var(--text3);font-family:'JetBrains Mono',monospace;font-weight:400">${doneCount}/${cat.items.length}</span>
          <span onclick="addPersonalItem(${ci})" style="color:var(--gold2);cursor:pointer;font-size:17px;line-height:1">ï¼‹</span>
          <span onclick="editPersonalCat(${ci})" style="color:var(--text3);cursor:pointer;font-size:13px">âœï¸</span>
        </div>
      </div>`;
    if (!cat.items.length) {
      personalHtml += `<div style="padding:8px 0;color:var(--text3);font-size:13px">Tap ï¼‹ to add items</div>`;
    }
    cat.items.forEach((item, ii) => {
      const key = `${cat.id}-${ii}`;
      const done = !!personalProg[key];
      personalHtml += `
        <div class="checklist-item ${done ? 'done' : ''}" onclick="togglePersonalCheck('${cat.id}',${ii})">
          <div class="check-box"><span class="check-tick">âœ“</span></div>
          <span class="check-label" style="flex:1">${item}</span>
          <span onclick="event.stopPropagation();deletePersonalItem(${ci},${ii})" style="color:var(--danger);font-size:20px;padding:0 4px;line-height:1;flex-shrink:0">Ã—</span>
        </div>`;
    });
    personalHtml += `</div>`;
  });
  if (!personalCats.length) {
    personalHtml = `<div style="padding:12px 0 4px;color:var(--text3);font-size:13px;text-align:center">No personal list yet â€” tap ï¼‹ Category</div>`;
  }

  let editSection = isAdmin ? `
    <div class="section-head" style="margin-top:24px"><span class="section-title">Trip Settings</span></div>
    <div class="edit-row" onclick="openSheet('edit-trip')">
      <div class="edit-row-label">âœï¸ Edit trip name & dates</div>
      <div class="edit-row-value">${appData.trip.name}</div>
    </div>
    <div class="edit-row" onclick="openSheet('show-id')">
      <div class="edit-row-label">ğŸ‘¤ My user ID</div>
      <div class="edit-row-value" style="font-family:monospace">${userId || 'Unknown'}</div>
    </div>
    <div class="edit-row" onclick="openManageMembers()">
      <div class="edit-row-label">ğŸ‘¥ Split members</div>
      <div class="edit-row-value">${(appData.members||[]).length} member${(appData.members||[]).length!==1?'s':''}</div>
    </div>
    <div class="edit-row" onclick="openCurrencySettings()">
      <div class="edit-row-label">ğŸ’± Exchange rates</div>
      <div class="edit-row-value">${appData.tripCurrency?.base||'SGD'} base</div>
    </div>
  ` : `
    <div style="padding:16px 0;text-align:center;color:var(--text3);font-size:13px">
      To edit trip info, ask the admin to add you via /addadmin
    </div>
  `;

  return `
    <div class="section-head">
      <span class="section-title">ğŸŒ Group Checklist</span>
      ${isAdmin ? `<button class="btn-add" onclick="addGroupCat()">ï¼‹ Category</button>` : ''}
    </div>
    ${groupHtml}
    <div class="section-head" style="margin-top:8px">
      <span class="section-title">ğŸ‘¤ My Checklist</span>
      <button class="btn-add" onclick="addPersonalCat()">ï¼‹ Category</button>
    </div>
    ${personalHtml}
    ${editSection}
  `;
}

// â”€â”€ Group checklist toggles & CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleGroupCheck(catId, ii) {
  const key = `${catId}-${ii}`;
  if (appData.groupProgress[key]) delete appData.groupProgress[key];
  else appData.groupProgress[key] = true;
  renderTab('more');
  saveData();
}

let _editGroupCatIdx    = -1;
let _addGroupItemCatIdx = -1;

function addGroupCat()     { _editGroupCatIdx = -1; openSheet('group-cat-form'); }
function editGroupCat(ci)  { _editGroupCatIdx = ci; openSheet('group-cat-form'); }
function deleteGroupCat(ci) {
  if (!confirm(`Delete "${appData.groupChecklist[ci]?.label}" and all its items?`)) return;
  appData.groupChecklist.splice(ci, 1);
  saveData().then(() => { _closeSheet(); renderTab('more'); });
}
function submitGroupCat() {
  const icon  = document.getElementById('f-cat-icon-val')?.value.trim() || 'ğŸ“‹';
  const label = document.getElementById('f-cat-label')?.value.trim();
  if (!label) { alert('Category name required'); return; }
  if (_editGroupCatIdx >= 0) {
    appData.groupChecklist[_editGroupCatIdx] = { ...appData.groupChecklist[_editGroupCatIdx], icon, label };
  } else {
    appData.groupChecklist.push({ id: 'g' + Date.now(), label, icon, items: [] });
  }
  saveData().then(() => { _closeSheet(); renderTab('more'); });
}
function addGroupItem(ci)  { _addGroupItemCatIdx = ci; openSheet('group-item-form'); }
function deleteGroupItem(ci, ii) {
  const cat = appData.groupChecklist[ci];
  cat.items.splice(ii, 1);
  // indices shifted â€” clear all progress keys for this cat
  Object.keys(appData.groupProgress).forEach(k => { if (k.startsWith(cat.id + '-')) delete appData.groupProgress[k]; });
  saveData().then(() => renderTab('more'));
}
function submitGroupItem() {
  const text = document.getElementById('f-item-text')?.value.trim();
  if (!text) { alert('Item text required'); return; }
  appData.groupChecklist[_addGroupItemCatIdx].items.push(text);
  saveData().then(() => { _closeSheet(); renderTab('more'); });
}

// â”€â”€ Personal checklist toggles & CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function togglePersonalCheck(catId, ii) {
  const prog = getPersonalProgress();
  const key  = `${catId}-${ii}`;
  if (prog[key]) delete prog[key];
  else prog[key] = true;
  setPersonalProgress(prog);
  renderTab('more');
}

let _editPersonalCatIdx    = -1;
let _addPersonalItemCatIdx = -1;

function addPersonalCat()    { _editPersonalCatIdx = -1; openSheet('personal-cat-form'); }
function editPersonalCat(ci) { _editPersonalCatIdx = ci; openSheet('personal-cat-form'); }
function deletePersonalCat(ci) {
  const cats = getPersonalItems();
  if (!confirm(`Delete "${cats[ci]?.label}" and all its items?`)) return;
  cats.splice(ci, 1);
  setPersonalItems(cats);
  _closeSheet();
  renderTab('more');
}
function submitPersonalCat() {
  const icon  = document.getElementById('f-cat-icon-val')?.value.trim() || 'ğŸ’';
  const label = document.getElementById('f-cat-label')?.value.trim();
  if (!label) { alert('Category name required'); return; }
  const cats = getPersonalItems();
  if (_editPersonalCatIdx >= 0) {
    cats[_editPersonalCatIdx] = { ...cats[_editPersonalCatIdx], icon, label };
  } else {
    cats.push({ id: 'p' + Date.now(), label, icon, items: [] });
  }
  setPersonalItems(cats);
  _closeSheet();
  renderTab('more');
}
function addPersonalItem(ci)  { _addPersonalItemCatIdx = ci; openSheet('personal-item-form'); }
function deletePersonalItem(ci, ii) {
  const cats = getPersonalItems();
  const catId = cats[ci].id;
  cats[ci].items.splice(ii, 1);
  setPersonalItems(cats);
  const prog = getPersonalProgress();
  Object.keys(prog).forEach(k => { if (k.startsWith(catId + '-')) delete prog[k]; });
  setPersonalProgress(prog);
  renderTab('more');
}
function submitPersonalItem() {
  const text = document.getElementById('f-item-text')?.value.trim();
  if (!text) { alert('Item text required'); return; }
  const cats = getPersonalItems();
  cats[_addPersonalItemCatIdx].items.push(text);
  setPersonalItems(cats);
  _closeSheet();
  renderTab('more');
}

// â”€â”€ Bottom Sheet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openSheet(type) {
  const overlay = document.getElementById('sheet-overlay');
  const inner = document.getElementById('sheet-inner');
  inner.innerHTML = sheetContent(type);
  overlay.classList.add('open');
  // Trigger animation after paint
  requestAnimationFrame(() => {
    const sheet = document.getElementById('sheet');
    sheet.style.transform = 'translateY(0)';
    // Post-render hooks
    if (type === 'expense-form') renderSplitInputs();
  });
}

function closeSheet(e) {
  if (e && e.target !== document.getElementById('sheet-overlay')) return;
  _closeSheet();
}

function _closeSheet() {
  const overlay = document.getElementById('sheet-overlay');
  overlay.classList.remove('open');
}

function sheetContent(type) {
  switch(type) {
    case 'add-accom': {
      const editing = _editAccomIdx >= 0;
      const a = editing ? appData.accoms[_editAccomIdx] : null;
      return `
        <div class="sheet-title">${editing ? 'Edit Accommodation' : 'Add Accommodation'}</div>
        <div class="sheet-body">
          <div class="field"><label>Name</label><input id="f-name" value="${a?.name || ''}" placeholder="Airbnb Arenas, Hotel Rural..." autocomplete="off"></div>
          <div class="field"><label>Booking URL</label><input id="f-url" type="url" value="${a?.url || ''}" placeholder="https://airbnb.com/rooms/..."></div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div class="field">
              <label>Check-in</label>
              <input id="f-checkin" type="date" value="${a?.checkin || ''}">
              <input id="f-checkin-time" type="time" value="${a?.checkinTime || ''}" style="margin-top:6px">
            </div>
            <div class="field">
              <label>Check-out</label>
              <input id="f-checkout" type="date" value="${a?.checkout || ''}">
              <input id="f-checkout-time" type="time" value="${a?.checkoutTime || ''}" style="margin-top:6px">
            </div>
          </div>
          <div class="field"><label>Google Maps URL (optional)</label><input id="f-maps" type="url" value="${a?.mapsUrl || ''}" placeholder="https://maps.app.goo.gl/..."></div>
          <div class="field"><label>Notes (optional)</label><textarea id="f-notes" placeholder="Checkout 11am, Free parking, Contact...">${a?.notes || ''}</textarea></div>
          <button class="btn-primary" onclick="submitAccom()">${editing ? 'Save Changes' : 'Save Booking'}</button>
          ${editing ? `<button class="btn-secondary btn-danger" onclick="deleteAccom(${_editAccomIdx})">Ã— Remove Booking</button>` : ''}
          <button class="btn-secondary" onclick="_closeSheet()">Cancel</button>
        </div>`;
    }

    case 'add-flight': {
      const editing = _editFlightIdx >= 0;
      const f = editing ? appData.flights[_editFlightIdx] : null;
      return `
        <div class="sheet-title">${editing ? 'Edit Flight' : 'Add Flight'}</div>
        <div class="sheet-body">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div class="field"><label>Airline</label><input id="f-airline" value="${f?.airline||''}" placeholder="Singapore Airlines" autocomplete="off"></div>
            <div class="field"><label>Flight No.</label><input id="f-flight-num" value="${f?.flightNumber||''}" placeholder="SQ177" autocomplete="off"></div>
          </div>
          <div style="display:grid;grid-template-columns:1fr auto;gap:10px">
            <div class="field"><label>From</label><input id="f-from" value="${f?.from||''}" placeholder="Singapore Changi" autocomplete="off"></div>
            <div class="field" style="width:64px"><label>Code</label><input id="f-from-code" value="${f?.fromCode||''}" placeholder="SIN" autocomplete="off" style="text-transform:uppercase"></div>
          </div>
          <div style="display:grid;grid-template-columns:1fr auto;gap:10px">
            <div class="field"><label>To</label><input id="f-to" value="${f?.to||''}" placeholder="Casablanca Mohammed V" autocomplete="off"></div>
            <div class="field" style="width:64px"><label>Code</label><input id="f-to-code" value="${f?.toCode||''}" placeholder="CMN" autocomplete="off" style="text-transform:uppercase"></div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div class="field">
              <label>Departs</label>
              <input id="f-dep-date" type="date" value="${f?.depDate||''}">
              <input id="f-dep-time" type="time" value="${f?.depTime||''}" style="margin-top:6px">
            </div>
            <div class="field">
              <label>Arrives</label>
              <input id="f-arr-date" type="date" value="${f?.arrDate||''}">
              <input id="f-arr-time" type="time" value="${f?.arrTime||''}" style="margin-top:6px">
            </div>
          </div>
          <div class="field"><label>Booking URL (optional)</label><input id="f-url" type="url" value="${f?.url||''}" placeholder="https://..."></div>
          <div class="field"><label>Ref / PNR (optional)</label><input id="f-ref" value="${f?.ref||''}" placeholder="A1B2C3" autocomplete="off"></div>
          <div class="field"><label>Notes (optional)</label><textarea id="f-notes" placeholder="Baggage 23kg, online check-in opens...">${f?.notes||''}</textarea></div>
          <button class="btn-primary" onclick="submitFlight()">${editing ? 'Save Changes' : 'Add Flight'}</button>
          ${editing ? `<button class="btn-secondary btn-danger" onclick="deleteFlight(${_editFlightIdx})">Ã— Remove Flight</button>` : ''}
          <button class="btn-secondary" onclick="_closeSheet()">Cancel</button>
        </div>`;
    }

    case 'add-weather': return `
      <div class="sheet-title">Add Forecast Link</div>
      <div class="sheet-sub">Add a weather source</div>
      <div class="sheet-body">
        <div class="field"><label>Name</label><input id="f-name" placeholder="Potes hourly, Covadonga..." autocomplete="off"></div>
        <div class="field"><label>URL</label><input id="f-url" type="url" placeholder="https://accuweather.com/..."></div>
        <div class="field"><label>Day (optional)</label><input id="f-day" placeholder="Fri-Sat, Sunday..." autocomplete="off"></div>
        <button class="btn-primary" onclick="submitWeather()">Save Link</button>
        <button class="btn-secondary" onclick="_closeSheet()">Cancel</button>
      </div>`;

    case 'ref-form': {
      const editing = _editRefIdx >= 0;
      const r = editing ? (appData.refs||[])[_editRefIdx] : null;
      const type = r?.type || _refType;
      const cats = appData.refCats || [];
      const _selCat = r?.cat ?? _defaultRefCat;
      const catOpts = cats.map(c => `<option value="${c.id}" ${_selCat === c.id ? 'selected' : ''}>${c.icon} ${c.label}</option>`).join('');
      return `
        <div class="sheet-title">${editing ? 'Edit Item' : 'Add Item'}</div>
        <div class="sheet-body">
          <div class="field">
            <label>Type</label>
            <div style="display:flex;gap:8px;margin-top:2px">
              <button class="type-btn ${type==='link'?'selected':''}" data-type="link" onclick="setRefType('link')">ğŸ”— Link</button>
              <button class="type-btn ${type==='file'?'selected':''}" data-type="file" onclick="setRefType('file')">ğŸ“ File</button>
              <button class="type-btn ${type==='note'?'selected':''}" data-type="note" onclick="setRefType('note')">ğŸ“ Note</button>
            </div>
          </div>
          <div class="field"><label>Name / Title</label><input id="f-refname" value="${r?.name || ''}" placeholder="Emergency contacts, Trail mapâ€¦" autocomplete="off"></div>
          ${cats.length ? `<div class="field"><label>Category</label><select id="f-refcat"><option value="uncategorized" ${_selCat==='uncategorized' ? 'selected' : ''}>â€” No category â€”</option>${catOpts}</select></div>` : `<input type="hidden" id="f-refcat" value="uncategorized">`}
          <div id="ref-link-fields" style="display:${type==='link'?'':'none'}">
            <div class="field"><label>URL</label><input id="f-refurl" type="url" value="${r?.url || ''}" placeholder="https://..."></div>
          </div>
          <div id="ref-file-fields" style="display:${type==='file'?'':'none'}">
            ${editing && r?.fileName ? `<div style="font-size:12px;color:var(--text2);margin-bottom:8px;font-family:'JetBrains Mono',monospace">Current: ${r.fileName}</div>` : ''}
            <div class="field"><label>${editing ? 'Replace file (optional)' : 'File'}</label><input id="f-reffile" type="file"></div>
          </div>
          <div id="ref-note-fields" style="display:${type==='note'?'':'none'}">
            <div class="field"><label>Content</label><textarea id="f-refcontent" style="height:120px" placeholder="Write your note hereâ€¦">${r?.content ? r.content.replace(/</g,'&lt;') : ''}</textarea></div>
          </div>
          <button class="btn-primary" onclick="submitRef()">${editing ? 'Save Changes' : 'Add Item'}</button>
          ${editing ? `<button class="btn-secondary btn-danger" onclick="deleteRef(${_editRefIdx})">Ã— Remove</button>` : ''}
          <button class="btn-secondary" onclick="_closeSheet()">Cancel</button>
        </div>`;
    }

    case 'ref-cat-form': {
      const editing = _editRefCatIdx >= 0;
      const cat = editing ? (appData.refCats||[])[_editRefCatIdx] : null;
      return `
        <div class="sheet-title">${editing ? 'Edit Category' : 'Add Category'}</div>
        <div class="sheet-body">
          <div style="display:grid;grid-template-columns:72px 1fr;gap:10px;align-items:start">
            <div class="field"><label>Icon</label>
              <div id="f-cat-icon" class="emoji-display" onclick="toggleEmojiPicker('f-cat-icon', EMOJIS_CAT)">${cat?.icon || 'ğŸ“Œ'}</div>
              <input type="hidden" id="f-cat-icon-val" value="${cat?.icon || 'ğŸ“Œ'}">
              <div class="emoji-hint">Tap to change</div>
            </div>
            <div class="field"><label>Name</label><input id="f-cat-label" value="${cat?.label || ''}" placeholder="Emergency, Bookingsâ€¦" autocomplete="off"></div>
          </div>
          <button class="btn-primary" onclick="submitRefCat()">${editing ? 'Save Changes' : 'Add Category'}</button>
          ${editing ? `<button class="btn-secondary btn-danger" onclick="deleteRefCat(${_editRefCatIdx})">Ã— Delete Category</button>` : ''}
          <button class="btn-secondary" onclick="_closeSheet()">Cancel</button>
        </div>`;
    }

    case 'wishlist-form': {
      const editing = _editWishIdx >= 0;
      const item = editing ? (appData.wishlist||[])[_editWishIdx] : null;
      return `
        <div class="sheet-title">${editing ? 'Edit Place' : 'Add to Wishlist'}</div>
        <div class="sheet-body">
          <div style="display:grid;grid-template-columns:56px 1fr;gap:10px">
            <div class="field"><label>Emoji</label><input id="f-emoji" value="${item?.emoji||'ğŸ“'}" style="text-align:center;font-size:20px" maxlength="2" autocomplete="off"></div>
            <div class="field"><label>Place Name</label><input id="f-name" value="${item?.name||''}" placeholder="Jemaa el-Fnaa, Sunset pointâ€¦" autocomplete="off"></div>
          </div>
          <div class="field"><label>Google Maps URL (optional)</label><input id="f-stopmaps" type="url" value="${item?.mapsUrl||''}" placeholder="https://maps.app.goo.gl/â€¦"></div>
          <div class="field"><label>Notes (optional)</label><textarea id="f-notes" placeholder="Visit at sunset, try the mint teaâ€¦">${item?.note||''}</textarea></div>
          <button class="btn-primary" onclick="submitWishlistItem()">${editing ? 'Save Changes' : 'Add to Wishlist'}</button>
          ${editing ? `<button class="btn-secondary btn-danger" onclick="deleteWishlistItem(${_editWishIdx})">Ã— Remove</button>` : ''}
          <button class="btn-secondary" onclick="_closeSheet()">Cancel</button>
        </div>`;
    }

    case 'stop-form': {
      const editing = _editStopIdx >= 0;
      const day  = appData.days[_editStopDayIdx];
      const stop = editing ? day?.stops[_editStopIdx] : null;
      const pre  = !editing ? _wishlistPrefill : null;
      _wishlistPrefill = null;
      const accomOpts = appData.accoms.map((a,i) => `<option value="${i}">${a.name}</option>`).join('');
      return `
        <div class="sheet-title">${editing ? 'Edit Stop' : 'Add Stop'}</div>
        <div class="sheet-sub">${day?.emoji || ''} ${day?.label || ''} Â· ${day?.title || ''}</div>
        <div class="sheet-body">
          ${appData.accoms.length && !editing ? `
          <div class="field">
            <label>From Accommodation</label>
            <select id="f-accomsel" onchange="prefillFromAccom()">
              <option value="">â€” pick to auto-fill â€”</option>
              ${accomOpts}
            </select>
          </div>` : ''}
          ${(appData.flights||[]).length && !editing ? `
          <div class="field">
            <label>From Flight</label>
            <div style="display:grid;grid-template-columns:1fr auto;gap:8px">
              <select id="f-flightsel" onchange="prefillFromFlight()">
                <option value="">â€” pick a flight â€”</option>
                ${(appData.flights||[]).map((f,i) => `<option value="${i}">âœˆï¸ ${f.flightNumber||'?'} Â· ${f.fromCode||f.from||'?'} â†’ ${f.toCode||f.to||'?'}</option>`).join('')}
              </select>
              <select id="f-flightdir" style="width:90px">
                <option value="dep">Departs</option>
                <option value="arr">Arrives</option>
              </select>
            </div>
          </div>` : ''}
          <div class="field"><label>Stop Name</label><input id="f-name" value="${stop?.name || pre?.name || ''}" placeholder="Hotel check-in, Dinner, Trailheadâ€¦" autocomplete="off"></div>
          <div class="field"><label>Time</label><input id="f-time" type="time" value="${stop?.time || ''}"></div>
          <div class="field"><label>Google Maps URL (optional)</label><input id="f-stopmaps" type="url" value="${stop?.mapsUrl || pre?.mapsUrl || ''}" placeholder="https://maps.app.goo.gl/â€¦"></div>
          <div class="field"><label>Notes (optional)</label><textarea id="f-notes" placeholder="Reserve in advance, checkout 11amâ€¦">${stop?.note || pre?.note || ''}</textarea></div>
          <button class="btn-primary" onclick="submitStop()">${editing ? 'Save Changes' : 'Add Stop'}</button>
          ${editing ? `<button class="btn-secondary btn-danger" onclick="deleteStop(${_editStopDayIdx},${_editStopIdx})">Ã— Remove Stop</button>` : ''}
          <button class="btn-secondary" onclick="_closeSheet()">Cancel</button>
        </div>`;
    }

    case 'edit-trip': return `
      <div class="sheet-title">Edit Trip Info</div>
      <div class="sheet-body">
        <div class="field"><label>Trip Name</label><input id="f-name" value="${appData.trip.name}" autocomplete="off"></div>
        <div class="field"><label>Dates</label><input id="f-dates" value="${appData.trip.dates}" autocomplete="off"></div>
        <button class="btn-primary" onclick="submitEditTrip()">Save Changes</button>
        <button class="btn-secondary" onclick="_closeSheet()">Cancel</button>
      </div>`;

    case 'show-id': return `
      <div class="sheet-title">Your Telegram ID</div>
      <div class="sheet-sub">Share this with the trip admin to get edit access</div>
      <div class="sheet-body">
        <div style="background:var(--card);border:1px solid var(--border2);border-radius:12px;padding:20px;text-align:center;font-family:monospace;font-size:28px;color:var(--gold2);letter-spacing:2px;margin-bottom:16px">${userId || 'Not available'}</div>
        <button class="btn-secondary" onclick="_closeSheet()">Close</button>
      </div>`;

    case 'wx-loc-form': {
      const editing = _wxLocEditIdx >= 0;
      const loc = editing ? appData.wxLocations[_wxLocEditIdx] : null;
      const btnStyle = 'background:var(--gold-dim);border:1px solid #c8912a55;color:var(--gold2);border-radius:8px;padding:10px 14px;font-size:14px;font-weight:600;cursor:pointer;font-family:"DM Sans",sans-serif;flex-shrink:0';
      const cbStyle  = 'display:flex;align-items:center;gap:8px;color:var(--text);font-size:14px;text-transform:none;letter-spacing:0;cursor:pointer;margin-bottom:0';
      return `
        <div class="sheet-title">${editing ? 'Edit' : 'Add'} Weather Location</div>
        <div class="sheet-body">
          <div class="field"><label>Display Name</label><input id="f-wxname" value="${loc?.name || ''}" placeholder="Burgos, Picos de Europaâ€¦" autocomplete="off"></div>
          <div class="field">
            <label>Search Location</label>
            <div style="display:flex;gap:8px">
              <input id="f-wxplace" placeholder="${loc?.name || 'Type a place nameâ€¦'}" autocomplete="off" style="flex:1" onkeydown="if(event.key==='Enter'){event.preventDefault();searchWxPlace()}">
              <button type="button" onclick="searchWxPlace()" style="${btnStyle}">ğŸ” Search</button>
            </div>
            <div id="wx-geo-result" style="font-size:12px;margin-top:6px;color:var(--text3)">${loc ? `Current: ${loc.lat.toFixed(4)}, ${loc.lon.toFixed(4)} â€” search to change` : 'Search to set coordinates'}</div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div class="field"><label>From</label><input id="f-wxfrom" type="date" value="${loc?.dateFrom || ''}"></div>
            <div class="field"><label>To (optional)</label><input id="f-wxto" type="date" value="${loc?.dateTo || ''}"></div>
          </div>
          <div class="field">
            <label>Show extra info</label>
            <div style="display:flex;gap:24px;margin-top:8px">
              <div class="custom-check ${loc?.wind ? 'checked' : ''}" id="f-wxwind" onclick="this.classList.toggle('checked')">
                <div class="check-box"><span class="check-tick">âœ“</span></div>
                <span style="font-size:14px;color:var(--text)">Wind speed</span>
              </div>
              <div class="custom-check ${loc?.snow ? 'checked' : ''}" id="f-wxsnow" onclick="this.classList.toggle('checked')">
                <div class="check-box"><span class="check-tick">âœ“</span></div>
                <span style="font-size:14px;color:var(--text)">Snowfall</span>
              </div>
            </div>
          </div>
          <div class="field"><label>Forecast link URL (optional)</label><input id="f-wxforecasturl" type="url" value="${loc?.forecastUrl || ''}" placeholder="https://accuweather.com/â€¦"></div>
          <div class="field"><label>Forecast link name</label><input id="f-wxforecastname" value="${loc?.forecastName || ''}" placeholder="AccuWeather Burgosâ€¦" autocomplete="off"></div>
          <button class="btn-primary" onclick="submitWxLoc()">${editing ? 'Save Changes' : 'Add Location'}</button>
          ${editing ? `<button class="btn-secondary btn-danger" onclick="deleteWxLoc(${_wxLocEditIdx})">Ã— Delete Location</button>` : ''}
          <button class="btn-secondary" onclick="_closeSheet()">Cancel</button>
        </div>`;
    }

    case 'day-form': {
      const editing = _editDayIdx >= 0;
      const d = editing ? appData.days[_editDayIdx] : null;
      return `
        <div class="sheet-title">${editing ? 'Edit Day' : 'Add Day'}</div>
        <div class="sheet-body">
          <div style="display:grid;grid-template-columns:72px 1fr;gap:10px;align-items:start">
            <div class="field"><label>Emoji</label>
              <div id="f-dayemoji" class="emoji-display" onclick="toggleEmojiPicker('f-dayemoji', EMOJIS_DAY)">${d?.emoji || 'ğŸ“'}</div>
              <input type="hidden" id="f-dayemoji-val" value="${d?.emoji || 'ğŸ“'}">
              <div class="emoji-hint">Tap to change</div>
            </div>
            <div class="field"><label>Title</label><input id="f-daytitle" value="${d?.title || ''}" placeholder="Madrid to Burgosâ€¦" autocomplete="off"></div>
          </div>
          <div class="field"><label>Date</label><input id="f-daydate" type="date" value="${d?.date || ''}"></div>
          <div class="field"><label>Description (optional)</label><textarea id="f-daydesc" placeholder="Drive up north, check in at 15:00â€¦">${d?.description || ''}</textarea></div>
          <button class="btn-primary" onclick="submitDay()">${editing ? 'Save Changes' : 'Add Day'}</button>
          ${editing ? `<button class="btn-secondary btn-danger" onclick="deleteDay(${_editDayIdx})">Ã— Delete Day &amp; All Stops</button>` : ''}
          <button class="btn-secondary" onclick="_closeSheet()">Cancel</button>
        </div>`;
    }

    case 'group-cat-form': {
      const editing = _editGroupCatIdx >= 0;
      const cat = editing ? appData.groupChecklist[_editGroupCatIdx] : null;
      return `
        <div class="sheet-title">${editing ? 'Edit Category' : 'Add Group Category'}</div>
        <div class="sheet-body">
          <div style="display:grid;grid-template-columns:72px 1fr;gap:10px;align-items:start">
            <div class="field"><label>Icon</label>
              <div id="f-cat-icon" class="emoji-display" onclick="toggleEmojiPicker('f-cat-icon', EMOJIS_CAT)">${cat?.icon || 'ğŸ“‹'}</div>
              <input type="hidden" id="f-cat-icon-val" value="${cat?.icon || 'ğŸ“‹'}">
              <div class="emoji-hint">Tap to change</div>
            </div>
            <div class="field"><label>Name</label><input id="f-cat-label" value="${cat?.label || ''}" placeholder="Hiking Gear" autocomplete="off"></div>
          </div>
          <button class="btn-primary" onclick="submitGroupCat()">${editing ? 'Save Changes' : 'Add Category'}</button>
          ${editing ? `<button class="btn-secondary btn-danger" onclick="deleteGroupCat(${_editGroupCatIdx})">Ã— Delete Category</button>` : ''}
          <button class="btn-secondary" onclick="_closeSheet()">Cancel</button>
        </div>`;
    }

    case 'group-item-form': return `
      <div class="sheet-title">Add Item</div>
      <div class="sheet-body">
        <div class="field"><label>Item</label><input id="f-item-text" placeholder="e.g. Waterproof jacket" autocomplete="off"></div>
        <button class="btn-primary" onclick="submitGroupItem()">Add Item</button>
        <button class="btn-secondary" onclick="_closeSheet()">Cancel</button>
      </div>`;

    case 'personal-cat-form': {
      const editing = _editPersonalCatIdx >= 0;
      const cats = getPersonalItems();
      const cat = editing ? cats[_editPersonalCatIdx] : null;
      return `
        <div class="sheet-title">${editing ? 'Edit Category' : 'Add My Category'}</div>
        <div class="sheet-body">
          <div style="display:grid;grid-template-columns:72px 1fr;gap:10px;align-items:start">
            <div class="field"><label>Icon</label>
              <div id="f-cat-icon" class="emoji-display" onclick="toggleEmojiPicker('f-cat-icon', EMOJIS_CAT)">${cat?.icon || 'ğŸ’'}</div>
              <input type="hidden" id="f-cat-icon-val" value="${cat?.icon || 'ğŸ’'}">
              <div class="emoji-hint">Tap to change</div>
            </div>
            <div class="field"><label>Name</label><input id="f-cat-label" value="${cat?.label || ''}" placeholder="My Gear" autocomplete="off"></div>
          </div>
          <button class="btn-primary" onclick="submitPersonalCat()">${editing ? 'Save Changes' : 'Add Category'}</button>
          ${editing ? `<button class="btn-secondary btn-danger" onclick="deletePersonalCat(${_editPersonalCatIdx})">Ã— Delete Category</button>` : ''}
          <button class="btn-secondary" onclick="_closeSheet()">Cancel</button>
        </div>`;
    }

    case 'personal-item-form': return `
      <div class="sheet-title">Add Item</div>
      <div class="sheet-body">
        <div class="field"><label>Item</label><input id="f-item-text" placeholder="e.g. Passport" autocomplete="off"></div>
        <button class="btn-primary" onclick="submitPersonalItem()">Add Item</button>
        <button class="btn-secondary" onclick="_closeSheet()">Cancel</button>
      </div>`;

    // â”€â”€ Expense Splitter sheets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    case 'register-member': return `
      <div class="sheet-title">Join the Split ğŸ’¸</div>
      <div class="sheet-sub">Set your name and payment number so the group can settle up with you</div>
      <div class="sheet-body">
        <div class="field">
          <label>Your name</label>
          <input id="f-member-name" placeholder="e.g. Denzil" autocomplete="off" autofocus>
        </div>
        <div class="field">
          <label>Phone / PayNow / PayLah number <span style="color:var(--danger)">*</span></label>
          <input id="f-member-phone" type="tel" placeholder="e.g. +65 9123 4567" autocomplete="tel">
          <div style="font-size:11px;color:var(--text3);margin-top:4px">Shown to others when they need to pay you back</div>
        </div>
        <button class="btn-primary" onclick="submitMemberRegister()">Join the trip</button>
      </div>`;

    case 'expense-form': {
      const editing = _editExpenseIdx >= 0;
      const exp = editing ? appData.expenses[_editExpenseIdx] : null;
      const members = appData.members || [];
      const today = new Date().toISOString().slice(0,10);
      const base = appData.tripCurrency?.base || 'SGD';
      const allCurrencies = [base, ...Object.keys(appData.tripCurrency?.rates||{}).filter(c=>c!==base), ...SUPPORTED_CURRENCIES.filter(c=>c!==base&&!appData.tripCurrency?.rates?.[c])];
      const uniqueCurrencies = [...new Set(allCurrencies)];
      const myMember = _myMember();
      const defaultPayer = exp?.paidBy || myMember?.id || members[0]?.id || '';
      const catOptions = EXPENSE_CATEGORIES.map(c => `<option value="${c}" ${(exp?.category||EXPENSE_CATEGORIES[0])===c?'selected':''}>${c}</option>`).join('');
      const currOptions = uniqueCurrencies.map(c => `<option value="${c}" ${(exp?.currency||base)===c?'selected':''}>${c}</option>`).join('');
      const memberOptions = members.map(m => `<option value="${m.id}" ${defaultPayer===m.id?'selected':''}>${m.name}</option>`).join('');
      const splitTypes = ['equal','exact','percent','shares'];
      const splitBtns = splitTypes.map(t => `<button type="button" class="split-type-btn ${_splitType===t?'selected':''}" data-type="${t}" onclick="setSplitType('${t}')">${t.charAt(0).toUpperCase()+t.slice(1)}</button>`).join('');
      if (!members.length) return `
        <div class="sheet-title">Add Expense</div>
        <div class="sheet-body">
          <div style="text-align:center;padding:20px 0;color:var(--text3);font-size:14px">No members yet.<br>Ask friends to open the Split tab to join.</div>
          <button class="btn-secondary" onclick="_closeSheet()">Close</button>
        </div>`;
      return `
        <div class="sheet-title">${editing ? 'Edit Expense' : 'Add Expense'}</div>
        <div class="sheet-body">
          <div class="field"><label>Description</label><input id="f-exp-title" value="${exp?.title||''}" placeholder="e.g. Lunch at Ouarzazate" autocomplete="off"></div>
          <div style="display:grid;grid-template-columns:1fr 100px;gap:10px">
            <div class="field"><label>Amount</label><input id="f-exp-amount" type="number" step="0.01" min="0" value="${exp?.amount||''}" placeholder="0.00" oninput="renderSplitInputs()"></div>
            <div class="field"><label>Currency</label><select id="f-exp-currency">${currOptions}</select></div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div class="field"><label>Date</label><input id="f-exp-date" type="date" value="${exp?.date||today}"></div>
            <div class="field"><label>Paid by</label><select id="f-exp-paidby">${memberOptions}</select></div>
          </div>
          <div class="field"><label>Category</label><select id="f-exp-category">${catOptions}</select></div>
          <div class="field">
            <label>Split</label>
            <div class="split-type-bar">${splitBtns}</div>
          </div>
          <div class="field">
            <label>Participants &amp; amounts</label>
            <div id="f-exp-splits-container"></div>
          </div>
          <div class="field"><label>Note (optional)</label><textarea id="f-exp-note" placeholder="e.g. includes tip">${exp?.note||''}</textarea></div>
          <button class="btn-primary" onclick="submitExpense()">${editing?'Save Changes':'Add Expense'}</button>
          ${editing ? `<button class="btn-secondary btn-danger" onclick="deleteExpense(${_editExpenseIdx})">Ã— Delete Expense</button>` : ''}
          <button class="btn-secondary" onclick="_closeSheet()">Cancel</button>
        </div>`;
    }

    case 'settle-form': {
      const members = appData.members || [];
      const today = new Date().toISOString().slice(0,10);
      const base = appData.tripCurrency?.base || 'SGD';
      const allCurrencies = [base, ...Object.keys(appData.tripCurrency?.rates||{}).filter(c=>c!==base), ...SUPPORTED_CURRENCIES.filter(c=>c!==base&&!appData.tripCurrency?.rates?.[c])];
      const uniqueCurrencies = [...new Set(allCurrencies)];
      const pf = _prefillSettle;
      const fromOpts = members.map(m => `<option value="${m.id}" ${pf?.from===m.id?'selected':''}>${m.name}</option>`).join('');
      const toOpts   = members.map(m => `<option value="${m.id}" ${pf?.to===m.id?'selected':''}>${m.name}</option>`).join('');
      const currOpts = uniqueCurrencies.map(c => `<option value="${c}" ${(pf?.currency||base)===c?'selected':''}>${c}</option>`).join('');
      const initialTo = pf?.to ? members.find(m => m.id === pf.to) : members[0];
      const phoneBoxHtml = initialTo?.phone
        ? `<div id="settle-phone-info" style="display:flex;align-items:center;gap:12px;background:var(--card2);border:1px solid var(--gold-dim);border-radius:10px;padding:12px 14px;margin-bottom:4px">
            <span style="font-size:22px">ğŸ“±</span>
            <div>
              <div style="font-size:11px;color:var(--text3);margin-bottom:3px">Send payment to <strong style="color:var(--text2)">${initialTo.name}</strong></div>
              <div style="font-size:16px;font-weight:600;color:var(--gold2);font-family:'JetBrains Mono',monospace;letter-spacing:0.5px">${initialTo.phone}</div>
            </div>
          </div>`
        : `<div id="settle-phone-info" style="display:none"></div>`;
      return `
        <div class="sheet-title">Record Settlement</div>
        <div class="sheet-sub">Log a payment made to settle a debt</div>
        <div class="sheet-body">
          ${phoneBoxHtml}
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div class="field"><label>Who paid</label><select id="f-settle-from">${fromOpts}</select></div>
            <div class="field"><label>Paid to</label><select id="f-settle-to" onchange="updateSettlePhoneInfo()">${toOpts}</select></div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 100px;gap:10px">
            <div class="field"><label>Amount</label><input id="f-settle-amount" type="number" step="0.01" min="0" value="${pf?.amount||''}"></div>
            <div class="field"><label>Currency</label><select id="f-settle-currency">${currOpts}</select></div>
          </div>
          <div class="field"><label>Date</label><input id="f-settle-date" type="date" value="${today}"></div>
          <div class="field"><label>Note (optional)</label><textarea id="f-settle-note" placeholder="e.g. Cash at airport"></textarea></div>
          <button class="btn-primary" onclick="submitSettlement()">Record Settlement</button>
          <button class="btn-secondary" onclick="_closeSheet()">Cancel</button>
        </div>`;
    }

    case 'currency-settings': {
      const tc = appData.tripCurrency || { base: 'SGD', rates: {} };
      const rateRows = Object.entries(tc.rates||{}).map(([code, val]) => `
        <div class="rate-row">
          <span style="color:var(--text3);font-size:12px;flex-shrink:0">1</span>
          <input class="rate-code" value="${code}" style="width:65px;background:var(--card);border:1px solid var(--border2);border-radius:8px;padding:10px;color:var(--text);font-size:13px;text-transform:uppercase" autocomplete="off">
          <span style="color:var(--text3);font-size:12px;flex-shrink:0">= </span>
          <input class="rate-val" type="number" step="0.0001" value="${val}" style="flex:1;background:var(--card);border:1px solid var(--border2);border-radius:8px;padding:10px;color:var(--text);font-size:13px">
          <span style="color:var(--text3);font-size:12px;flex-shrink:0">${tc.base}</span>
          <span onclick="this.parentElement.remove()" style="color:var(--danger);cursor:pointer;font-size:20px;padding:0 4px;line-height:1;flex-shrink:0">Ã—</span>
        </div>`).join('');
      return `
        <div class="sheet-title">Exchange Rates</div>
        <div class="sheet-sub">Set 1 base currency = how many of each foreign currency</div>
        <div class="sheet-body">
          <div class="field">
            <label>Base currency (your home currency)</label>
            <input id="f-base-currency" value="${tc.base}" placeholder="SGD" style="text-transform:uppercase" autocomplete="off">
          </div>
          <div class="field">
            <label>Foreign currencies</label>
            <div id="rate-rows">${rateRows}</div>
            <button type="button" onclick="addRateRow()" style="margin-top:8px;font-size:13px;padding:8px 14px;border-radius:8px;border:1px dashed var(--border2);background:none;color:var(--text2);cursor:pointer;width:100%">ï¼‹ Add currency</button>
          </div>
          <div style="font-size:12px;color:var(--text3);background:var(--card);border-radius:8px;padding:10px;margin-bottom:8px">
            Example: Base = SGD, 1 MAD = 0.29 SGD â†’ enter 0.29
          </div>
          <button class="btn-primary" onclick="submitCurrencySettings()">Save Rates</button>
          <button class="btn-secondary" onclick="_closeSheet()">Cancel</button>
        </div>`;
    }

    case 'manage-members': {
      const members = appData.members || [];
      const memberList = members.length ? members.map((m, i) => `
        <div class="member-row">
          <div class="member-avatar">${m.name.charAt(0).toUpperCase()}</div>
          <div style="flex:1;min-width:0">
            <div style="font-size:14px;font-weight:500">${m.name}</div>
            <div style="font-size:11px;color:${m.phone ? 'var(--text2)' : 'var(--danger)'};font-family:'JetBrains Mono',monospace">
              ${m.phone ? `ğŸ“± ${m.phone}` : 'âš  no payment number'}
            </div>
          </div>
          ${isAdmin ? `<span onclick="deleteMember(${i})" style="color:var(--danger);font-size:20px;cursor:pointer;padding:0 4px;line-height:1">Ã—</span>` : ''}
        </div>`).join('')
        : `<div style="color:var(--text3);font-size:13px;padding:8px 0">No members yet. Friends join by opening the Split tab.</div>`;
      return `
        <div class="sheet-title">Split Members</div>
        <div class="sheet-sub">Payment numbers are shown when settling debts</div>
        <div class="sheet-body">
          <div style="margin-bottom:16px">${memberList}</div>
          ${isAdmin ? `
          <div class="field">
            <label>Add manual member (no Telegram)</label>
            <input id="f-manual-name" placeholder="e.g. Sarah" autocomplete="off">
          </div>
          <div class="field">
            <label>Their phone / PayNow number</label>
            <input id="f-manual-phone" type="tel" placeholder="e.g. +65 9123 4567" autocomplete="tel">
          </div>
          <button class="btn-primary" onclick="submitManualMember()">Add Member</button>` : ''}
          <button class="btn-secondary" onclick="_closeSheet()">Close</button>
        </div>`;
    }

    default: return '';
  }
}

// â”€â”€ Submit handlers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function formatDate(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr + 'T00:00:00');
  return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
}

function submitAccom() {
  const name = document.getElementById('f-name')?.value.trim();
  let url    = document.getElementById('f-url')?.value.trim();
  if (!name || !url) { alert('Name and URL are required'); return; }
  if (!url.match(/^https?:\/\//i)) url = 'https://' + url;
  const checkin      = document.getElementById('f-checkin')?.value      || '';
  const checkout     = document.getElementById('f-checkout')?.value     || '';
  const checkinTime  = document.getElementById('f-checkin-time')?.value  || '';
  const checkoutTime = document.getElementById('f-checkout-time')?.value || '';
  let day = '';
  if (checkin) {
    day = formatDate(checkin);
    if (checkinTime) day += ' ' + checkinTime;
  }
  if (checkout) {
    day += (day ? ' â€“ ' : '') + formatDate(checkout);
    if (checkoutTime) day += ' ' + checkoutTime;
  }
  let mapsUrl = document.getElementById('f-maps')?.value.trim() || '';
  if (mapsUrl && !mapsUrl.match(/^https?:\/\//i)) mapsUrl = 'https://' + mapsUrl;
  const accom = { name, url, day, mapsUrl, notes: document.getElementById('f-notes')?.value.trim() || '', checkin, checkout, checkinTime, checkoutTime };
  if (_editAccomIdx >= 0) { appData.accoms[_editAccomIdx] = accom; }
  else { appData.accoms.push(accom); }
  saveData().then(() => { _closeSheet(); renderTab('accoms'); });
}

function submitWeather() {
  const name = document.getElementById('f-name')?.value.trim();
  const url  = document.getElementById('f-url')?.value.trim();
  if (!name || !url) { alert('Name and URL are required'); return; }
  appData.weather.push({ name, url, day: document.getElementById('f-day')?.value.trim() || '' });
  saveData().then(() => { _closeSheet(); renderTab('weather'); });
}


function prefillFromAccom() {
  const sel = document.getElementById('f-accomsel');
  if (!sel || sel.value === '') return;
  const accom = appData.accoms[parseInt(sel.value)];
  if (!accom) return;
  const nameEl = document.getElementById('f-name');
  if (nameEl && !nameEl.value) nameEl.value = accom.name;
  const mapsEl = document.getElementById('f-stopmaps');
  if (mapsEl && !mapsEl.value && accom.mapsUrl) mapsEl.value = accom.mapsUrl;
  const notesEl = document.getElementById('f-notes');
  if (notesEl && !notesEl.value && accom.notes) notesEl.value = accom.notes;
}

function prefillFromFlight() {
  const sel = document.getElementById('f-flightsel');
  if (!sel || sel.value === '') return;
  const flight = (appData.flights || [])[parseInt(sel.value)];
  if (!flight) return;
  const isDep  = (document.getElementById('f-flightdir')?.value || 'dep') === 'dep';
  const code   = isDep ? (flight.fromCode || flight.from || '') : (flight.toCode || flight.to || '');
  const verb   = isDep ? 'Departs' : 'Arrives';
  const fn     = flight.flightNumber || 'Flight';
  const nameEl = document.getElementById('f-name');
  const timeEl = document.getElementById('f-time');
  const noteEl = document.getElementById('f-notes');
  if (nameEl) nameEl.value = `âœˆï¸ ${fn} â€” ${verb} ${code}`.trim();
  if (timeEl) timeEl.value = isDep ? (flight.depTime || '') : (flight.arrTime || '');
  if (noteEl && !noteEl.value) {
    const parts = [
      flight.airline,
      flight.from && flight.to ? `${flight.from} â†’ ${flight.to}` : '',
      flight.ref ? `Ref: ${flight.ref}` : ''
    ].filter(Boolean);
    noteEl.value = parts.join(' Â· ');
  }
}

function submitStop() {
  const time = document.getElementById('f-time')?.value || '';
  const name = document.getElementById('f-name')?.value.trim();
  if (!name) { alert('Stop name is required'); return; }
  let mapsUrl = document.getElementById('f-stopmaps')?.value.trim() || '';
  if (mapsUrl && !mapsUrl.match(/^https?:\/\//i)) mapsUrl = 'https://' + mapsUrl;
  const day = appData.days[_editStopDayIdx];
  if (!day) return;
  const stop = { time, name, note: document.getElementById('f-notes')?.value.trim() || '', mapsUrl };
  if (_editStopIdx >= 0) { day.stops[_editStopIdx] = stop; }
  else { day.stops.push(stop); }
  if (time) day.stops.sort((a, b) => (a.time||'').localeCompare(b.time||''));
  saveData().then(() => { _closeSheet(); renderTab('itinerary'); });
}

function submitEditTrip() {
  const name  = document.getElementById('f-name')?.value.trim();
  const dates = document.getElementById('f-dates')?.value.trim();
  if (!name || !dates) { alert('Name and dates are required'); return; }
  appData.trip.name  = name;
  appData.trip.dates = dates;
  saveData().then(() => {
    document.getElementById('trip-name').textContent = name;
    document.getElementById('trip-dates').textContent = dates;
    _closeSheet();
    renderTab('more');
  });
}

// â”€â”€ Expense Splitter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const EXPENSE_CATEGORIES = ['ğŸ½ï¸ Food & Drink','ğŸš— Transport','ğŸ¨ Accommodation','ğŸ­ Activities','ğŸ›’ Shopping','ğŸ’Š Health','ğŸ“¦ Other'];
const SUPPORTED_CURRENCIES = ['SGD','MAD','EUR','USD','GBP','AUD'];

function _memberName(id) {
  const m = (appData.members || []).find(m => m.id === id);
  return m ? m.name : '?';
}
function _myMember() {
  return (appData.members || []).find(m => m.userId === userId) || null;
}
function _catIcon(cat) {
  const map = {'ğŸ½ï¸ Food & Drink':'ğŸ½ï¸','ğŸš— Transport':'ğŸš—','ğŸ¨ Accommodation':'ğŸ¨','ğŸ­ Activities':'ğŸ­','ğŸ›’ Shopping':'ğŸ›’','ğŸ’Š Health':'ğŸ’Š','ğŸ“¦ Other':'ğŸ“¦'};
  return map[cat] || 'ğŸ“¦';
}
function _fmtAmt(amount, currency) {
  return `${Number(amount).toFixed(2)}<span class="currency-badge">${currency}</span>`;
}

// â”€â”€ Balance computation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function computeSimplifiedDebts() {
  const members     = appData.members     || [];
  const expenses    = appData.expenses    || [];
  const settlements = appData.settlements || [];
  const rates       = appData.tripCurrency?.rates || {};
  const base        = appData.tripCurrency?.base  || 'SGD';

  function toBase(amount, currency) {
    if (currency === base) return amount;
    const r = rates[currency];
    return r ? amount * r : amount;
  }

  const net = {};
  members.forEach(m => { net[m.id] = 0; });

  expenses.forEach(exp => {
    const baseAmt = toBase(exp.amount, exp.currency);
    net[exp.paidBy] = (net[exp.paidBy] || 0) + baseAmt;
    Object.entries(exp.splits || {}).forEach(([mid, share]) => {
      net[mid] = (net[mid] || 0) - toBase(share, exp.currency);
    });
  });

  settlements.forEach(s => {
    const baseAmt = toBase(s.amount, s.currency);
    net[s.fromMember] = (net[s.fromMember] || 0) + baseAmt;
    net[s.toMember]   = (net[s.toMember]   || 0) - baseAmt;
  });

  const creditors = [], debtors = [];
  Object.entries(net).forEach(([id, bal]) => {
    if (bal >  0.005) creditors.push({ id, amount: bal });
    if (bal < -0.005) debtors.push({ id, amount: -bal });
  });
  creditors.sort((a, b) => b.amount - a.amount);
  debtors.sort((a, b) => b.amount - a.amount);

  const C = creditors.map(c => ({...c}));
  const D = debtors.map(d => ({...d}));
  const debts = [];
  let ci = 0, di = 0;
  while (ci < C.length && di < D.length) {
    const settled = Math.min(C[ci].amount, D[di].amount);
    if (settled > 0.005) debts.push({ from: D[di].id, to: C[ci].id, amount: settled, currency: base });
    C[ci].amount -= settled;
    D[di].amount -= settled;
    if (C[ci].amount < 0.005) ci++;
    if (D[di].amount < 0.005) di++;
  }
  return { debts, netByMember: net };
}

// â”€â”€ renderExpenses â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderExpenses() {
  if (!appData.members)      appData.members      = [];
  if (!appData.expenses)     appData.expenses     = [];
  if (!appData.settlements)  appData.settlements  = [];
  if (!appData.tripCurrency) appData.tripCurrency = { base: 'SGD', rates: { MAD: 0.29, EUR: 1.45, USD: 1.35 } };

  // Registration interstitial
  if (userId && !_myMember()) {
    return `
      <div style="padding:50px 20px;text-align:center">
        <div style="font-size:52px;margin-bottom:16px">ğŸ’¸</div>
        <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:8px">Join the Split</div>
        <div style="color:var(--text2);font-size:14px;line-height:1.6;margin-bottom:28px">Set your display name so the group can see who paid what.</div>
        <button class="btn-primary" onclick="promptMemberRegister()" style="max-width:260px;margin:0 auto;display:block">Set my name</button>
      </div>`;
  }

  const base = appData.tripCurrency.base;
  const { debts } = computeSimplifiedDebts();
  const myMember = _myMember();
  const myId = myMember?.id || '';

  function toBase(amount, currency) {
    if (currency === base) return amount;
    const r = appData.tripCurrency.rates[currency];
    return r ? amount * r : amount;
  }

  // â”€â”€ Summary totals â”€â”€
  const groupTotal = (appData.expenses || []).reduce((sum, e) => sum + toBase(e.amount, e.currency), 0);
  const myTotal = (appData.expenses || []).reduce((sum, e) => {
    const mySplit = myId && e.splits && e.splits[myId] != null ? e.splits[myId] : 0;
    return sum + toBase(mySplit, e.currency);
  }, 0);

  const summaryHtml = `
    <div class="split-summary-grid">
      <div class="split-summary-card">
        <div class="split-summary-label">Group Total</div>
        <div class="split-summary-value">${base} ${groupTotal.toFixed(2)}</div>
        <div class="split-summary-sub">${appData.expenses.length} expense${appData.expenses.length!==1?'s':''}</div>
      </div>
      <div class="split-summary-card">
        <div class="split-summary-label">Your Share</div>
        <div class="split-summary-value">${myId ? `${base} ${myTotal.toFixed(2)}` : 'â€”'}</div>
        <div class="split-summary-sub">${myId ? 'of group total' : 'not joined'}</div>
      </div>
    </div>`;

  // â”€â”€ Outstanding Debts â”€â”€
  const myDebtCount = myId ? debts.filter(d => d.from === myId || d.to === myId).length : 0;
  let debtRowsHtml = '';
  if (appData.members.length < 2) {
    debtRowsHtml = `<div style="padding:12px 0 4px;text-align:center;color:var(--text3);font-size:13px">${appData.members.length === 0 ? 'No members yet' : 'Need at least 2 members'}</div>`;
  } else if (!debts.length) {
    debtRowsHtml = `<div style="padding:12px 0 4px;text-align:center;color:var(--text3);font-size:13px">âœ“ All settled up</div>`;
  } else {
    debts.forEach(d => {
      const amtCls = d.from === myId ? 'owe' : d.to === myId ? 'lent' : '';
      debtRowsHtml += `<div class="debt-row" data-from="${d.from}" data-to="${d.to}">
        <div class="debt-names">
          <span class="debt-avatar">${_memberName(d.from).charAt(0).toUpperCase()}</span>
          ${_memberName(d.from)}
          <span class="debt-arrow">owes</span>
          <span class="debt-avatar debt-avatar--to">${_memberName(d.to).charAt(0).toUpperCase()}</span>
          ${_memberName(d.to)}
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <span class="debt-amount ${amtCls}">${Number(d.amount).toFixed(2)} ${d.currency}</span>
          <button class="settle-btn" onclick="quickSettle('${d.from}','${d.to}',${d.amount},'${d.currency}')">Settle â†’</button>
        </div>
      </div>`;
    });
  }

  // â”€â”€ Expenses â”€â”€
  const expenses = [...(appData.expenses || [])].sort((a, b) => b.date.localeCompare(a.date));
  let expHtml = '';
  if (!expenses.length) {
    expHtml = `<div style="padding:24px 0;text-align:center;color:var(--text3);font-size:13px">No expenses yet â€” tap ï¼‹ Add</div>`;
  } else {
    let lastDate = '';
    expenses.forEach(exp => {
      const realIdx = appData.expenses.indexOf(exp);
      const titleLower = (exp.title || '').toLowerCase();
      if (exp.date !== lastDate) {
        expHtml += `<div class="expense-date-group">${formatDate(exp.date)}</div>`;
        lastDate = exp.date;
      }
      const pCount = (exp.participants || []).length;
      const myShare = myId && exp.splits && exp.splits[myId] != null ? exp.splits[myId] : null;
      expHtml += `<div class="expense-row" data-title="${titleLower}" onclick="editExpense(${realIdx})">
        <div class="expense-row-icon">${_catIcon(exp.category)}</div>
        <div class="expense-row-body">
          <div class="expense-row-title">${exp.title}</div>
          <div class="expense-row-meta">Paid by ${_memberName(exp.paidBy)} Â· ${pCount} ${pCount===1?'person':'people'}</div>
        </div>
        <div class="expense-row-right">
          <div class="expense-row-amount">${_fmtAmt(exp.amount, exp.currency)}</div>
          ${myShare !== null ? `<div class="expense-row-payer">You: ${_fmtAmt(myShare, exp.currency)}</div>` : ''}
        </div>
      </div>`;
    });
  }

  // â”€â”€ Settlements â”€â”€
  const settlements = [...(appData.settlements || [])].sort((a, b) => b.date.localeCompare(a.date));
  let histHtml = '';
  settlements.forEach(s => {
    const realIdx = appData.settlements.indexOf(s);
    histHtml += `<div class="settle-row">
      <div class="settle-row-icon">âœ…</div>
      <div class="settle-row-body">
        <div class="settle-row-desc">${_memberName(s.fromMember)} â†’ ${_memberName(s.toMember)}${s.note ? ` Â· ${s.note}` : ''}</div>
        <div class="settle-row-date">${formatDate(s.date)}</div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <span class="settle-row-amount">${_fmtAmt(s.amount, s.currency)}</span>
        <span onclick="deleteSettlement(${realIdx})" style="color:var(--danger);font-size:20px;padding:0 4px;cursor:pointer">Ã—</span>
      </div>
    </div>`;
  });

  return `
    ${summaryHtml}
    <div class="section-head">
      <span class="section-title">Outstanding Debts</span>
      ${myDebtCount > 0 ? `<label class="toggle-label"><input type="checkbox" id="split-my-only" onchange="toggleMyDebts(this.checked)"> Mine (${myDebtCount})</label>` : ''}
    </div>
    <div id="split-debts-container">${debtRowsHtml}</div>
    <div class="section-head" style="margin-top:14px">
      <span class="section-title">ğŸ’¸ Expenses</span>
      <div style="display:flex;gap:6px;align-items:center">
        <button class="settle-btn" onclick="addSettlement()" style="border-color:#4ade8040;color:var(--success)">Settle Up</button>
        <button class="btn-add" onclick="addExpense()">ï¼‹ Add</button>
      </div>
    </div>
    <div class="split-search-wrap">
      <span class="split-search-icon">ğŸ”</span>
      <input class="split-search-input" type="search" placeholder="Search expenses..." oninput="filterSplitExpenses(this.value)">
    </div>
    <div id="split-expenses-container">${expHtml}</div>
    ${histHtml ? `
    <div class="section-head" style="margin-top:8px">
      <span class="section-title">ğŸ¤ Settlements</span>
    </div>
    ${histHtml}` : ''}
  `;
}

// â”€â”€ Member self-registration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function promptMemberRegister() { openSheet('register-member'); }

function submitMemberRegister() {
  const name  = document.getElementById('f-member-name')?.value.trim();
  const phone = document.getElementById('f-member-phone')?.value.trim();
  if (!name)  { alert('Enter your name'); return; }
  if (!phone) { alert('Enter your phone / PayNow number â€” others need this to pay you back'); return; }
  if (!appData.members) appData.members = [];
  if (!appData.members.find(m => m.userId === userId)) {
    appData.members.push({ id: 'm_' + Date.now(), name, userId, phone });
  }
  saveData().then(() => { _closeSheet(); renderTab('split'); });
}

// â”€â”€ Expense CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _editExpenseIdx = -1;
let _splitType = 'equal';
let _splitSearch = '';
let _splitMyDebtsOnly = false;

function filterSplitExpenses(val) {
  _splitSearch = val.toLowerCase().trim();
  const container = document.getElementById('split-expenses-container');
  if (!container) return;
  container.querySelectorAll('.expense-row[data-title]').forEach(row => {
    row.style.display = row.dataset.title.includes(_splitSearch) ? '' : 'none';
  });
  container.querySelectorAll('.expense-date-group').forEach(hdr => {
    let next = hdr.nextElementSibling;
    let hasVisible = false;
    while (next && !next.classList.contains('expense-date-group')) {
      if (next.classList.contains('expense-row') && next.style.display !== 'none') hasVisible = true;
      next = next.nextElementSibling;
    }
    hdr.style.display = hasVisible ? '' : 'none';
  });
}

function toggleMyDebts(checked) {
  _splitMyDebtsOnly = checked;
  const myId = _myMember()?.id || '';
  const container = document.getElementById('split-debts-container');
  if (!container) return;
  container.querySelectorAll('.debt-row[data-from]').forEach(row => {
    const visible = !_splitMyDebtsOnly || row.dataset.from === myId || row.dataset.to === myId;
    row.style.display = visible ? '' : 'none';
  });
}

function addExpense()      { _editExpenseIdx = -1; _splitType = 'equal'; openSheet('expense-form'); }
function editExpense(i)    { _editExpenseIdx = i;  _splitType = (appData.expenses[i]?.splitType || 'equal'); openSheet('expense-form'); }

function deleteExpense(i) {
  if (!confirm(`Remove "${appData.expenses[i]?.title}"?`)) return;
  appData.expenses.splice(i, 1);
  saveData().then(() => { _closeSheet(); renderTab('split'); });
}

function setSplitType(type) {
  _splitType = type;
  document.querySelectorAll('.split-type-btn').forEach(b => b.classList.toggle('selected', b.dataset.type === type));
  renderSplitInputs();
}

function renderSplitInputs() {
  const container = document.getElementById('f-exp-splits-container');
  if (!container) return;
  const members  = appData.members || [];
  const amount   = parseFloat(document.getElementById('f-exp-amount')?.value) || 0;
  const count    = members.length || 1;
  const exp      = _editExpenseIdx >= 0 ? appData.expenses[_editExpenseIdx] : null;

  let html = '<div class="split-participants">';
  members.forEach(m => {
    const isIn = exp ? (exp.participants || []).includes(m.id) : true;
    let extra = '';
    const defaultShare = exp?.splits?.[m.id];
    if (_splitType === 'exact') {
      const val = defaultShare ?? (amount / count).toFixed(2);
      extra = `<input class="split-val-input" data-mid="${m.id}" type="number" step="0.01" value="${val}" style="width:80px;background:var(--card);border:1px solid var(--border2);border-radius:8px;padding:8px;color:var(--text);font-size:13px;text-align:right">`;
    } else if (_splitType === 'percent') {
      const val = defaultShare ? (defaultShare / amount * 100).toFixed(0) : Math.round(100 / count);
      extra = `<div style="display:flex;align-items:center;gap:4px"><input class="split-val-input" data-mid="${m.id}" type="number" step="1" min="0" max="100" value="${val}" style="width:55px;background:var(--card);border:1px solid var(--border2);border-radius:8px;padding:8px;color:var(--text);font-size:13px;text-align:right"><span style="color:var(--text3);font-size:12px">%</span></div>`;
    } else if (_splitType === 'shares') {
      extra = `<div style="display:flex;align-items:center;gap:4px"><input class="split-val-input" data-mid="${m.id}" type="number" step="1" min="1" value="1" style="width:55px;background:var(--card);border:1px solid var(--border2);border-radius:8px;padding:8px;color:var(--text);font-size:13px;text-align:right"><span style="color:var(--text3);font-size:12px">shares</span></div>`;
    } else {
      // equal â€” show computed amount read-only
      extra = `<span style="font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--text3)">${amount && count ? (amount/count).toFixed(2) : 'â€”'}</span>`;
    }
    html += `<div class="split-participant-row">
      <input type="checkbox" class="exp-participant-cb" data-member-id="${m.id}" ${isIn?'checked':''} onchange="renderSplitInputs()" style="width:18px;height:18px;accent-color:var(--gold);flex-shrink:0">
      <div class="member-avatar">${m.name.charAt(0).toUpperCase()}</div>
      <span style="flex:1;font-size:14px">${m.name}${m.userId===userId?' (you)':''}</span>
      ${extra}
    </div>`;
  });
  html += '</div>';
  container.innerHTML = html;
}

function computeSplitsFromForm(participants, amount) {
  const splits = {};
  if (_splitType === 'equal') {
    const share = amount / participants.length;
    participants.forEach(mid => { splits[mid] = parseFloat(share.toFixed(2)); });
    const diff = amount - Object.values(splits).reduce((a, b) => a + b, 0);
    if (Math.abs(diff) > 0.001 && participants[0]) splits[participants[0]] = parseFloat((splits[participants[0]] + diff).toFixed(2));
  } else if (_splitType === 'exact') {
    let total = 0;
    participants.forEach(mid => {
      const v = parseFloat(document.querySelector(`.split-val-input[data-mid="${mid}"]`)?.value || 0);
      splits[mid] = v; total += v;
    });
    if (Math.abs(total - amount) > 0.02) { alert(`Exact amounts must sum to ${amount} (currently ${total.toFixed(2)})`); return null; }
  } else if (_splitType === 'percent') {
    let totalPct = 0;
    participants.forEach(mid => {
      const pct = parseFloat(document.querySelector(`.split-val-input[data-mid="${mid}"]`)?.value || 0);
      splits[mid] = parseFloat((amount * pct / 100).toFixed(2));
      totalPct += pct;
    });
    if (Math.abs(totalPct - 100) > 1) { alert(`Percentages must sum to 100% (currently ${totalPct}%)`); return null; }
  } else if (_splitType === 'shares') {
    let totalShares = 0;
    const shareVals = {};
    participants.forEach(mid => {
      const s = parseFloat(document.querySelector(`.split-val-input[data-mid="${mid}"]`)?.value || 1);
      shareVals[mid] = s; totalShares += s;
    });
    participants.forEach(mid => { splits[mid] = parseFloat((amount * shareVals[mid] / totalShares).toFixed(2)); });
  }
  return splits;
}

function submitExpense() {
  const title    = document.getElementById('f-exp-title')?.value.trim();
  const amount   = parseFloat(document.getElementById('f-exp-amount')?.value);
  const currency = document.getElementById('f-exp-currency')?.value;
  const date     = document.getElementById('f-exp-date')?.value;
  const paidBy   = document.getElementById('f-exp-paidby')?.value;
  const category = document.getElementById('f-exp-category')?.value;
  const note     = document.getElementById('f-exp-note')?.value.trim() || '';

  if (!title || !amount || isNaN(amount) || !currency || !date || !paidBy) {
    alert('Title, amount, currency, date and payer are required'); return;
  }

  const participants = [];
  document.querySelectorAll('.exp-participant-cb:checked').forEach(cb => participants.push(cb.dataset.memberId));
  if (!participants.length) { alert('Select at least one participant'); return; }

  const splits = computeSplitsFromForm(participants, amount);
  if (!splits) return;

  const exp = {
    id:           _editExpenseIdx >= 0 ? appData.expenses[_editExpenseIdx].id : 'exp_' + Date.now(),
    title, amount, currency, date, paidBy, participants, splitType: _splitType, splits, category, note
  };

  if (_editExpenseIdx >= 0) appData.expenses[_editExpenseIdx] = exp;
  else appData.expenses.push(exp);
  saveData().then(() => { _closeSheet(); renderTab('split'); });
}

// â”€â”€ Settlement CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _editSettleIdx = -1;
let _prefillSettle = null;

function addSettlement()  { _prefillSettle = null; openSheet('settle-form'); }

function updateSettlePhoneInfo() {
  const toId  = document.getElementById('f-settle-to')?.value;
  const m     = (appData.members || []).find(m => m.id === toId);
  const box   = document.getElementById('settle-phone-info');
  if (!box) return;
  if (m?.phone) {
    box.innerHTML = `<span style="font-size:22px">ğŸ“±</span>
      <div>
        <div style="font-size:11px;color:var(--text3);margin-bottom:3px">Send payment to <strong style="color:var(--text2)">${m.name}</strong></div>
        <div style="font-size:16px;font-weight:600;color:var(--gold2);font-family:'JetBrains Mono',monospace;letter-spacing:0.5px">${m.phone}</div>
      </div>`;
    box.style.display = 'flex';
  } else {
    box.style.display = 'none';
  }
}

function quickSettle(fromId, toId, amount, currency) {
  _prefillSettle = { from: fromId, to: toId, amount, currency };
  openSheet('settle-form');
}

function deleteSettlement(i) {
  if (!confirm('Remove this settlement record?')) return;
  appData.settlements.splice(i, 1);
  saveData().then(() => { _closeSheet(); renderTab('split'); });
}

function submitSettlement() {
  const from     = document.getElementById('f-settle-from')?.value;
  const to       = document.getElementById('f-settle-to')?.value;
  const amount   = parseFloat(document.getElementById('f-settle-amount')?.value);
  const currency = document.getElementById('f-settle-currency')?.value;
  const date     = document.getElementById('f-settle-date')?.value;
  const note     = document.getElementById('f-settle-note')?.value.trim() || '';

  if (!from || !to || !amount || isNaN(amount) || !currency || !date) { alert('All fields except note are required'); return; }
  if (from === to) { alert('Payer and receiver must be different'); return; }

  appData.settlements.push({ id: 'settle_' + Date.now(), date, fromMember: from, toMember: to, amount, currency, note });
  saveData().then(() => { _closeSheet(); renderTab('split'); });
}

// â”€â”€ Currency settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openCurrencySettings() { openSheet('currency-settings'); }

function addRateRow() {
  const container = document.getElementById('rate-rows');
  if (!container) return;
  const base = appData.tripCurrency?.base || 'SGD';
  const div = document.createElement('div');
  div.className = 'rate-row';
  div.innerHTML = `
    <span style="color:var(--text3);font-size:12px">1</span>
    <input class="rate-code" placeholder="EUR" style="width:65px;background:var(--card);border:1px solid var(--border2);border-radius:8px;padding:10px;color:var(--text);font-size:13px;text-transform:uppercase" autocomplete="off">
    <span style="color:var(--text3);font-size:12px">=</span>
    <input class="rate-val" type="number" step="0.0001" placeholder="0.29" style="flex:1;background:var(--card);border:1px solid var(--border2);border-radius:8px;padding:10px;color:var(--text);font-size:13px">
    <span style="color:var(--text3);font-size:12px">${base}</span>
    <span onclick="this.parentElement.remove()" style="color:var(--danger);cursor:pointer;font-size:20px;padding:0 4px;line-height:1">Ã—</span>`;
  container.appendChild(div);
}

function submitCurrencySettings() {
  const base = document.getElementById('f-base-currency')?.value.trim().toUpperCase();
  if (!base) { alert('Base currency code required'); return; }
  const rates = {};
  document.querySelectorAll('.rate-row').forEach(row => {
    const code = row.querySelector('.rate-code')?.value.trim().toUpperCase();
    const val  = parseFloat(row.querySelector('.rate-val')?.value);
    if (code && !isNaN(val) && val > 0) rates[code] = val;
  });
  appData.tripCurrency = { base, rates };
  saveData().then(() => { _closeSheet(); renderTab('split'); });
}

// â”€â”€ Member management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openManageMembers() { openSheet('manage-members'); }

function submitManualMember() {
  const name  = document.getElementById('f-manual-name')?.value.trim();
  const phone = document.getElementById('f-manual-phone')?.value.trim();
  if (!name) { alert('Name required'); return; }
  if (!appData.members) appData.members = [];
  appData.members.push({ id: 'm_' + Date.now(), name, userId: null, phone: phone || '' });
  saveData().then(() => {
    document.getElementById('sheet-inner').innerHTML = sheetContent('manage-members');
  });
}

function deleteMember(i) {
  const m = appData.members[i];
  if (!confirm(`Remove "${m.name}" from the split?`)) return;
  appData.members.splice(i, 1);
  saveData().then(() => {
    document.getElementById('sheet-inner').innerHTML = sheetContent('manage-members');
  });
}

// â”€â”€ Start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();
</script>
</body>
</html>
