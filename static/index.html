<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Trip Planner</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  /* â”€â”€ Reset & Base â”€â”€ */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  
  :root {
    --bg:       #080b11;
    --surface:  #10151e;
    --card:     #161d2b;
    --card2:    #1c2538;
    --border:   #222d42;
    --border2:  #2a3650;
    --gold:     #c8912a;
    --gold2:    #e8b84b;
    --gold-dim: #c8912a33;
    --text:     #eef2f8;
    --text2:    #8898b8;
    --text3:    #4d5f80;
    --danger:   #e05555;
    --success:  #4ade80;
    --tab-h:    64px;
    --safe-b:   env(safe-area-inset-bottom, 0px);
  }

  html, body {
    height: 100%;
    overflow: hidden;
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    -webkit-font-smoothing: antialiased;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
  }

  /* â”€â”€ Layout â”€â”€ */
  #app {
    display: flex;
    flex-direction: column;
    height: 100vh;
    height: 100dvh;
  }

  /* Mountain header background */
  #header {
    position: relative;
    padding: 20px 20px 16px;
    background: linear-gradient(180deg, #0d1520 0%, var(--bg) 100%);
    flex-shrink: 0;
    overflow: hidden;
  }
  #header::before {
    content: '';
    position: absolute;
    inset: 0;
    background: 
      radial-gradient(ellipse 80% 60% at 50% -10%, #c8912a18 0%, transparent 70%);
    pointer-events: none;
  }
  /* SVG mountain silhouette */
  .mountain-bg {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 40px;
    opacity: 0.12;
  }

  .trip-name {
    font-family: 'Syne', sans-serif;
    font-size: 22px;
    font-weight: 800;
    letter-spacing: -0.5px;
    color: var(--text);
    position: relative;
  }
  .trip-dates {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: var(--gold2);
    margin-top: 3px;
    letter-spacing: 0.5px;
    position: relative;
  }

  /* â”€â”€ Tabs â”€â”€ */
  #tabs {
    display: flex;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  .tab {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 3px;
    padding: 10px 4px;
    cursor: pointer;
    transition: color 0.15s;
    color: var(--text3);
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 0.3px;
    text-transform: uppercase;
    border-bottom: 2px solid transparent;
  }
  .tab.active {
    color: var(--gold2);
    border-bottom-color: var(--gold);
  }
  .tab-icon { font-size: 18px; line-height: 1; }

  /* â”€â”€ Content area â”€â”€ */
  #content {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
    padding: 16px 16px calc(var(--safe-b) + 16px);
  }
  #content::-webkit-scrollbar { display: none; }

  /* â”€â”€ Cards â”€â”€ */
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    margin-bottom: 10px;
    overflow: hidden;
  }
  .card-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 16px;
    cursor: pointer;
  }
  .card-header:active { opacity: 0.7; }
  .card-emoji {
    font-size: 22px;
    width: 36px;
    text-align: center;
    flex-shrink: 0;
  }
  .card-title-group { flex: 1; min-width: 0; }
  .card-title {
    font-family: 'Syne', sans-serif;
    font-size: 15px;
    font-weight: 700;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .card-sub {
    font-size: 12px;
    color: var(--text2);
    margin-top: 1px;
  }
  .card-chevron {
    color: var(--text3);
    font-size: 18px;
    transition: transform 0.2s;
    flex-shrink: 0;
  }
  .card.open .card-chevron { transform: rotate(90deg); }
  .card-body {
    display: none;
    border-top: 1px solid var(--border);
  }
  .card.open .card-body { display: block; }

  /* â”€â”€ Stops â”€â”€ */
  .stop {
    display: flex;
    gap: 12px;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    position: relative;
  }
  .stop:last-child { border-bottom: none; }
  .stop::before {
    content: '';
    position: absolute;
    left: 36px;
    top: 0; bottom: 0;
    width: 1px;
    background: var(--border);
  }
  .stop:first-child::before { top: 50%; }
  .stop:last-child::before { bottom: 50%; }
  .stop-time {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: var(--gold);
    min-width: 44px;
    padding-top: 1px;
    text-align: right;
    flex-shrink: 0;
  }
  .stop-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--border2);
    border: 2px solid var(--gold);
    margin-top: 4px;
    flex-shrink: 0;
  }
  .stop-content { flex: 1; min-width: 0; }
  .stop-name {
    font-size: 14px;
    font-weight: 500;
    color: var(--text);
    line-height: 1.3;
  }
  .stop-note {
    font-size: 12px;
    color: var(--text2);
    margin-top: 2px;
    line-height: 1.4;
  }

  /* â”€â”€ Accom cards â”€â”€ */
  .accom-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 14px 16px;
    margin-bottom: 10px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .accom-name {
    font-family: 'Syne', sans-serif;
    font-size: 15px;
    font-weight: 700;
  }
  .accom-meta {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .badge {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    background: var(--gold-dim);
    color: var(--gold2);
    padding: 2px 8px;
    border-radius: 20px;
    border: 1px solid var(--gold)33;
    letter-spacing: 0.3px;
  }
  .accom-notes {
    font-size: 12px;
    color: var(--text2);
  }
  .accom-link {
    display: flex;
    align-items: center;
    gap: 6px;
    background: var(--card2);
    border: 1px solid var(--border2);
    border-radius: 8px;
    padding: 8px 12px;
    text-decoration: none;
    color: var(--gold2);
    font-size: 13px;
    font-weight: 500;
    margin-top: 2px;
  }
  .accom-link:active { opacity: 0.7; }

  /* â”€â”€ Link rows â”€â”€ */
  .link-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 14px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    margin-bottom: 8px;
    text-decoration: none;
    color: var(--text);
    cursor: pointer;
  }
  .link-row:active { opacity: 0.7; }
  .link-row-icon { font-size: 18px; flex-shrink: 0; }
  .link-row-content { flex: 1; min-width: 0; }
  .link-row-name {
    font-size: 14px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .link-row-sub { font-size: 11px; color: var(--text2); margin-top: 1px; }
  .link-arrow { color: var(--text3); font-size: 16px; }

  /* â”€â”€ Section headings â”€â”€ */
  .section-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
    margin-top: 4px;
  }
  .section-title {
    font-family: 'Syne', sans-serif;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text3);
  }

  /* â”€â”€ Add button â”€â”€ */
  .btn-add {
    display: flex;
    align-items: center;
    gap: 6px;
    background: var(--gold-dim);
    border: 1px solid var(--gold)55;
    color: var(--gold2);
    border-radius: 8px;
    padding: 5px 12px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
  }
  .btn-add:active { opacity: 0.7; }

  /* â”€â”€ Empty state â”€â”€ */
  .empty {
    text-align: center;
    padding: 40px 20px;
    color: var(--text3);
  }
  .empty-icon { font-size: 36px; margin-bottom: 12px; }
  .empty-text { font-size: 14px; line-height: 1.5; }

  /* â”€â”€ Checklist â”€â”€ */
  .checklist-group { margin-bottom: 20px; }
  .checklist-group-title {
    font-family: 'Syne', sans-serif;
    font-size: 13px;
    font-weight: 700;
    color: var(--gold2);
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .checklist-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: opacity 0.15s;
  }
  .checklist-item:last-child { border-bottom: none; }
  .checklist-item.done { opacity: 0.45; }
  .check-box {
    width: 20px; height: 20px;
    border-radius: 6px;
    border: 2px solid var(--border2);
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    transition: all 0.15s;
  }
  .checklist-item.done .check-box {
    background: var(--gold);
    border-color: var(--gold);
  }
  .check-tick { color: #000; font-size: 12px; font-weight: 800; display: none; }
  .checklist-item.done .check-tick { display: block; }
  .check-label { font-size: 14px; }

  /* â”€â”€ Emergency â”€â”€ */
  .emergency-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px 16px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .emergency-name { font-size: 14px; font-weight: 500; }
  .emergency-number {
    font-family: 'JetBrains Mono', monospace;
    font-size: 16px;
    font-weight: 500;
    color: var(--gold2);
    text-decoration: none;
  }
  .emergency-card.primary { border-color: var(--danger)66; background: #e0555511; }
  .emergency-card.primary .emergency-number { color: var(--danger); font-size: 20px; }

  /* â”€â”€ Modal / Sheet â”€â”€ */
  #sheet-overlay {
    position: fixed; inset: 0;
    background: #00000088;
    z-index: 100;
    display: none;
    align-items: flex-end;
  }
  #sheet-overlay.open { display: flex; }
  #sheet {
    background: var(--surface);
    border-radius: 20px 20px 0 0;
    padding: 0 0 calc(var(--safe-b) + 20px);
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
  }
  #sheet-overlay.open #sheet { transform: translateY(0); }
  .sheet-handle {
    width: 36px; height: 4px;
    background: var(--border2);
    border-radius: 2px;
    margin: 12px auto 0;
  }
  .sheet-title {
    font-family: 'Syne', sans-serif;
    font-size: 18px;
    font-weight: 800;
    padding: 16px 20px 4px;
  }
  .sheet-sub {
    font-size: 13px;
    color: var(--text2);
    padding: 0 20px 16px;
  }
  .sheet-body { padding: 0 20px; }

  /* â”€â”€ Form elements â”€â”€ */
  .field { margin-bottom: 16px; }
  .field label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--text2);
    letter-spacing: 0.5px;
    text-transform: uppercase;
    margin-bottom: 6px;
  }
  .field input, .field textarea, .field select {
    width: 100%;
    background: var(--card);
    border: 1px solid var(--border2);
    border-radius: 10px;
    padding: 12px 14px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    outline: none;
    -webkit-appearance: none;
    appearance: none;
  }
  .field input:focus, .field textarea:focus {
    border-color: var(--gold);
    box-shadow: 0 0 0 3px var(--gold-dim);
  }
  .field textarea { resize: none; height: 80px; }
  .field select { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%238898b8' stroke-width='1.5' fill='none'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 14px center; padding-right: 36px; }
  ::placeholder { color: var(--text3); }
  input[type=color]    { height: 44px; padding: 4px 8px; cursor: pointer; }
  input[type=checkbox] { width: 16px; height: 16px; accent-color: var(--gold); cursor: pointer; flex-shrink: 0; }
  input[type=date], input[type=time] { color-scheme: dark; }
  .custom-check { display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none; }
  .custom-check.checked .check-box { background: var(--gold); border-color: var(--gold); }
  .custom-check.checked .check-tick { display: block; }

  .btn-primary {
    width: 100%;
    background: var(--gold);
    color: #000;
    border: none;
    border-radius: 12px;
    padding: 14px;
    font-family: 'Syne', sans-serif;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    margin-top: 8px;
    margin-bottom: 8px;
  }
  .btn-primary:active { opacity: 0.8; }
  .btn-secondary {
    width: 100%;
    background: transparent;
    color: var(--text2);
    border: 1px solid var(--border2);
    border-radius: 12px;
    padding: 12px;
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    cursor: pointer;
    margin-bottom: 8px;
  }
  .btn-danger {
    background: #e0555522;
    color: var(--danger);
    border-color: var(--danger)44;
  }

  /* â”€â”€ Day selector â”€â”€ */
  .day-selector {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 16px;
  }
  .day-opt {
    background: var(--card);
    border: 1px solid var(--border2);
    border-radius: 10px;
    padding: 10px 12px;
    cursor: pointer;
    text-align: center;
    transition: all 0.15s;
  }
  .day-opt.selected {
    background: var(--gold-dim);
    border-color: var(--gold);
    color: var(--gold2);
  }
  .day-opt-emoji { font-size: 18px; }
  .day-opt-label { font-size: 12px; font-weight: 600; margin-top: 4px; }

  /* â”€â”€ Delete swipe reveal â”€â”€ */
  .deletable {
    position: relative;
    overflow: hidden;
  }
  .delete-btn {
    position: absolute;
    right: 0; top: 0; bottom: 0;
    background: var(--danger);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 16px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transform: translateX(100%);
    transition: transform 0.2s;
    border-radius: 0 12px 12px 0;
  }
  .deletable.reveal .delete-btn { transform: translateX(0); }

  /* â”€â”€ Weather section â”€â”€ */
  .weather-note {
    font-size: 12px;
    color: var(--text3);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  /* â”€â”€ Edit section â”€â”€ */
  .edit-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 16px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    margin-bottom: 8px;
    cursor: pointer;
  }
  .edit-row:active { opacity: 0.7; }
  .edit-row-label { font-size: 14px; font-weight: 500; }
  .edit-row-value { font-size: 13px; color: var(--text2); max-width: 55%; text-align: right; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

  /* â”€â”€ Spinner â”€â”€ */
  .spinner {
    width: 24px; height: 24px;
    border: 2px solid var(--border2);
    border-top-color: var(--gold);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
    margin: 40px auto;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* â”€â”€ Live weather cards â”€â”€ */
  .wx-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    overflow: hidden;
    margin-bottom: 10px;
  }
  .wx-header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    padding: 12px 14px 8px;
    border-bottom: 1px solid var(--border);
  }
  .wx-loc-name { font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700; }
  .wx-loc-tag  { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--gold2); }
  .wx-day-row  {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
  }
  .wx-day-row:last-child { border-bottom: none; }
  .wx-day-label { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text3); min-width: 44px; flex-shrink: 0; }
  .wx-icon  { font-size: 20px; flex-shrink: 0; }
  .wx-mid   { flex: 1; min-width: 0; }
  .wx-cond  { font-size: 13px; font-weight: 500; }
  .wx-meta  { font-size: 11px; color: var(--text2); margin-top: 2px; }
  .wx-temps { text-align: right; flex-shrink: 0; }
  .wx-hi    { font-family: 'JetBrains Mono', monospace; font-size: 15px; color: var(--text); }
  .wx-lo    { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text3); }

  /* â”€â”€ Animations â”€â”€ */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .tab-content { animation: fadeIn 0.2s ease; }

  /* â”€â”€ Add-stop row inside day card â”€â”€ */
  .add-stop-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 11px 16px;
    color: var(--text3);
    font-size: 13px;
    cursor: pointer;
    border-top: 1px solid var(--border);
    transition: color 0.15s;
  }
  .add-stop-row:active { color: var(--gold2); }

</style>
</head>
<body>
<div id="app">
  <!-- Header -->
  <div id="header">
    <svg class="mountain-bg" viewBox="0 0 400 40" preserveAspectRatio="none" fill="white">
      <path d="M0 40 L40 15 L80 28 L130 5 L175 22 L220 8 L265 20 L310 2 L355 18 L400 10 L400 40 Z"/>
    </svg>
    <div class="trip-name" id="trip-name">Loading...</div>
    <div class="trip-dates" id="trip-dates"></div>
  </div>

  <!-- Tab bar -->
  <div id="tabs">
    <div class="tab active" data-tab="itinerary" onclick="switchTab('itinerary')">
      <span class="tab-icon">ğŸ—“</span>Plan
    </div>
    <div class="tab" data-tab="accoms" onclick="switchTab('accoms')">
      <span class="tab-icon">ğŸ¨</span>Stay
    </div>
    <div class="tab" data-tab="weather" onclick="switchTab('weather')">
      <span class="tab-icon">ğŸŒ¤</span>Weather
    </div>
    <div class="tab" data-tab="links" onclick="switchTab('links')">
      <span class="tab-icon">ğŸ”—</span>Links
    </div>
    <div class="tab" data-tab="more" onclick="switchTab('more')">
      <span class="tab-icon">â‹¯</span>More
    </div>
  </div>

  <!-- Content -->
  <div id="content">
    <div class="spinner" id="loading-spinner"></div>
  </div>
</div>

<!-- Bottom Sheet -->
<div id="sheet-overlay" onclick="closeSheet(event)">
  <div id="sheet">
    <div class="sheet-handle"></div>
    <div id="sheet-inner"></div>
  </div>
</div>

<script>
const tg = window.Telegram?.WebApp;
if (tg) { tg.expand(); tg.ready(); }

const userId = tg?.initDataUnsafe?.user?.id || null;

let appData = null;
let isAdmin = false;
let activeTab = 'itinerary';
let checkedItems = JSON.parse(localStorage.getItem('checked') || '{}');

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  try {
    const [dataRes, adminRes] = await Promise.all([
      fetch('/api/data').then(r => r.json()),
      userId ? fetch(`/api/is_admin?user_id=${userId}`).then(r => r.json()) : Promise.resolve({is_admin: false})
    ]);
    appData = dataRes;
    isAdmin = adminRes.is_admin;
    document.getElementById('trip-name').textContent = appData.trip.name;
    document.getElementById('trip-dates').textContent = appData.trip.dates;
    document.getElementById('loading-spinner').remove();
    renderTab('itinerary');
  } catch(e) {
    document.getElementById('content').innerHTML = `<div class="empty"><div class="empty-icon">âš ï¸</div><div class="empty-text">Could not load trip data.<br>Pull to refresh.</div></div>`;
  }
}

async function saveData() {
  await fetch('/api/data', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(appData)
  });
}

// â”€â”€ Tab navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  activeTab = tab;
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  renderTab(tab);
}

function renderTab(tab) {
  const el = document.getElementById('content');
  el.innerHTML = '';
  const div = document.createElement('div');
  div.className = 'tab-content';
  switch(tab) {
    case 'itinerary': div.innerHTML = renderItinerary(); break;
    case 'accoms':    div.innerHTML = renderAccoms(); break;
    case 'weather':   div.innerHTML = renderWeather(); break;
    case 'links':     div.innerHTML = renderLinks(); break;
    case 'more':      div.innerHTML = renderMore(); break;
  }
  el.appendChild(div);
}

// â”€â”€ Itinerary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderItinerary() {
  let html = `<div class="section-head">
    <span class="section-title">Itinerary</span>
    <div style="display:flex;gap:6px">
      <button class="btn-add" onclick="openSheet('maps-view')">ğŸ“ Map</button>
      ${isAdmin ? `<button class="btn-add" onclick="addDay()">ï¼‹ Day</button>` : ''}
    </div>
  </div>`;
  if (!appData.days.length) {
    html += `<div class="empty"><div class="empty-icon">ğŸ—“</div><div class="empty-text">No days yet.<br>${isAdmin ? 'Tap <strong>+ Day</strong> to get started.' : ''}</div></div>`;
    return html;
  }
  appData.days.forEach((day, di) => {
    const stopCount = day.stops.length;
    html += `
    <div class="card" id="day-${day.id}">
      <div class="card-header" onclick="toggleCard('day-${day.id}')">
        <div class="card-emoji">${day.emoji}</div>
        <div class="card-title-group">
          <div class="card-title">${day.label}</div>
          <div class="card-sub">${day.title}${stopCount ? ` Â· ${stopCount} stop${stopCount!==1?'s':''}` : ''}</div>
        </div>
        ${isAdmin ? `<div onclick="event.stopPropagation();editDay(${di})" style="color:var(--text3);font-size:15px;cursor:pointer;padding:4px 8px;flex-shrink:0">âœï¸</div>` : ''}
        <div class="card-chevron">â€º</div>
      </div>
      <div class="card-body">`;
    if (day.description) {
      html += `<div style="padding:10px 16px 6px;font-size:13px;color:var(--text2);line-height:1.5;border-bottom:1px solid var(--border)">${day.description}</div>`;
    }
    day.stops.forEach((stop, si) => {
      html += `
        <div class="stop" ${isAdmin ? `onclick="editStop(${di},${si})" style="cursor:pointer"` : ''}>
          <div class="stop-time">${stop.time || 'â€”'}</div>
          <div class="stop-dot"></div>
          <div class="stop-content">
            <div class="stop-name">${stop.name}</div>
            ${stop.note ? `<div class="stop-note">${stop.note}</div>` : ''}
          </div>
          ${stop.mapsUrl ? `<a href="${stop.mapsUrl}" target="_blank" onclick="event.stopPropagation()" style="color:var(--gold2);font-size:16px;text-decoration:none;padding:2px 6px;flex-shrink:0">ğŸ“</a>` : ''}
        </div>`;
    });
    if (isAdmin) {
      html += `<div class="add-stop-row" onclick="addStop(${di})"><span style="font-size:16px">ï¼‹</span> Add stop</div>`;
    }
    html += `</div></div>`;
  });
  return html;
}

function toggleCard(id) {
  document.getElementById(id)?.classList.toggle('open');
}

// â”€â”€ Day CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _editDayIdx = -1;

function addDay() { _editDayIdx = -1; openSheet('day-form'); }
function editDay(di) { _editDayIdx = di; openSheet('day-form'); }

function deleteDay(di) {
  if (!confirm(`Remove day "${appData.days[di].label}" and all its stops?`)) return;
  appData.days.splice(di, 1);
  saveData().then(() => { _closeSheet(); renderTab('itinerary'); });
}

function submitDay() {
  const title = document.getElementById('f-daytitle')?.value.trim();
  const emoji = document.getElementById('f-dayemoji')?.value.trim() || 'ğŸ“';
  const date  = document.getElementById('f-daydate')?.value;
  const description = document.getElementById('f-daydesc')?.value.trim() || '';
  if (!title || !date) { alert('Title and date are required'); return; }
  const dt = new Date(date + 'T12:00:00');
  const label = dt.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
  if (_editDayIdx >= 0) {
    appData.days[_editDayIdx] = { ...appData.days[_editDayIdx], label, title, emoji, date, description };
  } else {
    appData.days.push({ id: `day-${Date.now()}`, label, title, emoji, date, description, stops: [] });
  }
  appData.days.sort((a, b) => (a.date || '').localeCompare(b.date || ''));
  saveData().then(() => { _closeSheet(); renderTab('itinerary'); });
}

// â”€â”€ Stop CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _editStopDayIdx = -1;
let _editStopIdx    = -1;

function addStop(di)      { _editStopDayIdx = di; _editStopIdx = -1; openSheet('stop-form'); }
function editStop(di, si) { _editStopDayIdx = di; _editStopIdx = si; openSheet('stop-form'); }

function deleteStop(di, si) {
  if (!confirm(`Remove "${appData.days[di].stops[si].name}"?`)) return;
  appData.days[di].stops.splice(si, 1);
  saveData().then(() => { _closeSheet(); renderTab('itinerary'); });
}

// â”€â”€ Accommodations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _editAccomIdx = -1;

function addAccom()    { _editAccomIdx = -1; openSheet('add-accom'); }
function editAccom(i)  { _editAccomIdx = i;  openSheet('add-accom'); }

function deleteAccom(i) {
  if (!confirm(`Remove "${appData.accoms[i].name}"?`)) return;
  appData.accoms.splice(i, 1);
  saveData().then(() => { _closeSheet(); renderTab('accoms'); });
}

function renderAccoms() {
  let html = `<div class="section-head"><span class="section-title">Accommodation</span>${isAdmin ? `<button class="btn-add" onclick="addAccom()">ï¼‹ Add</button>` : ''}</div>`;
  if (!appData.accoms.length) {
    html += `<div class="empty"><div class="empty-icon">ğŸ¨</div><div class="empty-text">No bookings yet.<br>${isAdmin ? 'Tap <strong>+ Add</strong> to add your first booking.' : 'Admin will add bookings here.'}</div></div>`;
    return html;
  }
  appData.accoms.forEach((a, i) => {
    html += `
    <div class="accom-card">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:8px">
        <div class="accom-name">${a.name}</div>
        ${isAdmin ? `<div onclick="editAccom(${i})" style="color:var(--text3);font-size:15px;cursor:pointer;padding:2px 4px;flex-shrink:0">âœï¸</div>` : ''}
      </div>
      <div class="accom-meta">
        ${a.day ? `<span class="badge">ğŸ“… ${a.day}</span>` : ''}
        ${a.notes ? `<span class="badge">ğŸ“ ${a.notes}</span>` : ''}
      </div>
      <a class="accom-link" href="${a.url}" target="_blank">ğŸ”— Open booking â†—</a>
      ${a.mapsUrl ? `<a class="accom-link" href="${a.mapsUrl}" target="_blank">ğŸ“ Open in Maps â†—</a>` : ''}
    </div>`;
  });
  return html;
}

// â”€â”€ Weather â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function wmoInfo(code) {
  if (code === 0)   return { e: 'â˜€ï¸', label: 'Clear sky' };
  if (code <= 1)    return { e: 'ğŸŒ¤', label: 'Mainly clear' };
  if (code <= 2)    return { e: 'â›…', label: 'Partly cloudy' };
  if (code <= 3)    return { e: 'â˜ï¸', label: 'Overcast' };
  if (code <= 48)   return { e: 'ğŸŒ«', label: 'Fog' };
  if (code <= 55)   return { e: 'ğŸŒ¦', label: 'Drizzle' };
  if (code <= 67)   return { e: 'ğŸŒ§', label: 'Rain' };
  if (code <= 77)   return { e: 'â„ï¸', label: 'Snow' };
  if (code <= 82)   return { e: 'ğŸŒ¦', label: 'Showers' };
  if (code <= 86)   return { e: 'ğŸŒ¨', label: 'Snow showers' };
  return                  { e: 'â›ˆ', label: 'Thunderstorm' };
}

function datesInRange(from, to) {
  const dates = [];
  let d = new Date(from + 'T12:00:00');
  const end = new Date((to || from) + 'T12:00:00');
  while (d <= end) { dates.push(d.toISOString().split('T')[0]); d.setDate(d.getDate() + 1); }
  return dates;
}

async function loadLiveWeather() {
  const el = document.getElementById('live-weather');
  if (!el) return;
  const locations = appData.wxLocations || [];
  if (!locations.length) {
    el.innerHTML = `<div style="text-align:center;padding:20px;color:var(--text3);font-size:13px">No locations added${isAdmin ? '. Tap <strong style="color:var(--text2)">+ Add</strong> above.' : '.'}</div>`;
    return;
  }
  try {
    const results = await Promise.all(locations.map(loc =>
      fetch(`https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,precipitation_sum,weather_code,wind_speed_10m_max,snowfall_sum&timezone=Europe%2FMadrid&wind_speed_unit=kmh&forecast_days=14`)
        .then(r => r.json())
    ));
    let html = '';
    locations.forEach((loc, li) => {
      const d = results[li].daily;
      const dates = datesInRange(loc.dateFrom, loc.dateTo);
      html += `<div class="wx-card">
        <div class="wx-header">
          <span class="wx-loc-name">${loc.name}</span>
          <div style="display:flex;align-items:center;gap:10px">
            ${loc.tag ? `<span class="wx-loc-tag">${loc.tag}</span>` : ''}
            ${isAdmin ? `<span onclick="editWxLoc(${li})" style="color:var(--text3);font-size:14px;cursor:pointer;padding:2px 4px">âœï¸</span>` : ''}
          </div>
        </div>`;
      dates.forEach(dateStr => {
        const idx = d.time.indexOf(dateStr);
        const day = new Date(dateStr + 'T12:00:00').toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric' });
        if (idx === -1) {
          html += `<div class="wx-day-row"><span class="wx-day-label">${day}</span><span style="color:var(--text3);font-size:12px">Outside forecast range</span></div>`;
          return;
        }
        const { e, label } = wmoInfo(d.weather_code[idx]);
        const hi    = Math.round(d.temperature_2m_max[idx]);
        const lo    = Math.round(d.temperature_2m_min[idx]);
        const precP = d.precipitation_probability_max[idx];
        const precM = d.precipitation_sum[idx];
        const wind  = Math.round(d.wind_speed_10m_max[idx]);
        const snow  = d.snowfall_sum[idx];
        let meta = `ğŸ’§ ${precP}%`;
        if (precM > 0) meta += ` Â· ${precM.toFixed(1)}mm`;
        if (loc.wind) meta += ` Â· ğŸ’¨ ${wind} km/h`;
        if (loc.snow) meta += snow > 0 ? ` Â· â„ï¸ ${snow}cm new` : ` Â· â„ï¸ no new snow`;
        html += `<div class="wx-day-row">
          <span class="wx-day-label">${day}</span>
          <span class="wx-icon">${e}</span>
          <div class="wx-mid"><div class="wx-cond">${label}</div><div class="wx-meta">${meta}</div></div>
          <div class="wx-temps"><div class="wx-hi">${hi}Â°</div><div class="wx-lo">${lo}Â°</div></div>
        </div>`;
      });
      if (loc.forecastUrl) {
        html += `<a href="${loc.forecastUrl}" target="_blank" style="display:flex;align-items:center;gap:8px;padding:9px 14px;border-top:1px solid var(--border);color:var(--text3);font-size:11px;text-decoration:none;font-family:'JetBrains Mono',monospace;letter-spacing:0.3px">
          <span style="flex:1">${loc.forecastName || 'Detailed forecast'}</span><span>â†—</span>
        </a>`;
      }
      html += '</div>';
    });
    el.innerHTML = html;
  } catch(err) {
    el.innerHTML = '<div style="color:var(--text3);font-size:13px;text-align:center;padding:16px">Could not load live weather</div>';
  }
}

function renderWeather() {
  const html = `
    <div class="section-head"><span class="section-title">Live Weather</span>${isAdmin ? `<button class="btn-add" onclick="addWxLoc()">ï¼‹ Add</button>` : ''}</div>
    <div class="weather-note">âš ï¸ Check forecasts the morning of each activity</div>
    <div id="live-weather"><div class="spinner" style="margin:20px auto"></div></div>`;
  setTimeout(loadLiveWeather, 0);
  return html;
}

function deleteWeather(i) {
  if (!confirm(`Remove "${appData.weather[i].name}"?`)) return;
  appData.weather.splice(i, 1);
  saveData().then(() => renderTab('weather'));
}

// â”€â”€ Live weather location CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _wxLocGeo = null;
let _wxLocEditIdx = -1;

function addWxLoc() {
  _wxLocEditIdx = -1;
  _wxLocGeo = null;
  openSheet('wx-loc-form');
}

function editWxLoc(i) {
  _wxLocEditIdx = i;
  _wxLocGeo = null;
  openSheet('wx-loc-form');
}

function deleteWxLoc(i) {
  if (!confirm(`Remove "${appData.wxLocations[i].name}"?`)) return;
  appData.wxLocations.splice(i, 1);
  saveData().then(() => { _closeSheet(); renderTab('weather'); });
}

async function searchWxPlace() {
  const q = document.getElementById('f-wxplace')?.value.trim();
  if (!q) return;
  const res = document.getElementById('wx-geo-result');
  res.textContent = 'Searchingâ€¦';
  res.style.color = 'var(--text3)';
  try {
    const data = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=1&language=en`).then(r => r.json());
    if (!data.results?.length) { res.textContent = 'Place not found'; res.style.color = 'var(--danger)'; _wxLocGeo = null; return; }
    const p = data.results[0];
    _wxLocGeo = { lat: p.latitude, lon: p.longitude };
    res.innerHTML = `âœ“ ${p.name}${p.admin1 ? ', ' + p.admin1 : ''}${p.country_code ? ', ' + p.country_code : ''} <span style="color:var(--text3)">(${p.latitude.toFixed(4)}, ${p.longitude.toFixed(4)})</span>`;
    res.style.color = 'var(--success)';
  } catch(e) {
    res.textContent = 'Search failed'; res.style.color = 'var(--danger)'; _wxLocGeo = null;
  }
}

function updateWxTag() { /* tag auto-generated on submit */ }

async function submitWxLoc() {
  const name = document.getElementById('f-wxname')?.value.trim();
  const from = document.getElementById('f-wxfrom')?.value;
  const to   = document.getElementById('f-wxto')?.value || from;
  const wind = document.getElementById('f-wxwind')?.classList.contains('checked') || false;
  const snow = document.getElementById('f-wxsnow')?.classList.contains('checked') || false;
  const _d1 = from ? new Date(from + 'T12:00:00') : null;
  const _d2 = (to && to !== from) ? new Date(to + 'T12:00:00') : null;
  const _s  = d => d.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric' });
  const tag  = _d1 ? ((_d2 && _d2 > _d1) ? _s(_d1) + 'â€“' + _s(_d2) : _s(_d1)) : '';
  if (!name || !from) { alert('Name and start date are required'); return; }
  let lat, lon;
  if (_wxLocGeo) {
    lat = _wxLocGeo.lat; lon = _wxLocGeo.lon;
  } else if (_wxLocEditIdx >= 0 && appData.wxLocations?.[_wxLocEditIdx]) {
    lat = appData.wxLocations[_wxLocEditIdx].lat;
    lon = appData.wxLocations[_wxLocEditIdx].lon;
  } else {
    alert('Please search for a location first'); return;
  }
  let forecastUrl  = document.getElementById('f-wxforecasturl')?.value.trim() || '';
  if (forecastUrl && !forecastUrl.match(/^https?:\/\//i)) forecastUrl = 'https://' + forecastUrl;
  const forecastName = document.getElementById('f-wxforecastname')?.value.trim() || '';
  const loc = { name, tag, lat, lon, dateFrom: from, dateTo: to, wind, snow, forecastUrl, forecastName };
  if (!appData.wxLocations) appData.wxLocations = [];
  if (_wxLocEditIdx >= 0) appData.wxLocations[_wxLocEditIdx] = loc;
  else appData.wxLocations.push(loc);
  saveData().then(() => { _closeSheet(); renderTab('weather'); });
}

// â”€â”€ Links â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLinks() {
  const cats = {trail: {label: 'Trail Status', icon: 'ğŸ¥¾'}, booking: {label: 'Bookings', icon: 'ğŸ«'}, other: {label: 'Other', icon: 'ğŸ“Œ'}};
  let html = `<div class="section-head"><span class="section-title">Key Links</span>${isAdmin ? `<button class="btn-add" onclick="openSheet('add-link')">ï¼‹ Add</button>` : ''}</div>`;
  
  Object.entries(cats).forEach(([cat, {label, icon}]) => {
    const items = appData.links.filter(l => l.cat === cat);
    if (!items.length) return;
    html += `<div class="checklist-group-title" style="margin:16px 0 8px">${icon} ${label}</div>`;
    items.forEach((l, i) => {
      const idx = appData.links.indexOf(l);
      html += `
      <a class="link-row" href="${l.url}" target="_blank">
        <div class="link-row-content"><div class="link-row-name">${l.name}</div></div>
        ${isAdmin ? `<div onclick="event.preventDefault();deleteLink(${idx})" style="color:var(--danger);font-size:18px;padding:0 4px">Ã—</div>` : `<span class="link-arrow">â†—</span>`}
      </a>`;
    });
  });
  return html;
}

function deleteLink(i) {
  if (!confirm(`Remove "${appData.links[i].name}"?`)) return;
  appData.links.splice(i, 1);
  saveData().then(() => renderTab('links'));
}

// â”€â”€ More â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMore() {
  // Checklist
  const cats = {
    hiking: {label: 'Hiking Gear', icon: 'ğŸ¥¾'},
    snowboard: {label: 'Snowboard Gear', icon: 'â›·ï¸'},
    admin: {label: 'Trip Admin', icon: 'ğŸš—'}
  };
  let checklistHtml = '';
  Object.entries(cats).forEach(([cat, {label, icon}]) => {
    const items = appData.checklist[cat] || [];
    checklistHtml += `<div class="checklist-group">
      <div class="checklist-group-title">${icon} ${label}</div>`;
    items.forEach((item, i) => {
      const key = `${cat}-${i}`;
      const done = !!checkedItems[key];
      checklistHtml += `
        <div class="checklist-item ${done ? 'done' : ''}" onclick="toggleCheck('${key}', this)">
          <div class="check-box"><span class="check-tick">âœ“</span></div>
          <span class="check-label">${item}</span>
        </div>`;
    });
    checklistHtml += `</div>`;
  });

  // Emergency
  let emergencyHtml = '';
  appData.emergency.forEach((e, i) => {
    const primary = e.number === '112';
    emergencyHtml += `
      <div class="emergency-card ${primary ? 'primary' : ''}">
        <div class="emergency-name">${e.name}</div>
        <a class="emergency-number" href="tel:${e.number.replace(/\s/g,'')}">${e.number}</a>
      </div>`;
  });

  let editSection = isAdmin ? `
    <div class="section-head" style="margin-top:24px"><span class="section-title">Trip Settings</span></div>
    <div class="edit-row" onclick="openSheet('edit-trip')">
      <div class="edit-row-label">âœï¸ Edit trip name & dates</div>
      <div class="edit-row-value">${appData.trip.name}</div>
    </div>
    <div class="edit-row" onclick="openSheet('show-id')">
      <div class="edit-row-label">ğŸ‘¤ My user ID</div>
      <div class="edit-row-value" style="font-family:monospace">${userId || 'Unknown'}</div>
    </div>
  ` : `
    <div style="padding:16px 0;text-align:center;color:var(--text3);font-size:13px">
      To edit trip info, ask the admin to add you via /addadmin
    </div>
  `;

  return `
    <div class="section-head"><span class="section-title">Packing Checklist</span></div>
    ${checklistHtml}
    <div class="section-head" style="margin-top:8px"><span class="section-title">Emergency Numbers</span></div>
    ${emergencyHtml}
    ${editSection}
  `;
}

function toggleCheck(key, el) {
  const done = !el.classList.contains('done');
  el.classList.toggle('done', done);
  checkedItems[key] = done;
  if (!done) delete checkedItems[key];
  localStorage.setItem('checked', JSON.stringify(checkedItems));
}

// â”€â”€ Bottom Sheet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openSheet(type) {
  const overlay = document.getElementById('sheet-overlay');
  const inner = document.getElementById('sheet-inner');
  inner.innerHTML = sheetContent(type);
  overlay.classList.add('open');
  // Trigger animation after paint
  requestAnimationFrame(() => {
    const sheet = document.getElementById('sheet');
    sheet.style.transform = 'translateY(0)';
  });
}

function closeSheet(e) {
  if (e && e.target !== document.getElementById('sheet-overlay')) return;
  _closeSheet();
}

function _closeSheet() {
  const overlay = document.getElementById('sheet-overlay');
  overlay.classList.remove('open');
}

function sheetContent(type) {
  switch(type) {
    case 'add-accom': {
      const editing = _editAccomIdx >= 0;
      const a = editing ? appData.accoms[_editAccomIdx] : null;
      return `
        <div class="sheet-title">${editing ? 'Edit Accommodation' : 'Add Accommodation'}</div>
        <div class="sheet-body">
          <div class="field"><label>Name</label><input id="f-name" value="${a?.name || ''}" placeholder="Airbnb Arenas, Hotel Rural..." autocomplete="off"></div>
          <div class="field"><label>Booking URL</label><input id="f-url" type="url" value="${a?.url || ''}" placeholder="https://airbnb.com/rooms/..."></div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div class="field">
              <label>Check-in</label>
              <input id="f-checkin" type="date" value="${a?.checkin || ''}">
              <input id="f-checkin-time" type="time" value="${a?.checkinTime || ''}" style="margin-top:6px">
            </div>
            <div class="field">
              <label>Check-out</label>
              <input id="f-checkout" type="date" value="${a?.checkout || ''}">
              <input id="f-checkout-time" type="time" value="${a?.checkoutTime || ''}" style="margin-top:6px">
            </div>
          </div>
          <div class="field"><label>Google Maps URL (optional)</label><input id="f-maps" type="url" value="${a?.mapsUrl || ''}" placeholder="https://maps.app.goo.gl/..."></div>
          <div class="field"><label>Notes (optional)</label><textarea id="f-notes" placeholder="Checkout 11am, Free parking, Contact...">${a?.notes || ''}</textarea></div>
          <button class="btn-primary" onclick="submitAccom()">${editing ? 'Save Changes' : 'Save Booking'}</button>
          ${editing ? `<button class="btn-secondary btn-danger" onclick="deleteAccom(${_editAccomIdx})">Ã— Remove Booking</button>` : ''}
          <button class="btn-secondary" onclick="_closeSheet()">Cancel</button>
        </div>`;
    }

    case 'add-weather': return `
      <div class="sheet-title">Add Forecast Link</div>
      <div class="sheet-sub">Add a weather source</div>
      <div class="sheet-body">
        <div class="field"><label>Name</label><input id="f-name" placeholder="Potes hourly, Covadonga..." autocomplete="off"></div>
        <div class="field"><label>URL</label><input id="f-url" type="url" placeholder="https://accuweather.com/..."></div>
        <div class="field"><label>Day (optional)</label><input id="f-day" placeholder="Fri-Sat, Sunday..." autocomplete="off"></div>
        <button class="btn-primary" onclick="submitWeather()">Save Link</button>
        <button class="btn-secondary" onclick="_closeSheet()">Cancel</button>
      </div>`;

    case 'add-link': return `
      <div class="sheet-title">Add Key Link</div>
      <div class="sheet-body">
        <div class="field"><label>Name</label><input id="f-name" placeholder="Park webcam, Avalanche bulletin..." autocomplete="off"></div>
        <div class="field"><label>URL</label><input id="f-url" type="url" placeholder="https://..."></div>
        <div class="field"><label>Category</label>
          <select id="f-cat">
            <option value="trail">ğŸ¥¾ Trail Status</option>
            <option value="booking">ğŸ« Booking</option>
            <option value="other">ğŸ“Œ Other</option>
          </select>
        </div>
        <button class="btn-primary" onclick="submitLink()">Save Link</button>
        <button class="btn-secondary" onclick="_closeSheet()">Cancel</button>
      </div>`;

    case 'stop-form': {
      const editing = _editStopIdx >= 0;
      const day  = appData.days[_editStopDayIdx];
      const stop = editing ? day?.stops[_editStopIdx] : null;
      const accomOpts = appData.accoms.map((a,i) => `<option value="${i}">${a.name}</option>`).join('');
      return `
        <div class="sheet-title">${editing ? 'Edit Stop' : 'Add Stop'}</div>
        <div class="sheet-sub">${day?.emoji || ''} ${day?.label || ''} Â· ${day?.title || ''}</div>
        <div class="sheet-body">
          ${appData.accoms.length && !editing ? `
          <div class="field">
            <label>From Accommodation (auto-fills below)</label>
            <select id="f-accomsel" onchange="prefillFromAccom()">
              <option value="">â€” or fill manually below â€”</option>
              ${accomOpts}
            </select>
          </div>` : ''}
          <div class="field"><label>Stop Name</label><input id="f-name" value="${stop?.name || ''}" placeholder="Hotel check-in, Dinner, Trailheadâ€¦" autocomplete="off"></div>
          <div class="field"><label>Time</label><input id="f-time" type="time" value="${stop?.time || ''}"></div>
          <div class="field"><label>Google Maps URL (optional)</label><input id="f-stopmaps" type="url" value="${stop?.mapsUrl || ''}" placeholder="https://maps.app.goo.gl/â€¦"></div>
          <div class="field"><label>Notes (optional)</label><textarea id="f-notes" placeholder="Reserve in advance, checkout 11amâ€¦">${stop?.note || ''}</textarea></div>
          <button class="btn-primary" onclick="submitStop()">${editing ? 'Save Changes' : 'Add Stop'}</button>
          ${editing ? `<button class="btn-secondary btn-danger" onclick="deleteStop(${_editStopDayIdx},${_editStopIdx})">Ã— Remove Stop</button>` : ''}
          <button class="btn-secondary" onclick="_closeSheet()">Cancel</button>
        </div>`;
    }

    case 'edit-trip': return `
      <div class="sheet-title">Edit Trip Info</div>
      <div class="sheet-body">
        <div class="field"><label>Trip Name</label><input id="f-name" value="${appData.trip.name}" autocomplete="off"></div>
        <div class="field"><label>Dates</label><input id="f-dates" value="${appData.trip.dates}" autocomplete="off"></div>
        <button class="btn-primary" onclick="submitEditTrip()">Save Changes</button>
        <button class="btn-secondary" onclick="_closeSheet()">Cancel</button>
      </div>`;

    case 'show-id': return `
      <div class="sheet-title">Your Telegram ID</div>
      <div class="sheet-sub">Share this with the trip admin to get edit access</div>
      <div class="sheet-body">
        <div style="background:var(--card);border:1px solid var(--border2);border-radius:12px;padding:20px;text-align:center;font-family:monospace;font-size:28px;color:var(--gold2);letter-spacing:2px;margin-bottom:16px">${userId || 'Not available'}</div>
        <button class="btn-secondary" onclick="_closeSheet()">Close</button>
      </div>`;

    case 'wx-loc-form': {
      const editing = _wxLocEditIdx >= 0;
      const loc = editing ? appData.wxLocations[_wxLocEditIdx] : null;
      const btnStyle = 'background:var(--gold-dim);border:1px solid #c8912a55;color:var(--gold2);border-radius:8px;padding:10px 14px;font-size:14px;font-weight:600;cursor:pointer;font-family:"DM Sans",sans-serif;flex-shrink:0';
      const cbStyle  = 'display:flex;align-items:center;gap:8px;color:var(--text);font-size:14px;text-transform:none;letter-spacing:0;cursor:pointer;margin-bottom:0';
      return `
        <div class="sheet-title">${editing ? 'Edit' : 'Add'} Weather Location</div>
        <div class="sheet-body">
          <div class="field"><label>Display Name</label><input id="f-wxname" value="${loc?.name || ''}" placeholder="Burgos, Picos de Europaâ€¦" autocomplete="off"></div>
          <div class="field">
            <label>Search Location</label>
            <div style="display:flex;gap:8px">
              <input id="f-wxplace" placeholder="${loc?.name || 'Type a place nameâ€¦'}" autocomplete="off" style="flex:1" onkeydown="if(event.key==='Enter'){event.preventDefault();searchWxPlace()}">
              <button type="button" onclick="searchWxPlace()" style="${btnStyle}">ğŸ” Search</button>
            </div>
            <div id="wx-geo-result" style="font-size:12px;margin-top:6px;color:var(--text3)">${loc ? `Current: ${loc.lat.toFixed(4)}, ${loc.lon.toFixed(4)} â€” search to change` : 'Search to set coordinates'}</div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div class="field"><label>From</label><input id="f-wxfrom" type="date" value="${loc?.dateFrom || ''}"></div>
            <div class="field"><label>To (optional)</label><input id="f-wxto" type="date" value="${loc?.dateTo || ''}"></div>
          </div>
          <div class="field">
            <label>Show extra info</label>
            <div style="display:flex;gap:24px;margin-top:8px">
              <div class="custom-check ${loc?.wind ? 'checked' : ''}" id="f-wxwind" onclick="this.classList.toggle('checked')">
                <div class="check-box"><span class="check-tick">âœ“</span></div>
                <span style="font-size:14px;color:var(--text)">Wind speed</span>
              </div>
              <div class="custom-check ${loc?.snow ? 'checked' : ''}" id="f-wxsnow" onclick="this.classList.toggle('checked')">
                <div class="check-box"><span class="check-tick">âœ“</span></div>
                <span style="font-size:14px;color:var(--text)">Snowfall</span>
              </div>
            </div>
          </div>
          <div class="field"><label>Forecast link URL (optional)</label><input id="f-wxforecasturl" type="url" value="${loc?.forecastUrl || ''}" placeholder="https://accuweather.com/â€¦"></div>
          <div class="field"><label>Forecast link name</label><input id="f-wxforecastname" value="${loc?.forecastName || ''}" placeholder="AccuWeather Burgosâ€¦" autocomplete="off"></div>
          <button class="btn-primary" onclick="submitWxLoc()">${editing ? 'Save Changes' : 'Add Location'}</button>
          ${editing ? `<button class="btn-secondary btn-danger" onclick="deleteWxLoc(${_wxLocEditIdx})">Ã— Delete Location</button>` : ''}
          <button class="btn-secondary" onclick="_closeSheet()">Cancel</button>
        </div>`;
    }

    case 'day-form': {
      const editing = _editDayIdx >= 0;
      const d = editing ? appData.days[_editDayIdx] : null;
      return `
        <div class="sheet-title">${editing ? 'Edit Day' : 'Add Day'}</div>
        <div class="sheet-body">
          <div style="display:grid;grid-template-columns:72px 1fr;gap:10px;align-items:start">
            <div class="field"><label>Emoji</label><input id="f-dayemoji" value="${d?.emoji || 'ğŸ“'}" placeholder="ğŸš—" autocomplete="off" style="font-size:24px;text-align:center;padding:8px 4px"></div>
            <div class="field"><label>Title</label><input id="f-daytitle" value="${d?.title || ''}" placeholder="Madrid to Burgosâ€¦" autocomplete="off"></div>
          </div>
          <div class="field"><label>Date</label><input id="f-daydate" type="date" value="${d?.date || ''}"></div>
          <div class="field"><label>Description (optional)</label><textarea id="f-daydesc" placeholder="Drive up north, check in at 15:00â€¦">${d?.description || ''}</textarea></div>
          <button class="btn-primary" onclick="submitDay()">${editing ? 'Save Changes' : 'Add Day'}</button>
          ${editing ? `<button class="btn-secondary btn-danger" onclick="deleteDay(${_editDayIdx})">Ã— Delete Day &amp; All Stops</button>` : ''}
          <button class="btn-secondary" onclick="_closeSheet()">Cancel</button>
        </div>`;
    }

    case 'maps-view': {
      let destHtml = '';
      appData.days.forEach(day => {
        if (!day.stops.length) return;
        destHtml += `<div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--gold2);letter-spacing:1px;text-transform:uppercase;margin:16px 0 6px;padding-bottom:6px;border-bottom:1px solid var(--border)">${day.emoji} ${day.label} Â· ${day.title}</div>`;
        day.stops.forEach(stop => {
          const link = stop.mapsUrl || `https://www.google.com/maps/search/${encodeURIComponent(stop.name)}`;
          destHtml += `<a href="${link}" target="_blank" style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);text-decoration:none;color:var(--text)">
            <span style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--gold);min-width:40px;flex-shrink:0">${stop.time || 'â€”'}</span>
            <div style="flex:1;min-width:0">
              <div style="font-size:14px;font-weight:500">${stop.name}</div>
              ${stop.note ? `<div style="font-size:12px;color:var(--text3);margin-top:2px">${stop.note}</div>` : ''}
            </div>
            <span style="color:var(--gold2);font-size:16px;flex-shrink:0">ğŸ“</span>
          </a>`;
        });
      });
      if (!destHtml) destHtml = `<div class="empty"><div class="empty-icon">ğŸ—“</div><div class="empty-text">No stops yet.</div></div>`;
      return `
        <div class="sheet-title">ğŸ“ Destinations</div>
        <div class="sheet-sub">Tap any stop to open in Google Maps</div>
        <div class="sheet-body">${destHtml}<button class="btn-secondary" style="margin-top:16px" onclick="_closeSheet()">Close</button></div>`;
    }

    default: return '';
  }
}

// â”€â”€ Submit handlers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function formatDate(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr + 'T00:00:00');
  return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
}

function submitAccom() {
  const name = document.getElementById('f-name')?.value.trim();
  let url    = document.getElementById('f-url')?.value.trim();
  if (!name || !url) { alert('Name and URL are required'); return; }
  if (!url.match(/^https?:\/\//i)) url = 'https://' + url;
  const checkin      = document.getElementById('f-checkin')?.value      || '';
  const checkout     = document.getElementById('f-checkout')?.value     || '';
  const checkinTime  = document.getElementById('f-checkin-time')?.value  || '';
  const checkoutTime = document.getElementById('f-checkout-time')?.value || '';
  let day = '';
  if (checkin) {
    day = formatDate(checkin);
    if (checkinTime) day += ' ' + checkinTime;
  }
  if (checkout) {
    day += (day ? ' â€“ ' : '') + formatDate(checkout);
    if (checkoutTime) day += ' ' + checkoutTime;
  }
  let mapsUrl = document.getElementById('f-maps')?.value.trim() || '';
  if (mapsUrl && !mapsUrl.match(/^https?:\/\//i)) mapsUrl = 'https://' + mapsUrl;
  const accom = { name, url, day, mapsUrl, notes: document.getElementById('f-notes')?.value.trim() || '', checkin, checkout, checkinTime, checkoutTime };
  if (_editAccomIdx >= 0) { appData.accoms[_editAccomIdx] = accom; }
  else { appData.accoms.push(accom); }
  saveData().then(() => { _closeSheet(); renderTab('accoms'); });
}

function submitWeather() {
  const name = document.getElementById('f-name')?.value.trim();
  const url  = document.getElementById('f-url')?.value.trim();
  if (!name || !url) { alert('Name and URL are required'); return; }
  appData.weather.push({ name, url, day: document.getElementById('f-day')?.value.trim() || '' });
  saveData().then(() => { _closeSheet(); renderTab('weather'); });
}

function submitLink() {
  const name = document.getElementById('f-name')?.value.trim();
  const url  = document.getElementById('f-url')?.value.trim();
  if (!name || !url) { alert('Name and URL are required'); return; }
  appData.links.push({ name, url, cat: document.getElementById('f-cat')?.value || 'other' });
  saveData().then(() => { _closeSheet(); renderTab('links'); });
}

function prefillFromAccom() {
  const sel = document.getElementById('f-accomsel');
  if (!sel || sel.value === '') return;
  const accom = appData.accoms[parseInt(sel.value)];
  if (!accom) return;
  const nameEl = document.getElementById('f-name');
  if (nameEl && !nameEl.value) nameEl.value = accom.name;
  const mapsEl = document.getElementById('f-stopmaps');
  if (mapsEl && !mapsEl.value && accom.mapsUrl) mapsEl.value = accom.mapsUrl;
  const notesEl = document.getElementById('f-notes');
  if (notesEl && !notesEl.value && accom.notes) notesEl.value = accom.notes;
}

function submitStop() {
  const time = document.getElementById('f-time')?.value || '';
  const name = document.getElementById('f-name')?.value.trim();
  if (!name) { alert('Stop name is required'); return; }
  let mapsUrl = document.getElementById('f-stopmaps')?.value.trim() || '';
  if (mapsUrl && !mapsUrl.match(/^https?:\/\//i)) mapsUrl = 'https://' + mapsUrl;
  const day = appData.days[_editStopDayIdx];
  if (!day) return;
  const stop = { time, name, note: document.getElementById('f-notes')?.value.trim() || '', mapsUrl };
  if (_editStopIdx >= 0) { day.stops[_editStopIdx] = stop; }
  else { day.stops.push(stop); }
  if (time) day.stops.sort((a, b) => (a.time||'').localeCompare(b.time||''));
  saveData().then(() => { _closeSheet(); renderTab('itinerary'); });
}

function submitEditTrip() {
  const name  = document.getElementById('f-name')?.value.trim();
  const dates = document.getElementById('f-dates')?.value.trim();
  if (!name || !dates) { alert('Name and dates are required'); return; }
  appData.trip.name  = name;
  appData.trip.dates = dates;
  saveData().then(() => {
    document.getElementById('trip-name').textContent = name;
    document.getElementById('trip-dates').textContent = dates;
    _closeSheet();
    renderTab('more');
  });
}

// â”€â”€ Start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();
</script>
</body>
</html>
